<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng c·ª• D·ªãch H√°n Vi·ªát</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chosen Palette: Scholarly Calm -->
    <!-- Application Structure Plan: Refactored the Reading Mode to use a fixed taskbar/footer for navigation and tools (Chapter List, Viet-Viet Edit, Re-translate). This solves the visibility issue for long chapters. Fixed the navigation buttons by ensuring they correctly trigger chapter slicing and AI translation in reading mode, and added a status notification mechanism. Now includes AI translation for chapter titles. -->
    <!-- Visualization & Content Choices: The fixed footer and modal implementations prioritize user interaction, allowing seamless transition between reading and refining the translation without losing the context of the page. The status bar provides necessary feedback during asynchronous translation processes. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fdfaf6;
            color: #4a4a4a;
        }
        .highlight {
            background-color: #ffe680;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 600;
            color: #333;
            line-height: 1.8;
            white-space: pre-wrap;
            display: inline-block;
        }
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        .card:hover {
             box-shadow: 0 8px 24px rgba(0,0,0,0.08);
        }
        .btn {
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .btn-primary {
            background-color: #4a7c59;
            color: white;
        }
        .btn-primary:hover {
            background-color: #3e684b;
        }
        .btn-secondary {
            background-color: #e0e0e0;
            color: #555;
        }
        .btn-secondary:hover {
            background-color: #d1d1d1;
        }
        .btn-ai {
            background-color: #8c52ff;
            color: white;
        }
        .btn-ai:hover {
            background-color: #7a46e1;
        }
        .btn-danger {
            background-color: #d9534f;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c9302c;
        }
        input[type="text"], textarea {
            border: 1px solid #e0e0e0;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        input[type="text"]:focus, textarea:focus {
            border-color: #4a7c59;
            box-shadow: 0 0 0 2px rgba(74, 124, 89, 0.2);
            outline: none;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .chapter-active {
            background-color: #e6e9f2;
            border-left: 4px solid #8c52ff;
        }
        .btn-promote {
            background-color: #10b981;
            color: white;
        }
        .btn-promote:hover {
            background-color: #059669;
        }
        .post-sub-item {
            background-color: #f0f9ff;
        }
        .progress-bar {
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        .progress-indicator {
            height: 100%;
            background-color: #4a7c59;
            transition: width 0.3s ease;
        }
        /* Custom styles for Reading Mode */
        .reading-output {
            padding: 3rem 4rem; /* Add padding for better reading experience */
            line-height: 1.8;
            font-size: 1.15rem;
            text-align: justify;
        }
        .reading-container {
            max-width: 1000px; /* Constrain content width for comfortable reading */
            margin: 0 auto;
        }
        .reading-output p {
            margin-bottom: 1.5rem;
        }
        .reading-header {
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 1.5rem;
            margin-bottom: 2rem;
        }
        /* IMPORTANT: Add padding-bottom to the main reading area to prevent the fixed footer from obscuring content */
        #reading-interface {
            padding-bottom: 7rem; 
        }

        .modal {
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50;
        }
    </style>
     <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="p-4 sm:p-6 md:p-8 min-h-screen flex flex-col">
    <div class="max-w-7xl mx-auto w-full flex-grow flex flex-col gap-8" id="editing-interface">
        <header class="text-center">
            <h1 class="text-4xl font-bold text-[#3e684b]">Kh√¥ng gian D·ªãch thu·∫≠t H√°n Vi·ªát</h1>
            <p class="mt-2 text-lg text-gray-600">C·∫•u h√¨nh linh ho·∫°t, AI h·ªó tr·ª£ v√† t·ª´ ƒëi·ªÉn c√° nh√¢n h√≥a.</p>
        </header>

        <!-- TOP ROW: CONFIGURATION (Book Upload & Settings) -->
        <div id="config-row" class="grid grid-cols-1 md:grid-cols-2 gap-8 flex-shrink-0">
            
            <!-- Book Upload & Chapter Analysis -->
            <div class="card p-6">
                <button id="book-toggle" class="w-full text-left font-bold text-xl text-red-500 flex justify-between items-center py-2">
                    <span>üìö T·∫£i l√™n S√°ch & Ph√¢n t√≠ch Ch∆∞∆°ng</span>
                    <span id="book-toggle-icon">‚ñº</span>
                </button>
                <div id="book-analysis-content" class="mt-4 space-y-4 hidden">
                    <p class="text-sm text-gray-600 font-semibold">T·∫£i l√™n t·ªáp (.txt) ch·ª©a to√†n b·ªô n·ªôi dung truy·ªán ti·∫øng Trung.</p>
                    
                    <div class="flex space-x-2 items-center">
                        <input type="file" id="book-file-input" accept=".txt" class="hidden">
                        <label for="book-file-input" id="book-file-label" class="cursor-pointer btn btn-secondary py-2 px-4 rounded-md text-sm whitespace-nowrap">Ch·ªçn T·ªáp S√°ch...</label>
                        <button id="extract-chapters-btn" class="btn btn-ai w-full font-bold py-2 px-4 rounded-md text-sm flex items-center justify-center relative" disabled>
                            <span id="extract-loading-spinner" class="spinner mr-2 w-4 h-4 border-white hidden"></span>
                            ‚ú® AI Ph√¢n t√≠ch & Tr√≠ch xu·∫•t Ch∆∞∆°ng
                        </button>
                    </div>
                    <div id="book-status" class="text-sm mt-2"></div>

                    <div id="chapter-navigator" class="mt-4 border border-gray-200 rounded-md p-3 max-h-48 overflow-y-auto hidden">
                        <h4 class="font-semibold mb-2">B·ªô ƒëi·ªÅu h∆∞·ªõng Ch∆∞∆°ng (T·∫£i t·ª± ƒë·ªông)</h4>
                        <ul id="chapters-ul" class="space-y-1">
                            <li class="text-gray-500 text-sm">Ch∆∞a c√≥ ch∆∞∆°ng n√†o ƒë∆∞·ª£c tr√≠ch xu·∫•t.</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Settings Card -->
            <div class="card p-6">
                <button id="settings-toggle" class="w-full text-left font-bold text-xl text-[#8c52ff] flex justify-between items-center py-2">
                    <!-- The text of this span will be changed by JS to give a hint -->
                    <span>‚öôÔ∏è C√†i ƒë·∫∑t N√¢ng cao (API & Prompt)</span>
                    <span id="toggle-icon">‚ñº</span>
                </button>
                <div id="advanced-settings" class="mt-4 space-y-4 hidden">
                    <!-- This button is hidden by default and only shown by JS -->
                    <button id="back-to-reading-from-settings-btn" class="btn btn-primary w-full py-2 px-4 rounded-md text-sm font-bold flex items-center justify-center hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                        Quay l·∫°i Ch·∫ø ƒë·ªô ƒê·ªçc
                    </button>
                    <div id="reading-btn-separator" class="h-px bg-gray-200 my-4 hidden"></div>
                    <!-- End New Button -->

                     <!-- Removed Chunk Size Setting -->
                    <div class="space-y-2">
                        <h3 class="font-semibold text-base text-gray-700">T·ªëi ∆∞u T·ªëc ƒë·ªô D·ªãch AI</h3>
                        <p class="text-xs text-gray-500">Hi·ªán t·∫°i, h·ªá th·ªëng s·∫Ω d·ªãch to√†n b·ªô ch∆∞∆°ng trong m·ªôt l·∫ßn ƒë·ªÉ ƒë·∫£m b·∫£o ch·∫•t l∆∞·ª£ng ng·ªØ c·∫£nh t·ªët nh·∫•t.</p>
                    </div>
                    <div class="h-px bg-gray-200 my-4"></div>
                    
                    <!-- API Key Management Section -->
                    <div class="space-y-2">
                        <h3 class="font-semibold text-base text-gray-700 flex justify-between items-center">
                            Qu·∫£n l√Ω API Keys
                            <span id="key-count" class="text-sm bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full">0 Kh√≥a</span>
                        </h3>
                        <div class="flex space-x-2">
                            <input type="text" id="new-api-key-input" placeholder="Nh·∫≠p kh√≥a API m·ªõi..." class="flex-1 p-2 rounded-md text-sm">
                            <button id="add-api-key-btn" class="btn btn-primary py-2 px-4 rounded-md text-sm">Th√™m Kh√≥a</button>
                        </div>
                        <div id="api-key-list" class="space-y-2 max-h-32 overflow-y-auto pr-1 border border-gray-100 p-2 rounded-md">
                            <!-- Key list will be rendered here -->
                            <p class="text-xs text-gray-400">Kh√≥a s·∫Ω ƒë∆∞·ª£c l∆∞u trong tr√¨nh duy·ªát.</p>
                        </div>
                        <p class="text-xs text-gray-500">·ª®ng d·ª•ng s·∫Ω t·ª± ƒë·ªông xoay v√≤ng c√°c kh√≥a khi c√≥ l·ªói.</p>
                    </div>
                    <!-- End API Key Management Section -->

                    <div class="h-px bg-gray-200 my-4"></div>

                    <div class="space-y-2">
                        <label for="custom-prompt" class="block text-sm font-medium text-gray-700">Custom Prompt (Cho AI D·ªãch Ho√†n Ch·ªânh)</label>
                        <textarea id="custom-prompt" rows="3" class="w-full p-2 rounded-md" placeholder="V√≠ d·ª•: D·ªãch m∆∞·ª£t m√† theo phong c√°ch truy·ªán c·ªï trang..."></textarea>
                        <p class="text-xs text-gray-500">Thay ƒë·ªïi vai tr√≤ v√† phong c√°ch d·ªãch c·ªßa AI.</p>
                    </div>

                    <div class="h-px bg-gray-200 my-4"></div>
                    
                    <h3 class="text-lg font-semibold mb-3">T·∫£i l√™n T·ª´ ƒëi·ªÉn (H√†ng lo·∫°t)</h3>
                    <p class="text-sm text-gray-600 mb-2">ƒê·ªãnh d·∫°ng t·ªáp: TXT ho·∫∑c CSV. M·ªói d√≤ng l√† m·ªôt c·∫∑p **H√°n t·ª±,Nghƒ©a Vi·ªát**.</p>
                    <div class="flex space-x-2 items-center">
                        <input type="file" id="dictionary-file-input" accept=".txt, .csv" class="hidden">
                        <label for="dictionary-file-input" class="cursor-pointer btn btn-secondary py-2 px-4 rounded-md text-sm">Ch·ªçn T·ªáp...</label>
                        <button id="upload-dictionary-btn" class="btn btn-primary py-2 px-4 rounded-md text-sm" disabled>T·∫£i & Th√™m</button>
                    </div>
                    <div id="upload-status" class="text-sm mt-2"></div>
                </div>
            </div>
        </div>

        <!-- MIDDLE ROW: WORKING AREA (Substitutions, Dictionary, and Input) -->
        <div id="working-row" class="grid grid-cols-1 lg:grid-cols-2 gap-8 flex-shrink-0">
            
            <!-- LEFT COLUMN: SUBSTITUTION & PERMANENT DICTIONARY -->
            <div id="left-column" class="flex flex-col space-y-8">
                
                <!-- Runtime Substitution & Post-Substitution Card -->
                <div class="card p-6 flex-shrink-0">
                    <h2 class="text-2xl font-bold mb-4 text-[#4a7c59]">üîß Tinh ch·ªânh T·ª´ v·ª±ng & H·∫≠u k·ª≥</h2>
                    
                    <!-- H√°n -> Vi·ªát Substitution Override -->
                    <h3 class="font-bold text-lg text-gray-700 mb-3 border-b pb-2">1. H√°n -> Vi·ªát (∆Øu ti√™n, T·∫°m th·ªùi)</h3>
                    <p class="text-sm text-gray-600 mb-3">Th√™m nhi·ªÅu c·∫∑p r·ªìi nh·∫•n "√Åp d·ª•ng & D·ªãch l·∫°i" 1 l·∫ßn.</p>
                    <div class="space-y-4 mb-4">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label for="han-replace" class="block text-sm font-medium text-gray-700 mb-1">H√°n t·ª± (C·∫ßn thay th·∫ø)</label>
                                <input type="text" id="han-replace" placeholder="Êàë" class="w-full p-2 rounded-md text-sm">
                            </div>
                            <div>
                                <label for="viet-new-value" class="block text-sm font-medium text-gray-700 mb-1">Nghƒ©a Vi·ªát (M·ªöI)</label>
                                <input type="text" id="viet-new-value" placeholder="ta / t√¥i" class="w-full p-2 rounded-md text-sm">
                            </div>
                        </div>
                        <button id="add-runtime-substitution-btn" class="btn btn-secondary w-full font-bold py-2 px-4 rounded-md text-sm">
                            + Th√™m v√†o danh s√°ch t·∫°m
                        </button>
                    </div>
                    
                    <div id="runtime-substitution-list" class="space-y-2 max-h-36 overflow-y-auto pr-2 mb-6 border border-yellow-200 p-2 rounded-md bg-yellow-50">
                         <p class="text-gray-500 text-sm">Ch∆∞a c√≥ c·∫∑p H√°n -> Vi·ªát t·∫°m th·ªùi.</p>
                    </div>

                    <!-- NEW: Vi·ªát -> Vi·ªát Post-Substitution -->
                    <h3 class="font-bold text-lg text-gray-700 mb-3 border-b pb-2">2. Vi·ªát -> Vi·ªát (H·∫≠u k·ª≥, Vƒ©nh vi·ªÖn)</h3>
                     <p class="text-sm text-gray-600 mb-3">M·ªçi thay ƒë·ªïi ƒë·ªÅu ƒë∆∞·ª£c **l∆∞u vƒ©nh vi·ªÖn** v√† d√πng cho c√°c ch∆∞∆°ng/s√°ch kh√°c. Th√™m nhi·ªÅu c·∫∑p r·ªìi nh·∫•n "√Åp d·ª•ng & D·ªãch l·∫°i" 1 l·∫ßn.</p>
                    <div class="space-y-4 mb-4">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label for="viet-old-post" class="block text-sm font-medium text-gray-700 mb-1">C·ª•m t·ª´ Vi·ªát C≈® (ƒê√£ d·ªãch)</label>
                                <input type="text" id="viet-old-post" placeholder="√°o b√†o r·ªìng" class="w-full p-2 rounded-md text-sm">
                            </div>
                            <div>
                                <label for="viet-new-post" class="block text-sm font-medium text-gray-700 mb-1">C·ª•m t·ª´ Vi·ªát M·ªöI (Tinh ch·ªânh)</label>
                                <input type="text" id="viet-new-post" placeholder="√°o long b√†o" class="w-full p-2 rounded-md text-sm">
                            </div>
                        </div>
                        <button id="add-post-substitution-btn" class="btn btn-secondary w-full font-bold py-2 px-4 rounded-md text-sm">
                            + Th√™m v√†o danh s√°ch vƒ©nh vi·ªÖn
                        </button>
                    </div>
                    
                    <div id="post-substitution-list" class="space-y-2 max-h-36 overflow-y-auto pr-2 border border-blue-200 p-2 rounded-md post-sub-item mb-4">
                        <p class="text-gray-500 text-sm">Ch∆∞a c√≥ c·∫∑p Vi·ªát -> Vi·ªát vƒ©nh vi·ªÖn.</p>
                    </div>
                     <button id="apply-all-substitution-btn" class="btn btn-ai w-full font-bold py-2 px-4 rounded-md text-lg">
                        √Åp d·ª•ng & D·ªãch l·∫°i (Batch)
                    </button>
                </div>

                <div class="card p-6 flex-grow">
                    <h2 class="text-2xl font-bold mb-4 text-[#3e684b]">T·ª´ ƒëi·ªÉn c·ªßa b·∫°n (Vƒ©nh Vi·ªÖn)</h2>
                    <div class="space-y-4 mb-6">
                        <div>
                            <label for="han-input" class="block text-sm font-medium text-gray-700 mb-1">T·ª´ H√°n</label>
                            <input type="text" id="han-input" placeholder="‰Ω†Â•Ω" class="w-full p-2 rounded-md">
                        </div>
                        <div>
                            <label for="viet-input" class="block text-sm font-medium text-gray-700 mb-1">Nghƒ©a Vi·ªát</label>
                            <input type="text" id="viet-input" placeholder="N«ê h«éo / Xin ch√†o" class="w-full p-2 rounded-md">
                        </div>
                        <div class="flex space-x-2">
                            <button id="add-word-btn" class="flex-1 btn btn-primary font-bold py-2 px-4 rounded-md">Th√™m v√†o t·ª´ ƒëi·ªÉn</button>
                            <button id="ai-explain-btn" class="btn btn-ai font-bold py-2 px-4 rounded-md text-sm whitespace-nowrap flex items-center justify-center">
                                ‚ú® Ph√¢n T√≠ch
                            </button>
                        </div>
                        <div id="han-explain-output" class="text-sm bg-indigo-50 p-3 rounded-md hidden"></div>
                    </div>
                    
                    <div class="h-px bg-gray-200 my-6"></div>

                    <h3 class="text-lg font-semibold mb-3">C√°c t·ª´ ƒë√£ l∆∞u (Vƒ©nh Vi·ªÖn)</h3>
                    <div id="dictionary-list" class="space-y-2 max-h-72 overflow-y-auto pr-2">
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: INPUT AREA -->
            <div id="right-column" class="card p-6 flex flex-col space-y-4">
                 <h2 class="text-2xl font-bold text-[#3e684b] flex-shrink-0">C√¥ng c·ª• D·ªãch</h2>
                <div class="flex-grow flex flex-col space-y-4">
                    <label for="chinese-input" id="chinese-input-label" class="block text-lg font-medium text-gray-700 mb-2 flex-shrink-0">VƒÉn b·∫£n ti·∫øng Trung (Vui l√≤ng ch·ªçn s√°ch ƒë·ªÉ b·∫Øt ƒë·∫ßu):</label>
                    <textarea id="chinese-input" rows="18" class="w-full p-3 rounded-md text-base flex-grow" placeholder="N·ªôi dung ch∆∞∆°ng s·∫Ω ƒë∆∞·ª£c t·∫£i t·ª± ƒë·ªông v√†o ƒë√¢y..."></textarea>
                </div>
                 <!-- H√°n Vi·ªát / Clear Buttons -->
                <div class="flex items-center space-x-4 mb-6 flex-shrink-0">
                    <button id="translate-btn" class="flex-1 btn btn-primary font-bold py-3 px-4 rounded-md text-lg flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m4 13l4-4M19 17v-2m-4-2l-4 4m-5-4v2m4-2l-4 4M3 11h12M9 9v2m4 7h.01M12 3h.01M3 21h18M3 17h.01M9 21v-2m4 2v-2m4-2v2m-4-2h.01M15 9h.01M12 9h.01M9 5h.01M12 5h.01M15 5h.01M3 5h.01M3 9h.01" /></svg>
                        D·ªãch sang H√°n Vi·ªát
                    </button>
                    <button id="clear-btn" class="btn btn-secondary font-bold py-3 px-4 rounded-md flex-shrink-0">X√≥a</button>
                </div>
            </div>
        </div>
        
        <!-- BOTTOM ROW: FULL-WIDTH OUTPUT & AI CONTROLS (MAXIMIZED READING SPACE) -->
        <div id="output-row" class="card p-6 flex flex-col flex-grow">
            
            <label for="vietnamese-output" class="block text-lg font-medium text-gray-700 mb-2 flex-shrink-0">K·∫øt qu·∫£ H√°n Vi·ªát (v√† AI):</label>
            
            <!-- Output Area (Flex-grow to fill remaining vertical space) -->
            <div id="vietnamese-output" class="w-full p-3 rounded-md bg-gray-50 overflow-y-auto border border-gray-200 text-gray-800 flex-grow min-h-[50vh]">
                <p class="text-gray-400">K·∫øt qu·∫£ d·ªãch s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y...</p>
            </div>

            <!-- AI Features and Navigation (PUSHED TO BOTTOM) -->
            <div id="ai-feature-area" class="mt-6 pt-4 border-t border-gray-100 flex flex-col space-y-4 flex-shrink-0">
                <button id="ai-translate-btn" class="w-full btn btn-ai font-bold py-3 px-4 rounded-md text-lg flex items-center justify-center relative">
                    <span id="ai-loading-spinner" class="spinner mr-2 hidden"></span>
                    ‚ú® AI D·ªãch Ho√†n Ch·ªânh & Tr√¥i Ch·∫£y
                </button>
                <button id="next-chapter-btn" class="w-full btn btn-secondary font-bold py-3 px-4 rounded-md text-lg flex items-center justify-center relative hidden" disabled>
                    Ti·∫øp t·ª•c: D·ªãch Ch∆∞∆°ng <span id="next-chapter-title" class="ml-2 font-extrabold text-[#4a7c59]">...</span>
                </button>
            </div>
        </div>

    </div>

    <!-- NEW: READING MODE INTERFACE (Hidden by default) -->
    <div id="reading-interface" class="hidden p-4 sm:p-6 md:p-10 min-h-screen flex flex-col transition-opacity duration-300">
        <header class="reading-container reading-header flex justify-between items-center flex-shrink-0">
            <button id="back-to-editor-btn" class="btn btn-secondary py-2 px-4 rounded-full text-sm font-bold flex items-center">
                &larr; Tr·ªü l·∫°i Bi√™n t·∫≠p
            </button>
            <h1 id="reading-chapter-title" class="text-2xl font-extrabold text-[#3e684b] text-center flex-grow">
                [T√™n Ch∆∞∆°ng]
            </h1>
            <!-- Navigation removed from header and moved to fixed footer -->
        </header>

        <main id="reading-content-area" class="flex-grow overflow-y-auto reading-container reading-output">
            <!-- Translated content will be injected here -->
        </main>
    </div>

    <!-- FIXED FOOTER (Taskbar) for Reading Mode -->
    <footer id="reading-footer" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-2xl p-4 hidden z-40">
        <div class="reading-container flex items-center justify-between space-x-4">
            
            <!-- Chapter Navigation -->
            <div class="flex space-x-2">
                <button id="prev-chapter-reading-btn" class="btn btn-secondary py-2 px-3 rounded-full flex items-center" title="Ch∆∞∆°ng tr∆∞·ªõc">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12h8" /></svg>
                </button>
                <button id="next-chapter-reading-btn" class="btn btn-secondary py-2 px-3 rounded-full flex items-center" title="Ch∆∞∆°ng k·∫ø ti·∫øp">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 9l3 3m0 0l-3 3m3-3H6M21 12h-8" /></svg>
                </button>
            </div>

            <!-- Main Status and Tools -->
            <div class="flex items-center space-x-4 flex-grow justify-center">
                
                <!-- Status Bar -->
                <div id="reading-status" class="text-sm text-gray-500 font-semibold italic flex-grow text-center min-w-[200px]">
                    S·∫µn s√†ng ƒë·ªçc.
                </div>

                <!-- Tools -->
                <button id="open-contents-btn" class="btn btn-primary py-2 px-4 rounded-md text-sm font-bold">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" /></svg>
                    M·ª•c l·ª•c
                </button>
                <button id="open-post-sub-btn" class="btn btn-secondary py-2 px-4 rounded-md text-sm font-bold">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
                    Tinh ch·ªânh (V->V)
                </button>
                <button id="retranslate-btn" class="btn btn-ai py-2 px-4 rounded-md text-sm font-bold flex items-center justify-center relative">
                     <span id="retranslate-spinner" class="spinner mr-2 w-4 h-4 border-white hidden"></span>
                    D·ªãch l·∫°i (AI)
                </button>
                <button id="download-chapter-btn" class="btn btn-secondary py-2 px-4 rounded-md text-sm font-bold flex items-center justify-center" title="T·∫£i xu·ªëng ch∆∞∆°ng n√†y">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    T·∫£i xu·ªëng
                </button>
                <!-- NEW Download All Button -->
                <button id="download-all-btn" class="btn btn-primary py-2 px-4 rounded-md text-sm font-bold flex items-center justify-center" title="T·∫£i xu·ªëng to√†n b·ªô c√°c ch∆∞∆°ng ƒë√£ d·ªãch" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 inline" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm3.293 2.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" />
                    </svg>
                    T·∫£i To√†n B·ªô Truy·ªán
                </button>
            </div>

        </div>
    </footer>


    <!-- Modal for Chapter Contents -->
    <div id="contents-modal" class="modal fixed inset-0 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 max-h-[80vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4 flex justify-between items-center">
                M·ª•c l·ª•c Ch∆∞∆°ng
                <button class="text-gray-500 hover:text-gray-800" id="close-contents-modal">&times;</button>
            </h3>
            <ul id="modal-chapters-list" class="space-y-1">
                <!-- Chapter list will be dynamically rendered here -->
            </ul>
        </div>
    </div>
    
    <!-- Modal for Post-Substitutions (Viet -> Viet) -->
    <div id="post-sub-modal" class="modal fixed inset-0 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 max-h-[80vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4 flex justify-between items-center text-[#4a7c59]">
                Tinh ch·ªânh Thu·∫≠t ng·ªØ (Viet -> Viet)
                <button class="text-gray-500 hover:text-gray-800" id="close-post-sub-modal">&times;</button>
            </h3>
            <p class="text-sm text-gray-600 mb-4">Th√™m c√°c c·∫∑p Vi·ªát C≈© -> Vi·ªát M·ªõi ƒë·ªÉ th·ªëng nh·∫•t thu·∫≠t ng·ªØ. M·ªçi thay ƒë·ªïi s·∫Ω ƒë∆∞·ª£c **l∆∞u vƒ©nh vi·ªÖn**.</p>
            <div id="modal-post-sub-controls" class="space-y-4 mb-4">
                 <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label for="modal-viet-old-post" class="block text-sm font-medium text-gray-700 mb-1">C·ª•m t·ª´ Vi·ªát C≈®</label>
                        <input type="text" id="modal-viet-old-post" placeholder="√°o b√†o r·ªìng" class="w-full p-2 rounded-md text-sm">
                    </div>
                    <div>
                        <label for="modal-viet-new-post" class="block text-sm font-medium text-gray-700 mb-1">C·ª•m t·ª´ Vi·ªát M·ªöI</label>
                        <input type="text" id="modal-viet-new-post" placeholder="√°o long b√†o" class="w-full p-2 rounded-md text-sm">
                    </div>
                </div>
                <button id="add-modal-post-sub-btn" class="btn btn-primary w-full font-bold py-2 px-4 rounded-md text-sm">
                    + Th√™m c·∫∑p Vi·ªát -> Vi·ªát
                </button>
            </div>
            
            <h4 class="font-semibold mt-6 mb-2">Danh s√°ch c√°c c·∫∑p ƒë√£ l∆∞u:</h4>
            <div id="modal-post-sub-list" class="space-y-2 border border-blue-200 p-2 rounded-md post-sub-item">
                <!-- Post substitution list will be rendered here -->
            </div>
            
        </div>
    </div>

    <!-- NEW MODAL FOR BATCH DOWNLOAD -->
    <div id="download-modal" class="modal fixed inset-0 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
            <h3 class="text-2xl font-bold mb-4 text-[#4a7c59]">T·∫£i xu·ªëng To√†n b·ªô Truy·ªán</h3>
            <p id="download-status-text" class="text-sm text-gray-600 mb-4">C√¥ng c·ª• s·∫Ω t·ª± ƒë·ªông d·ªãch c√°c ch∆∞∆°ng ch∆∞a c√≥ v√† gh√©p ch√∫ng l·∫°i th√†nh m·ªôt t·ªáp duy nh·∫•t. Qu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t nhi·ªÅu th·ªùi gian.</p>
            
            <div class="progress-bar mb-4">
                <div id="download-progress-indicator" class="progress-indicator" style="width: 0%;"></div>
            </div>

            <div class="flex justify-end space-x-3 mt-6">
                <button id="start-download-btn" class="btn btn-primary">B·∫Øt ƒë·∫ßu T·∫£i</button>
                <button id="cancel-download-btn" class="btn btn-danger hidden">H·ªßy</button>
                <button id="close-download-modal-btn" class="btn btn-secondary">ƒê√≥ng</button>
            </div>
        </div>
    </div>


    <script>
        const DEFAULT_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
        const DEFAULT_TRANSLATION_PROMPT = "B·∫°n l√† m·ªôt chuy√™n gia d·ªãch thu·∫≠t ti·∫øng Trung sang ti·∫øng Vi·ªát. B·∫°n nh·∫≠n ƒë∆∞·ª£c m·ªôt ƒëo·∫°n vƒÉn ƒë√£ ƒë∆∞·ª£c d·ªãch m·ªôt ph·∫ßn sang ti·∫øng Vi·ªát b·∫±ng t·ª´ ƒëi·ªÉn c√° nh√¢n (C√°c t·ª´ ƒë√£ d·ªãch ƒë∆∞·ª£c bao quanh b·ªüi th·∫ª <span class='highlight'>...</span>). Nhi·ªám v·ª• c·ªßa b·∫°n l√† b·ªè qua c√°c th·∫ª HTML v√† d·ªãch to√†n b·ªô ƒëo·∫°n vƒÉn sang ti·∫øng Vi·ªát t·ª± nhi√™n, tr√¥i ch·∫£y, s·ª≠ d·ª•ng c√°c t·ª´ H√°n Vi·ªát ƒë√£ ƒë∆∞·ª£c thay th·∫ø (n·∫øu ch√∫ng h·ª£p ng·ªØ c·∫£nh) v√† d·ªãch n·ªët c√°c t·ª´ ti·∫øng Trung c√≤n l·∫°i. Tr·∫£ l·ªùi ch·ªâ b·∫±ng vƒÉn b·∫£n d·ªãch, kh√¥ng th√™m l·ªùi gi·∫£i th√≠ch.";
        const DEFAULT_EXPLANATION_PROMPT = "B·∫°n l√† m·ªôt tr·ª£ l√Ω ng√¥n ng·ªØ, chuy√™n cung c·∫•p th√¥ng tin chi ti·∫øt v·ªÅ H√°n t·ª±. Ph·∫£n h·ªìi b·∫±ng ti·∫øng Vi·ªát, cung c·∫•p Pinyin, nghƒ©a ph·ªï bi·∫øn nh·∫•t v√† m·ªôt c√¢u v√≠ d·ª• ti·∫øng Trung v·ªõi b·∫£n d·ªãch ti·∫øng Vi·ªát.";
        const CHAPTER_TITLE_PROMPT = "D·ªãch danh s√°ch ti√™u ƒë·ªÅ ch∆∞∆°ng ti·∫øng Trung sau sang ti·∫øng Vi·ªát. B·∫ÆT BU·ªòC gi·ªØ nguy√™n c·∫•u tr√∫c ƒë√°nh s·ªë ch∆∞∆°ng (v√≠ d·ª•: Ch∆∞∆°ng 1, Ch∆∞∆°ng 2, Ch∆∞∆°ng XXX) v√† ch·ªâ d·ªãch ph·∫ßn t√™n ch∆∞∆°ng. Gi·ªØ ƒë·ªãnh d·∫°ng l√† m·ªôt danh s√°ch c√°c ti√™u ƒë·ªÅ ch∆∞∆°ng ƒë√£ d·ªãch, m·ªói ti√™u ƒë·ªÅ m·ªôt d√≤ng, KH√îNG TH√äM B·∫§T K·ª≤ VƒÇN B·∫¢N N√ÄO KH√ÅC.";
        const MAX_AI_ANALYSIS_LENGTH = 200000; 
        const MAX_BOOK_CONTENT_LENGTH = 20000000; 

        document.addEventListener('DOMContentLoaded', () => {
            // UI elements (Editing Mode)
            const editingInterface = document.getElementById('editing-interface');
            const vietnameseOutput = document.getElementById('vietnamese-output');
            const chineseInput = document.getElementById('chinese-input');
            const translateBtn = document.getElementById('translate-btn');
            const aiTranslateBtn = document.getElementById('ai-translate-btn');
            const aiLoadingSpinner = document.getElementById('ai-loading-spinner');
            const nextChapterBtn = document.getElementById('next-chapter-btn');
            const nextChapterTitleSpan = document.getElementById('next-chapter-title');
            const chineseInputLabel = document.getElementById('chinese-input-label');
            const bookFileInput = document.getElementById('book-file-input');
            const extractChaptersBtn = document.getElementById('extract-chapters-btn');
            const extractLoadingSpinner = document.getElementById('extract-loading-spinner');
            const bookStatus = document.getElementById('book-status');
            const chapterNavigator = document.getElementById('chapter-navigator');
            const chaptersUl = document.getElementById('chapters-ul');
            const bookFileLabel = document.getElementById('book-file-label');

            // Substitution Elements
            const runtimeSubstitutionList = document.getElementById('runtime-substitution-list');
            const postSubstitutionList = document.getElementById('post-substitution-list');
            const hanReplaceInput = document.getElementById('han-replace');
            const vietNewValueInput = document.getElementById('viet-new-value');
            const addRuntimeSubstitutionBtn = document.getElementById('add-runtime-substitution-btn'); 
            const addPostSubstitutionBtn = document.getElementById('add-post-substitution-btn'); 
            const vietOldPostInput = document.getElementById('viet-old-post');
            const vietNewPostInput = document.getElementById('viet-new-post');
            const applyAllSubstitutionBtn = document.getElementById('apply-all-substitution-btn');
            const dictionaryList = document.getElementById('dictionary-list');
            const hanInput = document.getElementById('han-input');
            const vietInput = document.getElementById('viet-input');
            const addWordBtn = document.getElementById('add-word-btn');
            const customPromptInput = document.getElementById('custom-prompt');
            const apiKeyList = document.getElementById('api-key-list');
            const keyCountSpan = document.getElementById('key-count');
            const newApiKeyInput = document.getElementById('new-api-key-input');
            const addApiKeyBtn = document.getElementById('add-api-key-btn');
            const clearBtn = document.getElementById('clear-btn');
            const aiExplainBtn = document.getElementById('ai-explain-btn');
            const hanExplainOutput = document.getElementById('han-explain-output');
            const settingsToggle = document.getElementById('settings-toggle');
            const advancedSettings = document.getElementById('advanced-settings');
            const toggleIcon = document.getElementById('toggle-icon');
            const bookToggle = document.getElementById('book-toggle');
            const bookAnalysisContent = document.getElementById('book-analysis-content');
            const bookToggleIcon = document.getElementById('book-toggle-icon');
            const dictionaryFileInput = document.getElementById('dictionary-file-input');
            const uploadDictionaryBtn = document.getElementById('upload-dictionary-btn');
            const uploadStatus = document.getElementById('upload-status');
            
            // UI elements (Reading Mode)
            const readingInterface = document.getElementById('reading-interface');
            const readingFooter = document.getElementById('reading-footer');
            const backToEditorBtn = document.getElementById('back-to-editor-btn');
            const readingChapterTitle = document.getElementById('reading-chapter-title');
            const readingContentArea = document.getElementById('reading-content-area');
            const prevChapterReadingBtn = document.getElementById('prev-chapter-reading-btn');
            const nextChapterReadingBtn = document.getElementById('next-chapter-reading-btn');
            const retranslateBtn = document.getElementById('retranslate-btn');
            const retranslateSpinner = document.getElementById('retranslate-spinner');
            const readingStatus = document.getElementById('reading-status');
            const openContentsBtn = document.getElementById('open-contents-btn');
            const openPostSubBtn = document.getElementById('open-post-sub-btn');

            // Modal elements
            const contentsModal = document.getElementById('contents-modal');
            const closeContentsModal = document.getElementById('close-contents-modal');
            const modalChaptersList = document.getElementById('modal-chapters-list');
            const postSubModal = document.getElementById('post-sub-modal');
            const closePostSubModal = document.getElementById('close-post-sub-modal');
            const modalPostSubList = document.getElementById('modal-post-sub-list');
            const modalVietOldPostInput = document.getElementById('modal-viet-old-post');
            const modalVietNewPostInput = document.getElementById('modal-viet-new-post');
            const addModalPostSubBtn = document.getElementById('add-modal-post-sub-btn');

            // Download Elements
            const downloadChapterBtn = document.getElementById('download-chapter-btn');
            const downloadAllBtn = document.getElementById('download-all-btn');
            const downloadModal = document.getElementById('download-modal');
            const downloadStatusText = document.getElementById('download-status-text');
            const downloadProgressIndicator = document.getElementById('download-progress-indicator');
            const startDownloadBtn = document.getElementById('start-download-btn');
            const cancelDownloadBtn = document.getElementById('cancel-download-btn');
            const closeDownloadModalBtn = document.getElementById('close-download-modal-btn');
            const backToReadingFromSettingsBtn = document.getElementById('back-to-reading-from-settings-btn');
            const readingBtnSeparator = document.getElementById('reading-btn-separator');


            // State
            let dictionary = []; // Permanent H√°n -> Vi·ªát
            let geminiApiKeys = [];
            let lastManualTranslationOutput = ''; 
            let lastTranslatedChineseInput = ''; 
            let lastAITranslationOutput = ''; 
            let rawBookContent = ''; 
            let bookFileName = 'TuyenDich';
            let chapterList = []; // Each object will now contain { title, startMarker, translatedTitle, translatedContent }
            let currentChapterIndex = -1;
            let runtimeSubstitutions = []; // Runtime H√°n -> Vi·ªát overrides (Temporary)
            let postSubstitutions = []; // Viet (Old) -> Vi·ªát (New) edits (Permanent)
            let isReadingMode = false;
            let isDownloadCancelled = false;

            // --- UI STATE MANAGEMENT ---
            function showModal(modalElement) {
                modalElement.classList.remove('hidden');
            }
            function hideModal(modalElement) {
                modalElement.classList.add('hidden');
            }

            function toggleInterfaceMode(mode) {
                const wasReading = isReadingMode;
                isReadingMode = mode === 'reading';
                
                const settingsToggleText = settingsToggle.querySelector('span:first-child');

                if (isReadingMode) {
                    editingInterface.classList.add('hidden');
                    readingInterface.classList.remove('hidden');
                    readingFooter.classList.remove('hidden');
                    updateReadingModeContent();
                    window.scrollTo(0, 0); 
                    
                    backToReadingFromSettingsBtn.classList.add('hidden');
                    readingBtnSeparator.classList.add('hidden');
                    settingsToggleText.textContent = '‚öôÔ∏è C√†i ƒë·∫∑t N√¢ng cao (API & Prompt)'; // Reset text

                } else { // Going TO editing
                    readingInterface.classList.add('hidden');
                    readingFooter.classList.add('hidden');
                    editingInterface.classList.remove('hidden');
                    window.scrollTo(0, 0); 
                    
                    if (wasReading && currentChapterIndex !== -1) {
                        backToReadingFromSettingsBtn.classList.remove('hidden');
                        readingBtnSeparator.classList.remove('hidden');
                        settingsToggleText.textContent = '‚öôÔ∏è C√†i ƒë·∫∑t & Quay l·∫°i ƒê·ªçc';
                    } else {
                        backToReadingFromSettingsBtn.classList.add('hidden');
                        readingBtnSeparator.classList.add('hidden');
                        settingsToggleText.textContent = '‚öôÔ∏è C√†i ƒë·∫∑t N√¢ng cao (API & Prompt)'; // Reset text
                    }
                }
            }
            
            function showReadingStatus(message, isError = false) {
                readingStatus.className = `text-sm font-semibold italic flex-grow text-center min-w-[200px] ${isError ? 'text-red-600' : 'text-gray-700'}`;
                readingStatus.textContent = message;
                retranslateBtn.disabled = isError;
                prevChapterReadingBtn.disabled = currentChapterIndex <= 0 || isError;
                nextChapterReadingBtn.disabled = currentChapterIndex >= chapterList.length - 1 || isError;
            }

            function updateReadingModeContent() {
                if (currentChapterIndex !== -1 && chapterList.length > 0) {
                    const chapter = chapterList[currentChapterIndex];
                    readingChapterTitle.textContent = chapter.translatedTitle || chapter.title;
                } else {
                     readingChapterTitle.textContent = 'B·∫£n D·ªãch';
                }
                
                let contentHTML = lastAITranslationOutput.replace(/\n\s*\n/g, '</p><p>').replace(/\n/g, '<br>');
                if (!contentHTML.startsWith('<p>')) {
                    contentHTML = `<p>${contentHTML}</p>`;
                }
                
                readingContentArea.innerHTML = contentHTML;
                showReadingStatus('S·∫µn s√†ng ƒë·ªçc.');
            }

            // --- UTILITY FUNCTIONS ---
            function escapeHtml(text) { 
                const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
                return text.replace(/[&<>"']/g, m => map[m]);
            }
            function escapeRegExp(string) { 
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }
            
            function sanitizeAiResponse(rawText) { 
                if (!rawText) return null;
                const jsonStart = rawText.indexOf('{');
                const jsonEnd = rawText.lastIndexOf('}');
                
                if (jsonStart !== -1 && jsonEnd !== -1 && jsonEnd > jsonStart) {
                    let jsonString = rawText.substring(jsonStart, jsonEnd + 1);
                    jsonString = jsonString.replace(/```json|```/g, '').trim();
                    return jsonString;
                }
                return rawText.trim();
            }

            function downloadCurrentChapter() {
                if (currentChapterIndex === -1 || !lastAITranslationOutput) {
                    alert('Kh√¥ng c√≥ n·ªôi dung d·ªãch AI ƒë·ªÉ t·∫£i xu·ªëng.');
                    return;
                }
                
                const chapter = chapterList[currentChapterIndex];
                const title = (chapter.translatedTitle || chapter.title).replace(/[\\/:*?"<>|]/g, ''); 
                const content = lastAITranslationOutput;
                
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${title}.txt`;
                
                document.body.appendChild(link);
                link.click();
                
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
                
                showReadingStatus('ƒê√£ t·∫£i xu·ªëng ch∆∞∆°ng!', false);
                setTimeout(() => showReadingStatus('S·∫µn s√†ng ƒë·ªçc.', false), 2000);
            }

            // --- API CALL HANDLING (Multi-Key Failover) ---
            async function callGeminiAPI(systemPrompt, userQuery, mimeType = "text/plain", schema = null, apiKeyOverride = null, retries = 0) { 
                const keys = apiKeyOverride ? [apiKeyOverride] : geminiApiKeys;
                const apiUrl = DEFAULT_API_URL;
                
                if (keys.length === 0) {
                    throw new Error("Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt Gemini API Key trong ph·∫ßn C√†i ƒë·∫∑t N√¢ng cao.");
                }

                let lastError = null;

                const generationConfig = { responseMimeType: mimeType };
                if (mimeType === "application/json" && schema) {
                    generationConfig.responseSchema = schema;
                }

                for (let i = 0; i < keys.length; i++) {
                    const apiKey = keys[i];
                    const url = apiUrl + apiKey;
                    const payload = {
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: generationConfig
                    };

                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            const errorStatus = response.status;
                            let errorDetail = `L·ªói ${errorStatus}`;
                            try {
                                const errorData = await response.json();
                                errorDetail = errorData.error.message || errorDetail;
                            } catch {}

                            if (errorStatus === 429) {
                                lastError = `Kh√≥a API ${i + 1} (${apiKey.substring(0,4)}...) ƒë√£ b·ªã gi·ªõi h·∫°n t·ªëc ƒë·ªô (429). ƒêang th·ª≠ kh√≥a ti·∫øp theo...`;
                            } else if (errorStatus === 400 || errorStatus === 403) {
                                lastError = `Kh√≥a API ${i + 1} (${apiKey.substring(0,4)}...) kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng c√≥ quy·ªÅn truy c·∫≠p (400/403). ƒêang th·ª≠ kh√≥a ti·∫øp theo...`;
                            } else {
                                lastError = `Kh√≥a API ${i + 1} (${apiKey.substring(0,4)}...) l·ªói: ${errorDetail}`;
                            }
                            console.error(lastError);
                            continue;
                        }

                        const result = await response.json();
                        let text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                        if (text) {
                            if (mimeType === "application/json") {
                                text = sanitizeAiResponse(text);
                            }
                            return { text, usedKey: apiKey };
                        } else {
                            lastError = `Kh√≥a API ${i + 1} (${apiKey.substring(0,4)}...) tr·∫£ v·ªÅ c·∫•u tr√∫c r·ªóng. ƒêang th·ª≠ kh√≥a ti·∫øp theo...`;
                            console.error(lastError);
                            continue;
                        }

                    } catch (error) {
                        lastError = `Kh√≥a API ${i + 1} (${apiKey.substring(0,4)}...) l·ªói k·∫øt n·ªëi: ${error.message}. ƒêang th·ª≠ kh√≥a ti·∫øp theo...`;
                        console.error(lastError);
                        continue;
                    }
                }

                throw new Error(`T·∫•t c·∫£ ${keys.length} kh√≥a API ƒë·ªÅu ƒë√£ th·∫•t b·∫°i. L·ªói cu·ªëi c√πng: ${lastError || 'Kh√¥ng c√≥ ph·∫£n h·ªìi.'}`);
            }

            // --- CORE APP LOGIC ---
            
            function loadSettings() { 
                geminiApiKeys = JSON.parse(localStorage.getItem('geminiApiKeys') || '[]');
                const storedPrompt = localStorage.getItem('customPrompt') || DEFAULT_TRANSLATION_PROMPT;
                customPromptInput.value = storedPrompt;
                renderKeyList();
            }
            function savePrompt() { localStorage.setItem('customPrompt', customPromptInput.value.trim()); }
            
            function saveKeys() {
                localStorage.setItem('geminiApiKeys', JSON.stringify(geminiApiKeys));
                renderKeyList();
            }
            function renderKeyList() { 
                apiKeyList.innerHTML = '';
                keyCountSpan.textContent = `${geminiApiKeys.length} Kh√≥a`;
                if (geminiApiKeys.length === 0) {
                    apiKeyList.innerHTML = '<p class="text-xs text-red-500">Ch∆∞a c√≥ kh√≥a n√†o. C√°c t√≠nh nƒÉng AI s·∫Ω kh√¥ng ho·∫°t ƒë·ªông.</p>';
                    return;
                }
                geminiApiKeys.forEach((key, index) => {
                    const keyEl = document.createElement('div');
                    keyEl.className = 'flex justify-between items-center bg-gray-50 p-2 rounded-md';
                    keyEl.innerHTML = `
                        <div>
                            <span class="font-medium">Key ${index + 1}: </span>
                            <span class="text-sm font-mono text-gray-700">${key.substring(0, 4)}...${key.substring(key.length - 4)}</span>
                        </div>
                        <button data-index="${index}" class="delete-key-btn text-red-500 hover:text-red-700 text-xs font-bold py-1 px-2 rounded-md">X√≥a</button>
                    `;
                    apiKeyList.appendChild(keyEl);
                });
            }
            function loadDictionary() { 
                const storedDict = localStorage.getItem('hanVietDict');
                if (storedDict) { dictionary = JSON.parse(storedDict); }
            }
            function loadPostSubstitutions() { 
                const storedSubs = localStorage.getItem('postSubstitutions');
                if (storedSubs) { postSubstitutions = JSON.parse(storedSubs); }
            }
            function saveDictionary() { localStorage.setItem('hanVietDict', JSON.stringify(dictionary)); }
            function savePostSubstitutions() { localStorage.setItem('postSubstitutions', JSON.stringify(postSubstitutions)); }
            function renderDictionary() { 
                dictionaryList.innerHTML = '';
                if (dictionary.length === 0) {
                    dictionaryList.innerHTML = '<p class="text-gray-500 text-sm">T·ª´ ƒëi·ªÉn c·ªßa b·∫°n ch∆∞a c√≥ t·ª´ n√†o.</p>';
                    return;
                }
                dictionary.forEach((word, index) => {
                    const wordEl = document.createElement('div');
                    wordEl.className = 'flex justify-between items-center bg-gray-50 p-2 rounded-md';
                    wordEl.innerHTML = `<div><span class="font-semibold text-gray-800">${word.han}</span><span class="text-gray-500 mx-2">‚Üí</span><span class="text-gray-700">${word.viet}</span></div><button data-index="${index}" class="delete-btn text-red-500 hover:text-red-700 text-xs font-bold py-1 px-2 rounded-md">X√≥a</button>`;
                    dictionaryList.appendChild(wordEl);
                });
            }
            function addWord(han, viet) { 
                if (han && viet) {
                    const existingIndex = dictionary.findIndex(w => w.han === han);
                    if (existingIndex !== -1) { dictionary[existingIndex].viet = viet; } else { dictionary.unshift({ han, viet }); }
                    return true;
                }
                return false;
            }
            function renderRuntimeSubstitutions() { 
                runtimeSubstitutionList.innerHTML = '';
                if (runtimeSubstitutions.length === 0) {
                    runtimeSubstitutionList.innerHTML = '<p class="text-gray-500 text-sm">Ch∆∞a c√≥ c·∫∑p H√°n -> Vi·ªát t·∫°m th·ªùi.</p>';
                    return;
                }
                runtimeSubstitutions.forEach((word, index) => {
                    const wordEl = document.createElement('div');
                    wordEl.className = 'flex justify-between items-center bg-yellow-100 p-2 rounded-md';
                    wordEl.innerHTML = `<div class="flex flex-col text-sm"><span class="font-bold text-gray-800">${word.han}</span><span class="text-gray-600">‚Üí ${word.viet}</span></div><div class="flex space-x-1"><button data-han="${word.han}" data-viet="${word.viet}" class="promote-btn btn btn-promote text-xs py-1 px-2 rounded-md">L∆∞u vƒ©nh vi·ªÖn</button><button data-index="${index}" class="delete-runtime-btn btn btn-danger text-xs py-1 px-2 rounded-md">X√≥a</button></div>`;
                    runtimeSubstitutionList.appendChild(wordEl);
                });
            }
            function addRuntimeSubstitution(han, viet) { 
                 if (han && viet) {
                    const existingIndex = runtimeSubstitutions.findIndex(w => w.han === han);
                    if (existingIndex !== -1) { runtimeSubstitutions[existingIndex].viet = viet; } else { runtimeSubstitutions.unshift({ han, viet }); }
                    renderRuntimeSubstitutions();
                    return true;
                }
                return false;
            }
            function renderPostSubstitutions(targetElement = postSubstitutionList) { 
                targetElement.innerHTML = '';
                if (postSubstitutions.length === 0) {
                    targetElement.innerHTML = '<p class="text-gray-500 text-sm">Ch∆∞a c√≥ c·∫∑p Vi·ªát -> Vi·ªát vƒ©nh vi·ªÖn.</p>';
                    return;
                }
                postSubstitutions.forEach((pair, index) => {
                    const wordEl = document.createElement('div');
                    wordEl.className = 'flex justify-between items-center post-sub-item p-2 rounded-md';
                    wordEl.innerHTML = `<div class="flex flex-col text-sm"><span class="font-bold text-gray-800">C≈©: ${pair.old}</span><span class="text-gray-600">‚Üí M·ªõi: ${pair.new}</span></div><div class="flex space-x-1"><button data-index="${index}" class="delete-post-btn btn btn-danger text-xs py-1 px-2 rounded-md">X√≥a</button></div>`;
                    targetElement.appendChild(wordEl);
                });
            }
            function addPostSubstitution(oldValue, newValue) { 
                if (oldValue && newValue) {
                    const existingIndex = postSubstitutions.findIndex(p => p.old === oldValue);
                    if (existingIndex !== -1) { postSubstitutions[existingIndex].new = newValue; } else { postSubstitutions.unshift({ old: oldValue, new: newValue }); }
                    savePostSubstitutions();
                    renderPostSubstitutions();
                    renderPostSubstitutions(modalPostSubList);
                    return true;
                }
                return false;
            }
            function deletePostSubstitution(index) { 
                postSubstitutions.splice(index, 1);
                savePostSubstitutions(); 
                renderPostSubstitutions();
                renderPostSubstitutions(modalPostSubList);
            }

             function getProcessedHanViet(inputText) {
                if (!inputText.trim()) { return ''; }
                let processedText = escapeHtml(inputText);
                const masterDictionary = [
                    ...runtimeSubstitutions,
                    ...dictionary.filter(perm => !runtimeSubstitutions.some(runtime => runtime.han === perm.han))
                ];
                const sortedDictionary = masterDictionary.sort((a, b) => b.han.length - a.han.length);
                sortedDictionary.forEach(word => {
                    const regex = new RegExp(escapeRegExp(escapeHtml(word.han)), 'g');
                    processedText = processedText.replace(regex, `<span class="highlight">${escapeHtml(word.viet)}</span>`);
                });

                let postRefinedText = processedText;
                const sortedPostSubstitutions = [...postSubstitutions].sort((a, b) => b.old.length - a.old.length);
                sortedPostSubstitutions.forEach(postSub => {
                    const oldEscaped = escapeHtml(postSub.old);
                    const newEscaped = escapeHtml(postSub.new);
                    const oldHighlightRegex = new RegExp(`<span class="highlight">${escapeRegExp(oldEscaped)}</span>`, 'g');
                    postRefinedText = postRefinedText.replace(oldHighlightRegex, `<span class="highlight">${newEscaped}</span>`);
                    const oldTextRegex = new RegExp(escapeRegExp(oldEscaped), 'g');
                    postRefinedText = postRefinedText.replace(oldTextRegex, `<span class="highlight">${newEscaped}</span>`);
                });
                return postRefinedText;
            }

            function translateText() {
                const inputText = chineseInput.value;
                const postRefinedText = getProcessedHanViet(inputText);

                if (postRefinedText) {
                    lastManualTranslationOutput = postRefinedText;
                    lastTranslatedChineseInput = inputText;
                    vietnameseOutput.innerHTML = postRefinedText.replace(/\n/g, '<br>');
                    if (geminiApiKeys.length > 0) {
                        aiTranslateBtn.classList.remove('hidden');
                    } else {
                        aiTranslateBtn.classList.add('hidden');
                    }
                } else {
                    vietnameseOutput.innerHTML = '<p class="text-gray-400">Vui l√≤ng nh·∫≠p vƒÉn b·∫£n c·∫ßn d·ªãch.</p>';
                    lastManualTranslationOutput = '';
                    lastTranslatedChineseInput = '';
                }
            }
            
            async function fetchAITranslation() {
                if (chineseInput.value !== lastTranslatedChineseInput) {
                    translateText();
                }

                if (!lastManualTranslationOutput.trim()) {
                    vietnameseOutput.innerHTML = '<p class="text-red-500">Vui l√≤ng nh·∫≠p vƒÉn b·∫£n ti·∫øng Trung v√†o √¥ d·ªãch.</p>';
                    return;
                }

                if (geminiApiKeys.length === 0) {
                    vietnameseOutput.innerHTML = `<div class="mt-4 p-4 rounded-md bg-red-100 border border-red-400 text-red-700"><h4 class="font-bold">‚ö†Ô∏è L·ªñI API</h4><p class="text-sm">Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt Gemini API Key trong ph·∫ßn C√†i ƒë·∫∑t N√¢ng cao ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng AI.</p></div>`;
                    return;
                }
                
                aiTranslateBtn.disabled = true;
                retranslateBtn.disabled = true;
                aiLoadingSpinner.classList.remove('hidden');
                retranslateSpinner.classList.remove('hidden');
                
                toggleInterfaceMode('reading');
                
                const chapterTitle = chapterList[currentChapterIndex]?.translatedTitle || chapterList[currentChapterIndex]?.title || 'Ch∆∞∆°ng hi·ªán t·∫°i';
                readingChapterTitle.textContent = chapterTitle; 
                
                readingContentArea.innerHTML = `<div class="text-center text-gray-500 italic p-10">
                    <div class="spinner mx-auto" style="width: 48px; height: 48px; border-color: rgba(74, 124, 89, 0.2); border-top-color: #4a7c59;"></div>
                    <p class="mt-4">AI ƒëang d·ªãch to√†n b·ªô ch∆∞∆°ng "${chapterTitle}".<br>Qu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t m·ªôt l√∫c, vui l√≤ng ch·ªù...</p>
                </div>`;
                showReadingStatus(`ƒêang d·ªãch ch∆∞∆°ng "${chapterTitle}"...`, false);

                const originalContentForRecovery = vietnameseOutput.innerHTML; 
                const systemPrompt = customPromptInput.value.trim() || DEFAULT_TRANSLATION_PROMPT;
                const userQuery = `D·ªãch ƒëo·∫°n vƒÉn sau:\n\n${lastManualTranslationOutput}`;

                try {
                    const result = await callGeminiAPI(systemPrompt, userQuery);
                    
                    const finalTranslation = result.text.trim(); 
                    lastAITranslationOutput = finalTranslation;
                    if(currentChapterIndex !== -1) {
                        chapterList[currentChapterIndex].translatedContent = finalTranslation;
                    }
                    
                    updateReadingModeContent();
                    showReadingStatus('D·ªãch ho√†n ch·ªânh th√†nh c√¥ng!', false);
                    updateDownloadButtonsState();

                } catch (error) {
                    toggleInterfaceMode('editing'); 
                    
                    vietnameseOutput.innerHTML = originalContentForRecovery; 
                    vietnameseOutput.innerHTML += `<div class="mt-4 p-4 rounded-md bg-red-100 border border-red-400 text-red-700"><h4 class="font-bold">‚ö†Ô∏è L·ªñI D·ªäCH THU·∫¨T AI</h4><p class="text-sm">ƒê√£ x·∫£y ra l·ªói. To√†n b·ªô ${geminiApiKeys.length} kh√≥a API ƒë·ªÅu ƒë√£ b·ªã t·ª´ ch·ªëi ho·∫∑c b·ªã gi·ªõi h·∫°n t·ªëc ƒë·ªô. Vui l√≤ng ki·ªÉm tra Keys ho·∫∑c gi·ªõi h·∫°n s·ª≠ d·ª•ng.</p><p class="text-xs mt-1">Chi ti·∫øt l·ªói: ${error.message}</p></div>`;
                    console.error("AI Translation Error:", error);
                    showReadingStatus('L·ªói: D·ªãch thu·∫≠t th·∫•t b·∫°i!', true);

                } finally {
                    aiTranslateBtn.disabled = false;
                    retranslateBtn.disabled = false;
                    aiLoadingSpinner.classList.add('hidden');
                    retranslateSpinner.classList.add('hidden');
                    updateNextChapterButton();
                }
            }

            // Chapter Navigation & Book Slicing Logic 
            const chapterSchema = { 
                type: "OBJECT",
                properties: {
                    chapters: {
                        type: "ARRAY",
                        description: "An array of extracted chapter titles and their starting markers. The order must be maintained.",
                        items: {
                            type: "OBJECT",
                            properties: {
                                title: { type: "STRING", description: "The clean title of the chapter (e.g., 'Ch∆∞∆°ng 1: B·∫Øt ƒë·∫ßu')." },
                                startMarker: { type: "STRING", description: "The exact H√°n t·ª± string marking the start of this chapter in the raw text (e.g., 'Á¨¨1Á´†', 'Ch∆∞∆°ng 1', 'Á¨¨‰∏ÄÁ´†'). This marker is used for slicing." }
                            },
                            required: ["title", "startMarker"]
                        }
                    }
                }
            };
            
            async function translateChapterTitles(titles) {
                if (geminiApiKeys.length === 0) return titles;

                const titleListString = titles.join('\n');
                const systemPrompt = CHAPTER_TITLE_PROMPT;
                const userQuery = titleListString;
                
                try {
                    const { text: translatedText } = await callGeminiAPI(systemPrompt, userQuery);
                    return translatedText.trim().split('\n').map(t => t.trim());
                } catch (error) {
                    console.error("L·ªói d·ªãch ti√™u ƒë·ªÅ AI:", error);
                    return titles;
                }
            }
            
            function handleBookUpload() { 
                const file = bookFileInput.files[0];
                if (!file) return;

                bookFileLabel.textContent = `T·ªáp: ${file.name}`;
                bookFileName = file.name.replace(/\.txt$/i, ''); // Store book name without extension
                rawBookContent = ''; 
                chapterList = [];
                currentChapterIndex = -1;
                chapterNavigator.classList.add('hidden');
                updateDownloadButtonsState();
                
                extractChaptersBtn.disabled = false; 
                bookStatus.className = 'text-gray-500 text-sm mt-2';
                bookStatus.textContent = `T·ªáp "${file.name}" ƒë√£ s·∫µn s√†ng. Vui l√≤ng b·∫•m "AI Ph√¢n t√≠ch..."`;
                
                runtimeSubstitutions = []; 
                renderRuntimeSubstitutions();
                renderPostSubstitutions();


                const reader = new FileReader();
                reader.onload = (e) => {
                    rawBookContent = e.target.result;
                    if (rawBookContent.length > MAX_BOOK_CONTENT_LENGTH) {
                        bookStatus.className = 'text-red-500 text-sm mt-2 font-bold';
                        bookStatus.textContent = `T·ªáp qu√° l·ªõn (> ${MAX_BOOK_CONTENT_LENGTH / 1000000}MB). Vui l√≤ng ch·ªçn t·ªáp nh·ªè h∆°n.`;
                        extractChaptersBtn.disabled = true;
                        rawBookContent = '';
                    } else {
                        extractChaptersBtn.disabled = false; 
                    }
                };
                reader.onerror = () => {
                    bookStatus.className = 'text-red-500 text-sm mt-2';
                    bookStatus.textContent = 'L·ªói khi ƒë·ªçc t·ªáp.';
                    extractChaptersBtn.disabled = true;
                };
                reader.readAsText(file);
            }

            async function extractChapters(contentForAI) { 
                if (geminiApiKeys.length === 0) {
                    bookStatus.className = 'text-red-500 text-sm mt-2';
                    bookStatus.textContent = 'Kh√¥ng th·ªÉ ph√¢n t√≠ch: Vui l√≤ng th√™m API Key.';
                    return;
                }

                extractChaptersBtn.disabled = true;
                extractLoadingSpinner.classList.remove('hidden');
                bookStatus.className = 'text-gray-500 text-sm mt-2';
                bookStatus.textContent = `AI ƒëang ph√¢n t√≠ch c·∫•u tr√∫c ch∆∞∆°ng t·ª´ ${MAX_AI_ANALYSIS_LENGTH.toLocaleString('vi-VN')} k√Ω t·ª± ƒë·∫ßu...`;
                
                const systemPrompt = "B·∫°n l√† m·ªôt c√¥ng c·ª• ph√¢n t√≠ch c·∫•u tr√∫c truy·ªán/ti·ªÉu thuy·∫øt. Nhi·ªám v·ª• c·ªßa b·∫°n l√† tr√≠ch xu·∫•t ti√™u ƒë·ªÅ c·ªßa c√°c ch∆∞∆°ng v√† chu·ªói H√°n t·ª± ch√≠nh x√°c ƒë√°nh d·∫•u s·ª± b·∫Øt ƒë·∫ßu c·ªßa ch∆∞∆°ng ƒë√≥ (startMarker) t·ª´ vƒÉn b·∫£n th√¥. B·∫ÆT BU·ªòNG ch·ªâ tr·∫£ v·ªÅ JSON theo Schema ƒë∆∞·ª£c cung c·∫•p, KH√îNG TH√äM B·∫§T K·ª≤ VƒÇN B·∫¢N, GI·∫¢I TH√çCH, HO·∫∂C M√É MARKDOWN N√ÄO (nh∆∞ ```json).";
                const userQuery = `Tr√≠ch xu·∫•t danh s√°ch ch∆∞∆°ng (title v√† startMarker) t·ª´ n·ªôi dung sau:\n\n${contentForAI}`; 

                let rawResponse = null;

                try {
                    const response = await callGeminiAPI(systemPrompt, userQuery, "application/json", chapterSchema);
                    rawResponse = response.text; 

                    const result = JSON.parse(rawResponse); 
                    chapterList = result.chapters || [];

                    if (chapterList.length > 1) {
                        // B·∫Øt ƒë·∫ßu d·ªãch ti√™u ƒë·ªÅ
                        bookStatus.textContent = `ƒê√£ tr√≠ch xu·∫•t ${chapterList.length} ch∆∞∆°ng. ƒêang d·ªãch ti√™u ƒë·ªÅ...`;
                        const originalTitles = chapterList.map(c => c.title);
                        const translatedTitles = await translateChapterTitles(originalTitles);
                        
                        chapterList.forEach((chapter, index) => {
                            chapter.translatedTitle = translatedTitles[index] || chapter.title;
                            chapter.translatedContent = null; // Initialize translated content
                        });

                        currentChapterIndex = 0;
                        renderChapterNavigator();
                        chapterNavigator.classList.remove('hidden');
                        selectChapter(0, false); 
                        bookStatus.className = 'text-green-600 text-sm mt-2 font-semibold';
                        bookStatus.textContent = `Th√†nh c√¥ng! ƒê√£ tr√≠ch xu·∫•t & d·ªãch ${chapterList.length} ti√™u ƒë·ªÅ ch∆∞∆°ng. ƒêang t·∫£i ch∆∞∆°ng ƒë·∫ßu ti√™n.`;
                    } else {
                        chapterList = [];
                        bookStatus.className = 'text-red-500 text-sm mt-2';
                        bookStatus.textContent = 'AI kh√¥ng th·ªÉ tr√≠ch xu·∫•t c·∫•u tr√∫c ch∆∞∆°ng r√µ r√†ng (Ch·ªâ t√¨m th·∫•y 0 ho·∫∑c 1 ch∆∞∆°ng). Vui l√≤ng ki·ªÉm tra l·∫°i ƒë·ªãnh d·∫°ng t·ªáp.';
                        chapterNavigator.classList.add('hidden');
                    }
                } catch (error) {
                    let displayError = `L·ªói ph√¢n t√≠ch JSON. Vui l√≤ng th·ª≠ l·∫°i.`;
                    if (rawResponse) {
                         displayError = `Ph√¢n t√≠ch th·∫•t b·∫°i. Ph·∫£n h·ªìi th√¥ c·ªßa AI: "${rawResponse.substring(0, 100)}..."`;
                    } else if (error.message.includes("T·∫•t c·∫£")) {
                        displayError = error.message; 
                    }
                    bookStatus.className = 'text-red-500 text-sm mt-2';
                    bookStatus.textContent = displayError;
                    chapterList = [];
                } finally {
                    extractChaptersBtn.disabled = false;
                    extractLoadingSpinner.classList.add('hidden');
                    updateDownloadButtonsState();
                }
            }

            function sliceChapterContent(index) { 
                const maxChapterLength = 20000; 
                if (index < 0 || index >= chapterList.length) return '';
                const currentChapter = chapterList[index];
                const startMarker = currentChapter.startMarker;
                let endMarker = '';
                if (index < chapterList.length - 1) { endMarker = chapterList[index + 1].startMarker; }
                const startIndex = rawBookContent.indexOf(startMarker);
                if (startIndex === -1) { return `L·ªói: Kh√¥ng t√¨m th·∫•y ƒëi·ªÉm b·∫Øt ƒë·∫ßu "${startMarker}" trong t·ªáp s√°ch.`; }
                let endIndex;
                if (endMarker) {
                    endIndex = rawBookContent.indexOf(endMarker, startIndex + startMarker.length);
                    if (endIndex === -1) { endIndex = rawBookContent.length; }
                } else { endIndex = rawBookContent.length; }
                let content = rawBookContent.substring(startIndex, endIndex).trim();
                if (content.length > maxChapterLength) {
                    content = content.substring(0, maxChapterLength) + "\n\n[...N·ªôi dung c√≤n l·∫°i c·ªßa ch∆∞∆°ng ƒë√£ b·ªã c·∫Øt do qu√° d√†i. Vui l√≤ng t·∫£i l√™n t·ªáp ƒë∆∞·ª£c chia nh·ªè h∆°n ho·∫∑c sao ch√©p th·ªß c√¥ng ph·∫ßn ti·∫øp theo.]";
                }
                return content;
             }
            function renderChapterNavigator() { 
                chaptersUl.innerHTML = '';
                modalChaptersList.innerHTML = '';
                chapterList.forEach((chapter, index) => {
                    const chapterNumber = index + 1; // STT
                    const displayTitle = chapter.translatedTitle || chapter.title;
                    const originalTitle = chapter.title;

                    // Editing mode navigator
                    const li = document.createElement('li');
                    li.className = `p-2 rounded-md text-sm cursor-pointer hover:bg-gray-100 transition-colors ${index === currentChapterIndex ? 'chapter-active font-semibold' : ''}`;
                    li.innerHTML = `<span class="font-bold text-[#8c52ff]">STT ${chapterNumber}.</span> ${displayTitle} <span class="text-xs text-gray-500 italic">(${originalTitle})</span>`;
                    li.dataset.index = index;
                    li.addEventListener('click', () => selectChapter(index));
                    chaptersUl.appendChild(li);

                    // Modal navigator
                    const modalLi = document.createElement('li');
                    modalLi.className = `p-2 rounded-md text-base cursor-pointer hover:bg-gray-100 transition-colors ${index === currentChapterIndex ? 'chapter-active font-bold' : ''}`;
                    modalLi.innerHTML = `<span class="font-bold text-[#8c52ff]">STT ${chapterNumber}.</span> <span class="text-gray-800">${displayTitle}</span> <span class="text-xs text-gray-500 italic">(${originalTitle})</span>`;
                    modalLi.dataset.index = index;
                    modalLi.addEventListener('click', () => { selectChapter(index); hideModal(contentsModal); });
                    modalChaptersList.appendChild(modalLi);
                });
             }
            function selectChapter(index, autoScroll = true) { 
                if (index < 0 || index >= chapterList.length) return;
                currentChapterIndex = index;
                renderChapterNavigator();
                runtimeSubstitutions = []; 
                renderRuntimeSubstitutions();
                const chapterTitle = chapterList[index].translatedTitle || chapterList[index].title;
                chineseInputLabel.textContent = `VƒÉn b·∫£n ti·∫øng Trung: ƒêang d·ªãch "${chapterTitle}"`;
                chineseInput.value = "ƒêang t·∫£i n·ªôi dung...";
                const content = sliceChapterContent(index);
                chineseInput.value = content;
                vietnameseOutput.innerHTML = '<p class="text-gray-400">K·∫øt qu·∫£ d·ªãch s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y...</p>';
                lastTranslatedChineseInput = ''; 
                updateNextChapterButton();
                if (autoScroll && !isReadingMode) {
                    chineseInput.scrollIntoView({ behavior: 'smooth' });
                    chineseInput.focus();
                }
            }
            function updateNextChapterButton() { 
                if (currentChapterIndex >= 0 && currentChapterIndex < chapterList.length - 1) {
                    const nextChapter = chapterList[currentChapterIndex + 1];
                    const nextChapterTitle = nextChapter.translatedTitle || nextChapter.title;
                    nextChapterTitleSpan.textContent = nextChapterTitle;
                    nextChapterBtn.classList.remove('hidden');
                    nextChapterBtn.disabled = false;
                } else if (currentChapterIndex === chapterList.length - 1 && chapterList.length > 0) {
                    nextChapterTitleSpan.textContent = 'ƒê√£ ho√†n th√†nh cu·ªën s√°ch!';
                    nextChapterBtn.classList.remove('hidden');
                    nextChapterBtn.disabled = true;
                } else {
                    nextChapterBtn.classList.add('hidden');
                    nextChapterBtn.disabled = true;
                }
            }
            function goToNextChapter() {
                if (currentChapterIndex < chapterList.length - 1) {
                    selectChapter(currentChapterIndex + 1);
                    if (isReadingMode) {
                        fetchAITranslation();
                    }
                } else {
                    alert('B·∫°n ƒë√£ ho√†n th√†nh ch∆∞∆°ng cu·ªëi c√πng trong s√°ch!'); 
                }
            }
            function goToPrevChapter() {
                if (currentChapterIndex > 0) {
                    selectChapter(currentChapterIndex - 1);
                    if (isReadingMode) {
                        fetchAITranslation();
                    }
                }
            }

             // --- BATCH DOWNLOAD LOGIC ---
            function updateDownloadButtonsState() {
                const hasAnyTranslatedChapter = chapterList.some(c => c.translatedContent);
                downloadAllBtn.disabled = !hasAnyTranslatedChapter;
            }

            function openDownloadModal() {
                isDownloadCancelled = false;
                downloadStatusText.textContent = 'C√¥ng c·ª• s·∫Ω t·ª± ƒë·ªông d·ªãch c√°c ch∆∞∆°ng ch∆∞a c√≥ v√† gh√©p ch√∫ng l·∫°i th√†nh m·ªôt t·ªáp duy nh·∫•t. Qu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t nhi·ªÅu th·ªùi gian.';
                downloadProgressIndicator.style.width = '0%';
                startDownloadBtn.classList.remove('hidden');
                cancelDownloadBtn.classList.add('hidden');
                closeDownloadModalBtn.textContent = 'ƒê√≥ng';
                showModal(downloadModal);
            }

            async function downloadAllChapters() {
                startDownloadBtn.classList.add('hidden');
                cancelDownloadBtn.classList.remove('hidden');
                closeDownloadModalBtn.disabled = true;
                isDownloadCancelled = false;

                const systemPrompt = customPromptInput.value.trim() || DEFAULT_TRANSLATION_PROMPT;
                let fullBookText = '';

                try {
                    for (let i = 0; i < chapterList.length; i++) {
                        if (isDownloadCancelled) {
                            throw new Error('ƒê√£ h·ªßy t·∫£i xu·ªëng.');
                        }
                        
                        const chapter = chapterList[i];
                        const progress = ((i + 1) / chapterList.length) * 100;

                        if (!chapter.translatedContent) {
                            downloadStatusText.textContent = `ƒêang d·ªãch ch∆∞∆°ng ${i + 1}/${chapterList.length}: "${chapter.translatedTitle || chapter.title}"...`;
                            
                            const chineseContent = sliceChapterContent(i);
                            const hanVietContent = getProcessedHanViet(chineseContent);
                            const userQuery = `D·ªãch ƒëo·∫°n vƒÉn sau:\n\n${hanVietContent}`;

                            // Add a small delay between API calls to avoid rate limiting
                            if (i > 0) await new Promise(res => setTimeout(res, 200)); 

                            const result = await callGeminiAPI(systemPrompt, userQuery);
                            chapter.translatedContent = result.text.trim();
                        } else {
                            downloadStatusText.textContent = `ƒêang x·ª≠ l√Ω ch∆∞∆°ng ${i + 1}/${chapterList.length}: "${chapter.translatedTitle || chapter.title}"...`;
                        }
                        
                        downloadProgressIndicator.style.width = `${progress}%`;
                    }

                    // Assemble the final text file
                    chapterList.forEach(chapter => {
                        fullBookText += `\n\n\n\n${chapter.translatedTitle || chapter.title}\n\n`;
                        fullBookText += `${chapter.translatedContent}`;
                    });
                    
                    const blob = new Blob([fullBookText.trim()], { type: 'text/plain;charset=utf-8' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `${bookFileName}.txt`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);

                    downloadStatusText.textContent = `Ho√†n th√†nh! ƒê√£ t·∫£i xu·ªëng to√†n b·ªô ${chapterList.length} ch∆∞∆°ng.`;

                } catch (error) {
                    downloadStatusText.textContent = `L·ªói: ${error.message}`;
                    downloadStatusText.classList.add('text-red-500');
                } finally {
                    cancelDownloadBtn.classList.add('hidden');
                    closeDownloadModalBtn.disabled = false;
                    closeDownloadModalBtn.textContent = 'Ho√†n t·∫•t';
                }
            }

            // --- INITIALIZATION ---
            function initialize() {
                loadSettings();
                loadDictionary();
                loadPostSubstitutions(); 
                renderDictionary();
                renderRuntimeSubstitutions();
                renderPostSubstitutions(postSubstitutionList);
                renderPostSubstitutions(modalPostSubList);
                updateDownloadButtonsState();
            }

            // --- EVENT LISTENERS ---
            backToEditorBtn.addEventListener('click', () => toggleInterfaceMode('editing'));
            
            downloadChapterBtn.addEventListener('click', downloadCurrentChapter);
            downloadAllBtn.addEventListener('click', openDownloadModal);
            startDownloadBtn.addEventListener('click', downloadAllChapters);
            cancelDownloadBtn.addEventListener('click', () => { isDownloadCancelled = true; });
            closeDownloadModalBtn.addEventListener('click', () => hideModal(downloadModal));

            backToReadingFromSettingsBtn.addEventListener('click', () => toggleInterfaceMode('reading'));

            prevChapterReadingBtn.addEventListener('click', goToPrevChapter);
            nextChapterReadingBtn.addEventListener('click', goToNextChapter);
            retranslateBtn.addEventListener('click', fetchAITranslation);
            openContentsBtn.addEventListener('click', () => showModal(contentsModal));
            closeContentsModal.addEventListener('click', () => hideModal(contentsModal));
            openPostSubBtn.addEventListener('click', () => showModal(postSubModal));
            closePostSubModal.addEventListener('click', () => hideModal(postSubModal));
            
            // Modal Post Sub Controls
            addModalPostSubBtn.addEventListener('click', () => {
                const oldVal = modalVietOldPostInput.value.trim();
                const newVal = modalVietNewPostInput.value.trim();
                if (addPostSubstitution(oldVal, newVal)) {
                    modalVietOldPostInput.value = '';
                    modalVietNewPostInput.value = '';
                } else {
                    alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß C·ª•m t·ª´ Vi·ªát C≈® v√† C·ª•m t·ª´ Vi·ªát M·ªöI.');
                }
            });
            modalPostSubList.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-post-btn')) {
                    const index = e.target.getAttribute('data-index');
                    deletePostSubstitution(index); 
                }
            });

            bookFileInput.addEventListener('change', handleBookUpload);
            extractChaptersBtn.addEventListener('click', () => {
                const contentForAI = rawBookContent.substring(0, MAX_AI_ANALYSIS_LENGTH);
                if(rawBookContent) extractChapters(contentForAI);
            });
            settingsToggle.addEventListener('click', () => {
                const isHidden = advancedSettings.classList.contains('hidden');
                if (isHidden) {
                    advancedSettings.classList.remove('hidden');
                    toggleIcon.textContent = '‚ñ≤';
                } else {
                    advancedSettings.classList.add('hidden');
                    toggleIcon.textContent = '‚ñº';
                }
            });
            bookToggle.addEventListener('click', () => {
                const isHidden = bookAnalysisContent.classList.contains('hidden');
                if (isHidden) {
                    bookAnalysisContent.classList.remove('hidden');
                    bookToggleIcon.textContent = '‚ñ≤';
                } else {
                    bookAnalysisContent.classList.add('hidden');
                    bookToggleIcon.textContent = '‚ñº';
                }
            });

            customPromptInput.addEventListener('input', savePrompt);

            addApiKeyBtn.addEventListener('click', () => {
                const key = newApiKeyInput.value.trim();
                if (key && !geminiApiKeys.includes(key)) {
                    geminiApiKeys.unshift(key);
                    saveKeys();
                    newApiKeyInput.value = '';
                    newApiKeyInput.focus();
                } else if (geminiApiKeys.includes(key)) {
                    newApiKeyInput.value = '';
                }
            });
            newApiKeyInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addKey();
            });
            apiKeyList.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-key-btn')) {
                    const index = e.target.getAttribute('data-index');
                    geminiApiKeys.splice(index, 1);
                    saveKeys();
                    translateText();
                }
            });
            
            dictionaryFileInput.addEventListener('change', () => {
                uploadDictionaryBtn.disabled = !dictionaryFileInput.files.length;
                uploadStatus.textContent = '';
            });
            uploadDictionaryBtn.addEventListener('click', () => {
                const file = dictionaryFileInput.files[0];
                if (!file) {
                    uploadStatus.className = 'text-red-500 text-sm mt-2';
                    uploadStatus.textContent = 'Vui l√≤ng ch·ªçn m·ªôt t·ªáp ƒë·ªÉ t·∫£i l√™n.';
                    return;
                }
                uploadDictionaryBtn.disabled = true;
                uploadStatus.className = 'text-gray-500 text-sm mt-2';
                uploadStatus.textContent = 'ƒêang ƒë·ªçc t·ªáp...';
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    const lines = content.split('\n').filter(line => line.trim() !== '');
                    let newWordsCount = 0;
                    lines.forEach(line => {
                        const parts = line.split(/[,=]/).map(p => p.trim()).filter(p => p.length > 0);
                        if (parts.length >= 2) {
                            const han = parts[0];
                            const viet = parts[1];
                            if (addWord(han, viet)) { newWordsCount++; }
                        }
                    });
                    saveDictionary();
                    renderDictionary();
                    uploadStatus.className = 'text-green-600 text-sm mt-2 font-semibold';
                    uploadStatus.textContent = `T·∫£i l√™n th√†nh c√¥ng! ƒê√£ th√™m/c·∫≠p nh·∫≠t ${newWordsCount} t·ª´.`;
                    dictionaryFileInput.value = '';
                    uploadDictionaryBtn.disabled = false;
                };
                reader.onerror = () => {
                    uploadStatus.className = 'text-red-500 text-sm mt-2';
                    uploadStatus.textContent = 'L·ªói khi ƒë·ªçc t·ªáp.';
                    uploadDictionaryBtn.disabled = false;
                };
                reader.readAsText(file);
            });
            
            nextChapterBtn.addEventListener('click', goToNextChapter);

            addWordBtn.addEventListener('click', () => {
                if (addWord(hanInput.value.trim(), vietInput.value.trim())) {
                    saveDictionary();
                    renderDictionary();
                    hanInput.value = '';
                    vietInput.value = '';
                    hanExplainOutput.classList.add('hidden');
                    hanInput.focus();
                }
            });
            dictionaryList.addEventListener('click', (e) => {
                 if (e.target.classList.contains('delete-btn')) {
                    const index = e.target.getAttribute('data-index');
                    dictionary.splice(index, 1);
                    saveDictionary();
                    renderDictionary();
                    translateText();
                }
            });
            
            addRuntimeSubstitutionBtn.addEventListener('click', () => {
                const han = hanReplaceInput.value.trim();
                const viet = vietNewValueInput.value.trim();
                if (addRuntimeSubstitution(han, viet)) {
                    hanReplaceInput.value = '';
                    vietNewValueInput.value = '';
                } else {
                    alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß H√°n t·ª± v√† Nghƒ©a Vi·ªát m·ªõi.');
                }
            });
            runtimeSubstitutionList.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-runtime-btn')) {
                    const index = e.target.getAttribute('data-index');
                    runtimeSubstitutions.splice(index, 1);
                    renderRuntimeSubstitutions();
                    translateText();
                } else if (e.target.classList.contains('promote-btn')) {
                    const han = e.target.getAttribute('data-han');
                    const viet = e.target.getAttribute('data-viet');
                    addWord(han, viet);
                    saveDictionary();
                    renderDictionary();
                    runtimeSubstitutions = runtimeSubstitutions.filter(w => w.han !== han);
                    renderRuntimeSubstitutions();
                    translateText();
                }
            });
            
            addPostSubstitutionBtn.addEventListener('click', () => {
                const oldVal = vietOldPostInput.value.trim();
                const newVal = vietNewPostInput.value.trim();
                if (addPostSubstitution(oldVal, newVal)) {
                    vietOldPostInput.value = '';
                    vietNewPostInput.value = '';
                } else {
                    alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß C·ª•m t·ª´ Vi·ªát C≈® v√† C·ª•m t·ª´ Vi·ªát M·ªöI.');
                }
            });
            postSubstitutionList.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-post-btn')) {
                    const index = e.target.getAttribute('data-index');
                    deletePostSubstitution(index); 
                    translateText();
                }
            });
            
            applyAllSubstitutionBtn.addEventListener('click', translateText);
            
            aiExplainBtn.addEventListener('click', async () => { 
                const han = hanInput.value.trim();
                if (!han) {
                    hanExplainOutput.innerHTML = '<p class="text-red-500">Vui l√≤ng nh·∫≠p H√°n t·ª± ƒë·ªÉ ph√¢n t√≠ch.</p>';
                    hanExplainOutput.classList.remove('hidden');
                    return;
                }

                aiExplainBtn.disabled = true;
                aiExplainBtn.innerHTML = '<span class="spinner mr-2 w-4 h-4 border-white"></span> ƒêang ph√¢n t√≠ch...';
                hanExplainOutput.classList.remove('hidden');
                hanExplainOutput.innerHTML = `<div class="text-gray-500">ƒêang t·∫£i...</div>`;

                const systemPrompt = DEFAULT_EXPLANATION_PROMPT;
                const userQuery = `Ph√¢n t√≠ch chi ti·∫øt t·ª´ H√°n t·ª±/t·ª´ v·ª±ng: "${han}"`;

                try {
                    const { text: aiResult } = await callGeminiAPI(systemPrompt, userQuery);
                    hanExplainOutput.innerHTML = `<h4 class="font-semibold text-indigo-700">Ph√¢n t√≠ch cho "${han}":</h4><p class="mt-1">${aiResult.replace(/\n/g, '<br>')}</p>`;
                } catch (error) {
                    hanExplainOutput.innerHTML = `<p class="text-red-500">L·ªói AI: ${error.message}</p>`;
                } finally {
                    aiExplainBtn.disabled = false;
                    aiExplainBtn.innerHTML = '‚ú® Ph√¢n T√≠ch';
                }
            });
            aiTranslateBtn.addEventListener('click', fetchAITranslation);
            translateBtn.addEventListener('click', translateText);
            
            clearBtn.addEventListener('click', () => {
                chineseInput.value = '';
                vietnameseOutput.innerHTML = '<p class="text-gray-400">K·∫øt qu·∫£ d·ªãch s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y...</p>';
                lastManualTranslationOutput = '';
                lastTranslatedChineseInput = '';
            });

            initialize();
        });
    </script>
</body>
</html>