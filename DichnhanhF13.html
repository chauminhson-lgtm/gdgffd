<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng c·ª• D·ªãch H√°n Vi·ªát</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chosen Palette: Scholarly Calm -->
    <!-- Application Structure Plan: Refactored the entire app to use Firebase Firestore for persistent novel and translated chapter storage. Replaced the simple file upload with a Novel Management System (NMS) and an upload modal for metadata (Title, Author, Synopsis). Reading Mode now checks Firestore for saved translations first, enabling instant loading and providing download functionalities. This fundamentally changes the app from a session tool to a persistent project manager. -->
    <!-- Visualization & Content Choices: The fixed footer and modal implementations prioritize user interaction, allowing seamless transition between reading and refining the translation without losing the context of the page. The status bar provides necessary feedback during asynchronous translation processes. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fdfaf6;
            color: #4a4a4a;
        }
        .highlight {
            background-color: #ffe680;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 600;
            color: #333;
            line-height: 1.8;
            white-space: pre-wrap;
            display: inline-block;
        }
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        .card:hover {
             box-shadow: 0 8px 24px rgba(0,0,0,0.08);
        }
        .btn {
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .btn-primary {
            background-color: #4a7c59;
            color: white;
        }
        .btn-primary:hover {
            background-color: #3e684b;
        }
        .btn-secondary {
            background-color: #e0e0e0;
            color: #555;
        }
        .btn-secondary:hover {
            background-color: #d1d1d1;
        }
        .btn-ai {
            background-color: #8c52ff;
            color: white;
        }
        .btn-ai:hover {
            background-color: #7a46e1;
        }
        .btn-danger {
            background-color: #d9534f;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c9302c;
        }
        input[type="text"], textarea {
            border: 1px solid #e0e0e0;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        input[type="text"]:focus, textarea:focus {
            border-color: #4a7c59;
            box-shadow: 0 0 0 2px rgba(74, 124, 89, 0.2);
            outline: none;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .chapter-active {
            background-color: #e6e9f2;
            border-left: 4px solid #8c52ff;
        }
        .btn-promote {
            background-color: #10b981;
            color: white;
        }
        .btn-promote:hover {
            background-color: #059669;
        }
        .post-sub-item {
            background-color: #f0f9ff;
        }
        .progress-bar {
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        .progress-indicator {
            height: 100%;
            background-color: #4a7c59;
            transition: width 0.3s ease;
        }
        /* Custom styles for Reading Mode */
        .reading-output {
            padding: 3rem 4rem; /* Add padding for better reading experience */
            font-size: 1.15rem;
            text-align: justify;
        }
        .reading-container {
            max-width: 1000px; /* Constrain content width for comfortable reading */
            margin: 0 auto;
        }
        .reading-output p {
            margin-bottom: 1.5rem;
        }
        .reading-header {
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 1.5rem;
            margin-bottom: 2rem;
        }
        /* IMPORTANT: Add padding-bottom to the main reading area to prevent the fixed footer from obscuring content */
        #reading-interface {
            padding-bottom: 7rem; 
        }

        .modal {
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50;
        }
        .novel-card {
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: border-color 0.3s, background-color 0.3s;
        }
        .novel-card.selected {
            border-color: #4a7c59;
            background-color: #f0f9ff;
        }
    </style>
     <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="p-4 sm:p-6 md:p-8 min-h-screen flex flex-col">
    <div class="max-w-7xl mx-auto w-full flex-grow flex flex-col gap-8" id="editing-interface">
        <header class="text-center">
            <h1 class="text-4xl font-bold text-[#3e684b]">Kh√¥ng gian D·ªãch thu·∫≠t H√°n Vi·ªát (Firebase Active)</h1>
            <p class="mt-2 text-lg text-gray-600">Qu·∫£n l√Ω nhi·ªÅu b·ªô truy·ªán, AI h·ªó tr·ª£ v√† l∆∞u tr·ªØ b·ªÅn v·ªØng.</p>
             <div id="auth-status" class="text-sm font-semibold mt-2 text-red-500">ƒêang kh·ªüi t·∫°o Firebase...</div>
        </header>

        <!-- TOP ROW: CONFIGURATION (Novel Management & Settings) -->
        <div id="config-row" class="grid grid-cols-1 md:grid-cols-2 gap-8 flex-shrink-0">
            
            <!-- Novel Management System -->
            <div class="card p-6">
                <button id="novel-manager-toggle" class="w-full text-left font-bold text-xl text-red-500 flex justify-between items-center py-2">
                    <span>üìñ Qu·∫£n l√Ω Truy·ªán ƒê√£ L∆∞u</span>
                    <span id="novel-manager-toggle-icon">‚ñº</span>
                </button>
                <div id="novel-manager-content" class="mt-4 space-y-4 hidden">
                    <p class="text-sm text-gray-600 font-semibold">T·∫£i l√™n t·ªáp (.txt) m·ªõi ho·∫∑c ch·ªçn truy·ªán ƒë√£ l∆∞u.</p>
                    
                    <div class="flex space-x-2 items-center">
                        <input type="file" id="book-file-input" accept=".txt" class="hidden">
                        <label for="book-file-input" id="book-file-label" class="cursor-pointer btn btn-primary py-2 px-4 rounded-md text-sm whitespace-nowrap">T·∫£i L√™n Truy·ªán M·ªõi</label>
                         <button id="load-novels-btn" class="btn btn-secondary py-2 px-4 rounded-md text-sm whitespace-nowrap">T·∫£i danh s√°ch truy·ªán</button>
                    </div>
                    <div id="novel-list-status" class="text-sm mt-2"></div>

                    <div id="novel-list-container" class="mt-4 border border-gray-200 rounded-md p-3 max-h-48 overflow-y-auto hidden">
                        <h4 class="font-semibold mb-2">Truy·ªán C·ªßa B·∫°n (<span id="novel-count">0</span>)</h4>
                        <ul id="novels-ul" class="space-y-2">
                            <li class="text-gray-500 text-sm">Ch∆∞a c√≥ truy·ªán n√†o ƒë∆∞·ª£c t·∫£i.</li>
                        </ul>
                    </div>
                    
                     <div id="chapter-navigator" class="mt-4 border border-gray-200 rounded-md p-3 max-h-48 overflow-y-auto hidden">
                        <h4 class="font-semibold mb-2">B·ªô ƒëi·ªÅu h∆∞·ªõng Ch∆∞∆°ng (<span id="chapter-count">0</span>)</h4>
                        <button id="extract-chapters-btn" class="btn btn-ai w-full font-bold py-2 px-4 rounded-md text-sm flex items-center justify-center relative mb-2" disabled>
                            <span id="extract-loading-spinner" class="spinner mr-2 w-4 h-4 border-white hidden"></span>
                            ‚ú® AI Ph√¢n t√≠ch & Tr√≠ch xu·∫•t Ch∆∞∆°ng
                        </button>
                        <ul id="chapters-ul" class="space-y-1">
                            <li class="text-gray-500 text-sm">Ch·ªçn truy·ªán ƒë·ªÉ ph√¢n t√≠ch.</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Settings Card -->
            <div class="card p-6">
                <button id="settings-toggle" class="w-full text-left font-bold text-xl text-[#8c52ff] flex justify-between items-center py-2">
                    <span>‚öôÔ∏è C√†i ƒë·∫∑t N√¢ng cao (API & Prompt)</span>
                    <span id="toggle-icon">‚ñº</span>
                </button>
                <div id="advanced-settings" class="mt-4 space-y-4 hidden">
                     <!-- Reading Style Settings REMOVED FROM HERE, MOVED TO MODAL -->
                    
                    <div class="h-px bg-gray-200 my-4"></div>

                     <!-- New Chunk Size Setting -->
                    <div class="space-y-2">
                        <h3 class="font-semibold text-base text-gray-700">T·ªëi ∆∞u T·ªëc ƒë·ªô D·ªãch AI (Chunking)</h3>
                        <label for="translation-chunk-size" class="block text-sm font-medium text-gray-700">K√≠ch th∆∞·ªõc ƒëo·∫°n d·ªãch (k√Ω t·ª±):</label>
                        <input type="number" id="translation-chunk-size" min="1000" max="6000" step="100" class="w-full p-2 rounded-md text-sm" value="3000">
                        <p class="text-xs text-gray-500">Gi·∫£m k√≠ch th∆∞·ªõc ƒëo·∫°n d·ªãch ƒë·ªÉ tƒÉng t·ªëc ƒë·ªô (nh∆∞ng c√≥ th·ªÉ gi·∫£m ng·ªØ c·∫£nh). Khuy·∫øn ngh·ªã: 2000 - 4000.</p>
                    </div>
                    <div class="h-px bg-gray-200 my-4"></div>
                    
                    <!-- API Key Management Section -->
                    <div class="space-y-2">
                        <h3 class="font-semibold text-base text-gray-700 flex justify-between items-center">
                            Qu·∫£n l√Ω API Keys
                            <span id="key-count" class="text-sm bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full">0 Kh√≥a</span>
                        </h3>
                        <div class="flex space-x-2">
                            <input type="text" id="new-api-key-input" placeholder="Nh·∫≠p kh√≥a API m·ªõi..." class="flex-1 p-2 rounded-md text-sm">
                            <button id="add-api-key-btn" class="btn btn-primary py-2 px-4 rounded-md text-sm">Th√™m Kh√≥a</button>
                        </div>
                        <div id="api-key-list" class="space-y-2 max-h-32 overflow-y-auto pr-1 border border-gray-100 p-2 rounded-md">
                            <!-- Key list will be rendered here -->
                            <p class="text-xs text-gray-400">Kh√≥a s·∫Ω ƒë∆∞·ª£c l∆∞u trong tr√¨nh duy·ªát.</p>
                        </div>
                        <p class="text-xs text-gray-500">·ª®ng d·ª•ng s·∫Ω t·ª± ƒë·ªông xoay v√≤ng c√°c kh√≥a khi c√≥ l·ªói.</p>
                    </div>
                    <!-- End API Key Management Section -->

                    <div class="h-px bg-gray-200 my-4"></div>

                    <div class="space-y-2">
                        <label for="custom-prompt" class="block text-sm font-medium text-gray-700">Custom Prompt (Cho AI D·ªãch Ho√†n Ch·ªânh)</label>
                        <textarea id="custom-prompt" rows="3" class="w-full p-2 rounded-md" placeholder="V√≠ d·ª•: D·ªãch m∆∞·ª£t m√† theo phong c√°ch truy·ªán c·ªï trang..."></textarea>
                        <p class="text-xs text-gray-500">Thay ƒë·ªïi vai tr√≤ v√† phong c√°ch d·ªãch c·ªßa AI.</p>
                    </div>

                    <div class="h-px bg-gray-200 my-4"></div>
                    
                    <h3 class="text-lg font-semibold mb-3">T·∫£i l√™n T·ª´ ƒëi·ªÉn (H√†ng lo·∫°t)</h3>
                    <p class="text-sm text-gray-600 mb-2">ƒê·ªãnh d·∫°ng t·ªáp: TXT ho·∫∑c CSV. M·ªói d√≤ng l√† m·ªôt c·∫∑p **H√°n t·ª±,Nghƒ©a Vi·ªát**.</p>
                    <div class="flex space-x-2 items-center">
                        <input type="file" id="dictionary-file-input" accept=".txt, .csv" class="hidden">
                        <label for="dictionary-file-input" class="cursor-pointer btn btn-secondary py-2 px-4 rounded-md text-sm">Ch·ªçn T·ªáp...</label>
                        <button id="upload-dictionary-btn" class="btn btn-primary py-2 px-4 rounded-md text-sm" disabled>T·∫£i & Th√™m</button>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                         <div id="upload-status" class="text-sm"></div>
                         <button id="download-dictionary-btn" class="btn btn-secondary py-1 px-3 rounded-md text-xs">T·∫£i xu·ªëng T·ª´ ƒëi·ªÉn</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MIDDLE ROW: WORKING AREA (Substitutions, Dictionary, and Input) -->
        <div id="working-row" class="grid grid-cols-1 lg:grid-cols-2 gap-8 flex-shrink-0">
            
            <!-- LEFT COLUMN: SUBSTITUTION & PERMANENT DICTIONARY -->
            <div id="left-column" class="flex flex-col space-y-8">
                
                <!-- Runtime Substitution & Post-Substitution Card -->
                <div class="card p-6 flex-shrink-0">
                    <h2 class="text-2xl font-bold mb-4 text-[#4a7c59]">üîß Tinh ch·ªânh T·ª´ v·ª±ng & H·∫≠u k·ª≥</h2>
                    
                    <!-- H√°n -> Vi·ªát Substitution Override -->
                    <h3 class="font-bold text-lg text-gray-700 mb-3 border-b pb-2">1. H√°n -> Vi·ªát (∆Øu ti√™n, T·∫°m th·ªùi)</h3>
                    <p class="text-sm text-gray-600 mb-3">Th√™m nhi·ªÅu c·∫∑p r·ªìi nh·∫•n "√Åp d·ª•ng & D·ªãch l·∫°i" 1 l·∫ßn.</p>
                    <div class="space-y-4 mb-4">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label for="han-replace" class="block text-sm font-medium text-gray-700 mb-1">H√°n t·ª± (C·∫ßn thay th·∫ø)</label>
                                <input type="text" id="han-replace" placeholder="Êàë" class="w-full p-2 rounded-md text-sm">
                            </div>
                            <div>
                                <label for="viet-new-value" class="block text-sm font-medium text-gray-700 mb-1">Nghƒ©a Vi·ªát (M·ªöI)</label>
                                <input type="text" id="viet-new-value" placeholder="ta / t√¥i" class="w-full p-2 rounded-md text-sm">
                            </div>
                        </div>
                        <button id="add-runtime-substitution-btn" class="btn btn-secondary w-full font-bold py-2 px-4 rounded-md text-sm">
                            + Th√™m v√†o danh s√°ch t·∫°m
                        </button>
                    </div>
                    
                    <div id="runtime-substitution-list" class="space-y-2 max-h-36 overflow-y-auto pr-2 mb-6 border border-yellow-200 p-2 rounded-md bg-yellow-50">
                         <p class="text-gray-500 text-sm">Ch∆∞a c√≥ c·∫∑p H√°n -> Vi·ªát t·∫°m th·ªùi.</p>
                    </div>

                    <!-- NEW: Vi·ªát -> Vi·ªát Post-Substitution -->
                    <h3 class="font-bold text-lg text-gray-700 mb-3 border-b pb-2">2. Vi·ªát -> Vi·ªát (H·∫≠u k·ª≥, Vƒ©nh vi·ªÖn)</h3>
                     <p class="text-sm text-gray-600 mb-3">M·ªçi thay ƒë·ªïi ƒë·ªÅu ƒë∆∞·ª£c **l∆∞u vƒ©nh vi·ªÖn** v√† d√πng cho c√°c ch∆∞∆°ng/s√°ch kh√°c. Th√™m nhi·ªÅu c·∫∑p r·ªìi nh·∫•n "√Åp d·ª•ng & D·ªãch l·∫°i" 1 l·∫ßn.</p>
                    <div class="space-y-4 mb-4">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label for="viet-old-post" class="block text-sm font-medium text-gray-700 mb-1">C·ª•m t·ª´ Vi·ªát C≈® (ƒê√£ d·ªãch)</label>
                                <input type="text" id="viet-old-post" placeholder="√°o b√†o r·ªìng" class="w-full p-2 rounded-md text-sm">
                            </div>
                            <div>
                                <label for="viet-new-post" class="block text-sm font-medium text-gray-700 mb-1">C·ª•m t·ª´ Vi·ªát M·ªöI (Tinh ch·ªânh)</label>
                                <input type="text" id="viet-new-post" placeholder="√°o long b√†o" class="w-full p-2 rounded-md text-sm">
                            </div>
                        </div>
                        <button id="add-post-substitution-btn" class="btn btn-secondary w-full font-bold py-2 px-4 rounded-md text-sm">
                            + Th√™m v√†o danh s√°ch vƒ©nh vi·ªÖn
                        </button>
                    </div>
                    
                    <div id="post-substitution-list" class="space-y-2 max-h-36 overflow-y-auto pr-2 border border-blue-200 p-2 rounded-md post-sub-item mb-4">
                        <p class="text-gray-500 text-sm">Ch∆∞a c√≥ c·∫∑p Vi·ªát -> Vi·ªát vƒ©nh vi·ªÖn.</p>
                    </div>
                     <button id="apply-all-substitution-btn" class="btn btn-ai w-full font-bold py-2 px-4 rounded-md text-lg">
                        √Åp d·ª•ng & D·ªãch l·∫°i (Batch)
                    </button>
                </div>

                <div class="card p-6 flex-grow">
                    <h2 class="text-2xl font-bold mb-4 text-[#3e684b]">T·ª´ ƒëi·ªÉn c·ªßa b·∫°n (Vƒ©nh Vi·ªÖn)</h2>
                    <div class="space-y-4 mb-6">
                        <div>
                            <label for="han-input" class="block text-sm font-medium text-gray-700 mb-1">T·ª´ H√°n</label>
                            <input type="text" id="han-input" placeholder="‰Ω†Â•Ω" class="w-full p-2 rounded-md">
                        </div>
                        <div>
                            <label for="viet-input" class="block text-sm font-medium text-gray-700 mb-1">Nghƒ©a Vi·ªát</label>
                            <input type="text" id="viet-input" placeholder="N«ê h«éo / Xin ch√†o" class="w-full p-2 rounded-md">
                        </div>
                        <div class="flex space-x-2">
                            <button id="add-word-btn" class="flex-1 btn btn-primary font-bold py-2 px-4 rounded-md">Th√™m v√†o t·ª´ ƒëi·ªÉn</button>
                            <button id="ai-explain-btn" class="btn btn-ai font-bold py-2 px-4 rounded-md text-sm whitespace-nowrap flex items-center justify-center">
                                ‚ú® Ph√¢n T√≠ch
                            </button>
                        </div>
                        <div id="han-explain-output" class="text-sm bg-indigo-50 p-3 rounded-md hidden"></div>
                    </div>
                    
                    <div class="h-px bg-gray-200 my-6"></div>

                    <h3 class="text-lg font-semibold mb-3">C√°c t·ª´ ƒë√£ l∆∞u (Vƒ©nh Vi·ªÖn)</h3>
                    <div id="dictionary-list" class="space-y-2 max-h-72 overflow-y-auto pr-2">
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: INPUT AREA -->
            <div id="right-column" class="card p-6 flex flex-col space-y-4">
                 <h2 class="text-2xl font-bold text-[#3e684b] flex-shrink-0">C√¥ng c·ª• D·ªãch</h2>
                <div class="flex-grow flex flex-col space-y-4">
                    <label for="chinese-input" id="chinese-input-label" class="block text-lg font-medium text-gray-700 mb-2 flex-shrink-0">VƒÉn b·∫£n ti·∫øng Trung (Vui l√≤ng ch·ªçn truy·ªán ƒë·ªÉ b·∫Øt ƒë·∫ßu):</label>
                    <textarea id="chinese-input" rows="18" class="w-full p-3 rounded-md text-base flex-grow" placeholder="N·ªôi dung ch∆∞∆°ng s·∫Ω ƒë∆∞·ª£c t·∫£i t·ª± ƒë·ªông v√†o ƒë√¢y..."></textarea>
                </div>
                 <!-- H√°n Vi·ªát / Clear Buttons -->
                <div class="flex items-center space-x-4 mb-6 flex-shrink-0">
                    <button id="translate-btn" class="flex-1 btn btn-primary font-bold py-3 px-4 rounded-md text-lg flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m4 13l4-4M19 17v-2m-4-2l-4 4m-5-4v2m4-2l-4 4M3 11h12M9 9v2m4 7h.01M12 3h.01M3 21h18M3 17h.01M9 21v-2m4 2v-2m4-2v2m-4-2h.01M15 9h.01M12 9h.01M9 5h.01M12 5h.01M15 5h.01M3 5h.01M3 9h.01" /></svg>
                        D·ªãch sang H√°n Vi·ªát
                    </button>
                    <button id="clear-btn" class="btn btn-secondary font-bold py-3 px-4 rounded-md flex-shrink-0">X√≥a</button>
                </div>
            </div>
        </div>
        
        <!-- BOTTOM ROW: FULL-WIDTH OUTPUT & AI CONTROLS (MAXIMIZED READING SPACE) -->
        <div id="output-row" class="card p-6 flex flex-col flex-grow">
            
            <label for="vietnamese-output" class="block text-lg font-medium text-gray-700 mb-2 flex-shrink-0">K·∫øt qu·∫£ H√°n Vi·ªát (v√† AI):</label>
            
            <!-- Output Area (Flex-grow to fill remaining vertical space) -->
            <div id="vietnamese-output" class="w-full p-3 rounded-md bg-gray-50 overflow-y-auto border border-gray-200 text-gray-800 flex-grow min-h-[50vh]">
                <p class="text-gray-400">K·∫øt qu·∫£ d·ªãch s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y...</p>
            </div>

            <!-- AI Features and Navigation (PUSHED TO BOTTOM) -->
            <div id="ai-feature-area" class="mt-6 pt-4 border-t border-gray-100 flex flex-col space-y-4 flex-shrink-0">
                <button id="ai-translate-btn" class="w-full btn btn-ai font-bold py-3 px-4 rounded-md text-lg flex items-center justify-center relative">
                    <span id="ai-loading-spinner" class="spinner mr-2 hidden"></span>
                    ‚ú® AI D·ªãch Ho√†n Ch·ªânh & Tr√¥i Ch·∫£y
                </button>
                 <div id="ai-progress-area" class="hidden">
                    <p id="ai-progress-text" class="text-sm text-gray-600 text-center"></p>
                    <div class="progress-bar">
                        <div id="ai-progress-indicator" class="progress-indicator" style="width: 0%;"></div>
                    </div>
                </div>
                <button id="next-chapter-btn" class="w-full btn btn-secondary font-bold py-3 px-4 rounded-md text-lg flex items-center justify-center relative hidden" disabled>
                    Ti·∫øp t·ª•c: D·ªãch Ch∆∞∆°ng <span id="next-chapter-title" class="ml-2 font-extrabold text-[#4a7c59]">...</span>
                </button>
            </div>
        </div>

    </div>

    <!-- NEW: READING MODE INTERFACE (Hidden by default) -->
    <div id="reading-interface" class="hidden p-4 sm:p-6 md:p-10 min-h-screen flex flex-col transition-opacity duration-300">
        <header class="reading-container reading-header flex justify-between items-center flex-shrink-0">
            <button id="back-to-editor-btn" class="btn btn-secondary py-2 px-4 rounded-full text-sm font-bold flex items-center">
                &larr; Tr·ªü l·∫°i Bi√™n t·∫≠p
            </button>
            <h1 id="reading-chapter-title" class="text-2xl font-extrabold text-[#3e684b] text-center flex-grow">
                [T√™n Ch∆∞∆°ng]
            </h1>
            <!-- Navigation removed from header and moved to fixed footer -->
        </header>

        <main id="reading-content-area" class="flex-grow overflow-y-auto reading-container reading-output">
            <!-- Translated content will be injected here -->
        </main>
    </div>

    <!-- FIXED FOOTER (Taskbar) for Reading Mode -->
    <footer id="reading-footer" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-2xl p-4 hidden z-40">
        <div class="reading-container flex items-center justify-between space-x-4">
            
            <!-- Chapter Navigation -->
            <div class="flex space-x-2">
                <button id="prev-chapter-reading-btn" class="btn btn-secondary py-2 px-3 rounded-full flex items-center" title="Ch∆∞∆°ng tr∆∞·ªõc">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12h8" /></svg>
                </button>
                <button id="next-chapter-reading-btn" class="btn btn-secondary py-2 px-3 rounded-full flex items-center" title="Ch∆∞∆°ng k·∫ø ti·∫øp">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 9l3 3m0 0l-3 3m3-3H6M21 12h-8" /></svg>
                </button>
            </div>

            <!-- Main Status and Tools -->
            <div class="flex items-center space-x-4 flex-grow justify-center">
                
                <!-- Status Bar -->
                <div id="reading-status" class="text-sm text-gray-500 font-semibold italic flex-grow text-center min-w-[200px]">
                    S·∫µn s√†ng ƒë·ªçc.
                </div>

                <!-- Tools -->
                <button id="download-chapter-btn" class="btn btn-primary py-2 px-4 rounded-md text-sm font-bold hidden">
                    T·∫£i Ch∆∞∆°ng
                </button>
                <button id="download-novel-btn" class="btn btn-primary py-2 px-4 rounded-md text-sm font-bold hidden">
                    T·∫£i To√†n b·ªô
                </button>
                <button id="open-contents-btn" class="btn btn-primary py-2 px-4 rounded-md text-sm font-bold">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" /></svg>
                    M·ª•c l·ª•c
                </button>
                <button id="open-post-sub-btn" class="btn btn-secondary py-2 px-4 rounded-md text-sm font-bold">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
                    Tinh ch·ªânh (V->V)
                </button>
                 <button id="open-style-btn" class="btn btn-secondary py-2 px-4 rounded-md text-sm font-bold">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2H7m4 0v-4" /></svg>
                    T√πy ch·ªânh ƒê·ªçc
                </button>
                <button id="retranslate-btn" class="btn btn-ai py-2 px-4 rounded-md text-sm font-bold flex items-center justify-center relative">
                     <span id="retranslate-spinner" class="spinner mr-2 w-4 h-4 border-white hidden"></span>
                    D·ªãch l·∫°i (AI)
                </button>
            </div>

        </div>
    </footer>


    <!-- Modal for Chapter Contents -->
    <div id="contents-modal" class="modal fixed inset-0 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 max-h-[80vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4 flex justify-between items-center">
                M·ª•c l·ª•c Ch∆∞∆°ng
                <button class="text-gray-500 hover:text-gray-800" id="close-contents-modal">&times;</button>
            </h3>
            <ul id="modal-chapters-list" class="space-y-1">
                <!-- Chapter list will be dynamically rendered here -->
            </ul>
        </div>
    </div>
    
    <!-- Modal for Post-Substitutions (Viet -> Viet) -->
    <div id="post-sub-modal" class="modal fixed inset-0 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 max-h-[80vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4 flex justify-between items-center text-[#4a7c59]">
                Tinh ch·ªânh Thu·∫≠t ng·ªØ (Viet -> Viet)
                <button class="text-gray-500 hover:text-gray-800" id="close-post-sub-modal">&times;</button>
            </h3>
            <p class="text-sm text-gray-600 mb-4">Th√™m c√°c c·∫∑p Vi·ªát C≈© -> Vi·ªát M·ªõi ƒë·ªÉ th·ªëng nh·∫•t thu·∫≠t ng·ªØ. M·ªçi thay ƒë·ªïi s·∫Ω ƒë∆∞·ª£c **l∆∞u vƒ©nh vi·ªÖn**.</p>
            <div id="modal-post-sub-controls" class="space-y-4 mb-4">
                 <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label for="modal-viet-old-post" class="block text-sm font-medium text-gray-700 mb-1">C·ª•m t·ª´ Vi·ªát C≈®</label>
                        <input type="text" id="modal-viet-old-post" placeholder="√°o b√†o r·ªìng" class="w-full p-2 rounded-md text-sm">
                    </div>
                    <div>
                        <label for="modal-viet-new-post" class="block text-sm font-medium text-gray-700 mb-1">C·ª•m t·ª´ Vi·ªát M·ªöI</label>
                        <input type="text" id="modal-viet-new-post" placeholder="√°o long b√†o" class="w-full p-2 rounded-md text-sm">
                    </div>
                </div>
                <button id="add-modal-post-sub-btn" class="btn btn-primary w-full font-bold py-2 px-4 rounded-md text-sm">
                    + Th√™m c·∫∑p Vi·ªát -> Vi·ªát
                </button>
            </div>
            
            <h4 class="font-semibold mt-6 mb-2">Danh s√°ch c√°c c·∫∑p ƒë√£ l∆∞u:</h4>
            <div id="modal-post-sub-list" class="space-y-2 border border-blue-200 p-2 rounded-md post-sub-item">
                <!-- Post substitution list will be rendered here -->
            </div>
            
        </div>
    </div>
    
     <!-- Modal for Reading Style Settings (NEW) -->
    <div id="style-settings-modal" class="modal fixed inset-0 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
            <h3 class="text-2xl font-bold mb-4 flex justify-between items-center text-[#8c52ff]">
                ‚öôÔ∏è T√πy ch·ªânh Giao di·ªán ƒê·ªçc
                <button class="text-gray-500 hover:text-gray-800" id="close-style-modal">&times;</button>
            </h3>
            <p class="text-sm text-gray-600 mb-4">Thay ƒë·ªïi s·∫Ω ƒë∆∞·ª£c √°p d·ª•ng v√† l∆∞u vƒ©nh vi·ªÖn ngay l·∫≠p t·ª©c.</p>
             <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="modal-font-size" class="block text-sm font-medium text-gray-700">C·ª° ch·ªØ (px)</label>
                        <input type="number" id="modal-font-size" min="14" max="30" class="w-full p-2 rounded-md text-sm">
                    </div>
                    <div>
                        <label for="modal-line-height" class="block text-sm font-medium text-gray-700">Chi·ªÅu cao d√≤ng (em)</label>
                        <input type="number" id="modal-line-height" min="1.0" max="2.5" step="0.1" class="w-full p-2 rounded-md text-sm">
                    </div>
                    <div>
                        <label for="modal-bg-color" class="block text-sm font-medium text-gray-700">M√†u n·ªÅn (Background)</label>
                        <input type="color" id="modal-bg-color" class="w-full p-1 rounded-md h-10">
                    </div>
                    <div>
                        <label for="modal-text-color" class="block text-sm font-medium text-gray-700">M√†u ch·ªØ (Text Color)</label>
                        <input type="color" id="modal-text-color" class="w-full p-1 rounded-md h-10">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Novel Metadata Input (NEW) -->
    <div id="novel-metadata-modal" class="modal fixed inset-0 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
            <h3 class="text-2xl font-bold mb-4 text-[#4a7c59]">Nh·∫≠p Th√¥ng tin Truy·ªán M·ªõi</h3>
            <p class="text-sm text-gray-600 mb-4">Vui l√≤ng nh·∫≠p th√¥ng tin ƒë·ªÉ l∆∞u truy·ªán v√†o c∆° s·ªü d·ªØ li·ªáu.</p>
            <div class="space-y-4">
                <div>
                    <label for="novel-title-input" class="block text-sm font-medium text-gray-700">T√™n Truy·ªán</label>
                    <input type="text" id="novel-title-input" placeholder="T√™n truy·ªán..." class="w-full p-2 rounded-md">
                </div>
                <div>
                    <label for="novel-author-input" class="block text-sm font-medium text-gray-700">T√™n T√°c gi·∫£</label>
                    <input type="text" id="novel-author-input" placeholder="T√°c gi·∫£..." class="w-full p-2 rounded-md">
                </div>
                <div>
                    <label for="novel-synopsis-input" class="block text-sm font-medium text-gray-700">Gi·ªõi thi·ªáu (T√≥m t·∫Øt)</label>
                    <textarea id="novel-synopsis-input" rows="3" placeholder="T√≥m t·∫Øt ng·∫Øn v·ªÅ n·ªôi dung..." class="w-full p-2 rounded-md"></textarea>
                </div>
                <button id="save-novel-metadata-btn" class="btn btn-ai w-full font-bold py-2 px-4 rounded-md flex items-center justify-center">
                    <span id="metadata-spinner" class="spinner mr-2 w-4 h-4 border-white hidden"></span>
                    L∆∞u & B·∫Øt ƒë·∫ßu Ph√¢n t√≠ch Ch∆∞∆°ng
                </button>
                <button id="cancel-novel-metadata-btn" class="btn btn-secondary w-full py-2 px-4 rounded-md mt-2">H·ªßy b·ªè</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- FIREBASE INITIALIZATION & UTILITIES ---
        let db;
        let auth;
        let appId;
        let userId;
        const AUTH_STATUS = document.getElementById('auth-status');

        function getNovelCollectionRef() {
            return collection(db, `artifacts/${appId}/public/data/novels`);
        }
        function getChapterCollectionRef(novelId) {
            return collection(db, `artifacts/${appId}/public/data/novels/${novelId}/chapters`);
        }

        async function initFirebase() {
            try {
                // Ki·ªÉm tra s·ª± t·ªìn t·∫°i c·ªßa bi·∫øn to√†n c·ª•c (S·ª≠ d·ª•ng trong m√¥i tr∆∞·ªùng Canvas)
                if (typeof __app_id === 'undefined' || typeof __firebase_config === 'undefined' || typeof __initial_auth_token === 'undefined') {
                    AUTH_STATUS.textContent = 'C·∫¢NH B√ÅO: Kh√¥ng t√¨m th·∫•y c·∫•u h√¨nh Firebase. D·ªØ li·ªáu truy·ªán s·∫Ω KH√îNG ƒë∆∞·ª£c l∆∞u tr·ªØ b·ªÅn v·ªØng.';
                    AUTH_STATUS.classList.replace('text-red-500', 'text-yellow-600');
                    // Kh√¥ng kh·ªüi t·∫°o Firebase
                    return;
                }
                
                appId = __app_id;
                const firebaseConfig = JSON.parse(__firebase_config);
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // ƒêƒÉng nh·∫≠p / X√°c th·ª±c
                if (__initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || crypto.randomUUID();
                
                AUTH_STATUS.textContent = `ƒê√£ k·∫øt n·ªëi v·ªõi Firebase. ID ng∆∞·ªùi d√πng: ${userId.substring(0, 8)}...`;
                AUTH_STATUS.classList.replace('text-red-500', 'text-green-600');

                // T·∫£i danh s√°ch truy·ªán sau khi x√°c th·ª±c
                loadNovels();

            } catch (error) {
                console.error("L·ªói kh·ªüi t·∫°o ho·∫∑c x√°c th·ª±c Firebase:", error);
                AUTH_STATUS.textContent = 'L·ªñI KH·ªûI T·∫†O FIREBASE: ' + error.message;
                AUTH_STATUS.classList.replace('text-red-500', 'text-red-700');
            }
        }
        
        // --- NOVEL MANAGEMENT LOGIC (Firestore) ---
        
        // State
        let selectedNovel = null; 
        let novels = []; 
        
        // DOM elements (re-defined inside module script for scope)
        const novelListUl = document.getElementById('novels-ul');
        const novelListStatus = document.getElementById('novel-list-status');
        const novelListContainer = document.getElementById('novel-list-container');
        const novelCountSpan = document.getElementById('novel-count');
        const chaptersUl = document.getElementById('chapters-ul');
        const chapterNavigator = document.getElementById('chapter-navigator');
        const bookFileInput = document.getElementById('book-file-input');
        const bookFileLabel = document.getElementById('book-file-label');
        const novelMetadataModal = document.getElementById('novel-metadata-modal');
        const novelTitleInput = document.getElementById('novel-title-input');
        const novelAuthorInput = document.getElementById('novel-author-input');
        const novelSynopsisInput = document.getElementById('novel-synopsis-input');
        const saveNovelMetadataBtn = document.getElementById('save-novel-metadata-btn');
        const cancelNovelMetadataBtn = document.getElementById('cancel-novel-metadata-btn');
        const metadataSpinner = document.getElementById('metadata-spinner');
        const loadNovelsBtn = document.getElementById('load-novels-btn');
        const novelManagerContent = document.getElementById('novel-manager-content');
        const extractChaptersBtn = document.getElementById('extract-chapters-btn');
        const extractLoadingSpinner = document.getElementById('extract-loading-spinner');
        const chineseInputLabel = document.getElementById('chinese-input-label');
        const chineseInput = document.getElementById('chinese-input');
        const aiTranslateBtn = document.getElementById('ai-translate-btn');
        const nextChapterBtn = document.getElementById('next-chapter-btn');
        const chaptersUlEditing = document.getElementById('chapters-ul');
        
        // Global variables used by other functions in the main script block
        window.selectedNovel = selectedNovel;
        window.chapterList = [];
        window.currentChapterIndex = -1;
        window.rawBookContent = '';

        // --- Core Functions for Novel Management ---

        async function loadNovels() {
            if (!db) return;
            novelListStatus.className = 'text-gray-500 text-sm mt-2';
            novelListStatus.textContent = 'ƒêang t·∫£i danh s√°ch truy·ªán...';
            loadNovelsBtn.disabled = true;

            try {
                const novelsRef = getNovelCollectionRef();
                const q = query(novelsRef);
                const querySnapshot = await getDocs(q);
                
                novels = [];
                querySnapshot.forEach(doc => {
                    novels.push({ id: doc.id, ...doc.data() });
                });
                
                renderNovelList();
                novelListStatus.textContent = `T·∫£i truy·ªán th√†nh c√¥ng! (${novels.length} b·ªô)`;
                
            } catch (error) {
                console.error("L·ªói t·∫£i danh s√°ch truy·ªán:", error);
                novelListStatus.className = 'text-red-500 text-sm mt-2';
                novelListStatus.textContent = 'L·ªói t·∫£i truy·ªán: Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi Firebase.';
            } finally {
                loadNovelsBtn.disabled = false;
            }
        }

        function renderNovelList() {
            novelListUl.innerHTML = '';
            novelCountSpan.textContent = novels.length;
            novelListContainer.classList.remove('hidden');

            if (novels.length === 0) {
                novelListUl.innerHTML = '<li class="text-gray-500 text-sm">Ch∆∞a c√≥ truy·ªán n√†o ƒë∆∞·ª£c l∆∞u.</li>';
                return;
            }

            novels.forEach(novel => {
                const isSelected = selectedNovel && selectedNovel.id === novel.id;
                const li = document.createElement('li');
                li.className = `novel-card p-3 rounded-md ${isSelected ? 'selected' : ''}`;
                li.innerHTML = `
                    <h5 class="font-bold text-lg text-[#3e684b]">${novel.title}</h5>
                    <p class="text-sm text-gray-600">T√°c gi·∫£: ${novel.author || 'N/A'}</p>
                    <p class="text-xs text-gray-500 truncate mt-1">Ch∆∞∆°ng: ${novel.chapterList ? novel.chapterList.length : 0}</p>
                `;
                li.addEventListener('click', () => selectNovel(novel.id));
                novelListUl.appendChild(li);
            });
        }
        
        async function selectNovel(novelId) {
            if (!db) return;

            const novel = novels.find(n => n.id === novelId);
            if (!novel) return;
            
            novelListStatus.className = 'text-gray-500 text-sm mt-2';
            novelListStatus.textContent = `ƒêang t·∫£i n·ªôi dung truy·ªán "${novel.title}"...`;
            
            try {
                const novelDocRef = doc(getNovelCollectionRef(), novelId);
                const novelDoc = await getDoc(novelDocRef);
                
                if (!novelDoc.exists()) throw new Error("T√†i li·ªáu truy·ªán kh√¥ng t·ªìn t·∫°i.");

                selectedNovel = { id: novelDoc.id, ...novelDoc.data() };
                window.selectedNovel = selectedNovel;
                
                window.rawBookContent = selectedNovel.rawContent;
                window.chapterList = selectedNovel.chapterList || [];
                
                chineseInputLabel.textContent = `VƒÉn b·∫£n ti·∫øng Trung: Truy·ªán ƒëang ch·ªçn - ${selectedNovel.title}`;
                chineseInput.value = 'Truy·ªán ƒë√£ ƒë∆∞·ª£c t·∫£i. Vui l√≤ng ch·ªçn ch∆∞∆°ng ho·∫∑c ph√¢n t√≠ch c·∫•u tr√∫c.';
                window.currentChapterIndex = -1;
                
                if (window.chapterList.length > 0) {
                    window.currentChapterIndex = 0;
                    window.renderChapterNavigator();
                    chapterNavigator.classList.remove('hidden');
                    // T·∫£i ch∆∞∆°ng 1
                    window.selectChapter(0, false); 
                } else {
                    // Ch∆∞a c√≥ c·∫•u tr√∫c ch∆∞∆°ng
                    chapterNavigator.classList.remove('hidden');
                    chaptersUlEditing.innerHTML = '<li class="text-red-500 text-sm">Ch∆∞a c√≥ c·∫•u tr√∫c ch∆∞∆°ng. B·∫•m "AI Ph√¢n t√≠ch..."</li>';
                    extractChaptersBtn.disabled = false;
                    aiTranslateBtn.classList.add('hidden'); // ·∫®n n√∫t AI d·ªãch v√¨ ch∆∞a c√≥ ch∆∞∆°ng
                    nextChapterBtn.classList.add('hidden');
                }
                
                novelListStatus.className = 'text-green-600 text-sm mt-2';
                novelListStatus.textContent = `ƒê√£ ch·ªçn truy·ªán: ${selectedNovel.title}.`;
                renderNovelList(); 

            } catch (error) {
                console.error("L·ªói ch·ªçn truy·ªán:", error);
                novelListStatus.className = 'text-red-500 text-sm mt-2';
                novelListStatus.textContent = `L·ªói t·∫£i n·ªôi dung truy·ªán: ${error.message}`;
            }
        }
        
        // T·∫£i n·ªôi dung ch∆∞∆°ng ƒë√£ d·ªãch (n·∫øu c√≥)
        async function loadChapterTranslation(chapterIndex) {
            if (!selectedNovel || !db) return null;
            
            const chapterDocId = `ch${String(chapterIndex + 1).padStart(4, '0')}`;
            const chapterDocRef = doc(getChapterCollectionRef(selectedNovel.id), chapterDocId);
            
            try {
                const chapterDoc = await getDoc(chapterDocRef);
                if (chapterDoc.exists()) {
                    return chapterDoc.data().translatedText;
                }
                return null;

            } catch (error) {
                console.error("L·ªói t·∫£i b·∫£n d·ªãch ch∆∞∆°ng:", error);
                return null;
            }
        }

        // L∆∞u n·ªôi dung ch∆∞∆°ng ƒë√£ d·ªãch
        async function saveChapterTranslation(chapterIndex, translatedText) {
            if (!selectedNovel || !db) return false;

            const chapter = window.chapterList[chapterIndex];
            if (!chapter) return false;

            const chapterDocId = `ch${String(chapterIndex + 1).padStart(4, '0')}`;
            const chapterDocRef = doc(getChapterCollectionRef(selectedNovel.id), chapterDocId);

            try {
                await setDoc(chapterDocRef, {
                    novelId: selectedNovel.id,
                    chapterIndex: chapterIndex,
                    originalTitle: chapter.title,
                    translatedTitle: chapter.translatedTitle,
                    translatedText: translatedText,
                    lastTranslatedAt: new Date().toISOString()
                }, { merge: true });

                console.log(`Ch∆∞∆°ng ${chapterIndex + 1} ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o Firestore.`);
                return true;
            } catch (error) {
                console.error("L·ªñI L∆ØU TR·ªÆ CH∆Ø∆†NG:", error);
                return false;
            }
        }
        
        // --- HANDLERS CHO METADATA MODAL (C·∫≠p nh·∫≠t Novel) ---
        
        extractChaptersBtn.addEventListener('click', () => {
             if (!window.rawBookContent) {
                alert("Vui l√≤ng t·∫£i l√™n ho·∫∑c ch·ªçn m·ªôt truy·ªán ƒë√£ l∆∞u.");
                return;
            }
            const contentForAI = window.rawBookContent.substring(0, window.MAX_AI_ANALYSIS_LENGTH);
            window.extractChapters(contentForAI);
        });

        // T·∫£i l√™n t·ªáp m·ªõi -> M·ªü modal
        bookFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            bookFileLabel.textContent = `T·ªáp: ${file.name}`;
            
            novelTitleInput.value = file.name.replace(/\.txt$/, '').trim();
            novelAuthorInput.value = '';
            novelSynopsisInput.value = '';
            window.showModal(novelMetadataModal);
        });

        cancelNovelMetadataBtn.addEventListener('click', () => {
            bookFileInput.value = ''; 
            bookFileLabel.textContent = 'T·∫£i L√™n Truy·ªán M·ªõi';
            window.hideModal(novelMetadataModal);
        });

        saveNovelMetadataBtn.addEventListener('click', async () => {
            const title = novelTitleInput.value.trim();
            const author = novelAuthorInput.value.trim();
            const synopsis = novelSynopsisInput.value.trim();
            const file = bookFileInput.files[0];

            if (!title || !file) {
                alert('Vui l√≤ng nh·∫≠p T√™n Truy·ªán.');
                return;
            }
            if (!db) {
                alert('L·ªñI: K·∫øt n·ªëi Firebase ch∆∞a s·∫µn s√†ng. Kh√¥ng th·ªÉ l∆∞u truy·ªán.');
                return;
            }
            
            metadataSpinner.classList.remove('hidden');
            saveNovelMetadataBtn.disabled = true;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const rawContent = e.target.result;

                if (rawContent.length > window.MAX_BOOK_CONTENT_LENGTH) {
                    alert(`T·ªáp qu√° l·ªõn (> ${window.MAX_BOOK_CONTENT_LENGTH / 1000000}MB).`);
                    return;
                }
                
                const novelId = Date.now().toString(); 
                const newNovel = {
                    id: novelId,
                    title,
                    author,
                    synopsis,
                    rawContent, 
                    chapterList: [], 
                    createdAt: new Date().toISOString()
                };

                const contentForAI = rawContent.substring(0, window.MAX_AI_ANALYSIS_LENGTH);
                let chapterListResult = [];

                try {
                    // Ph√¢n t√≠ch ch∆∞∆°ng
                    const response = await window.callGeminiAPI(window.CHAPTER_TITLE_PROMPT_SCHEMA, `Tr√≠ch xu·∫•t danh s√°ch ch∆∞∆°ng (title v√† startMarker) t·ª´ n·ªôi dung sau:\n\n${contentForAI}`, "application/json", window.chapterSchema);
                    
                    const result = JSON.parse(response.text); 
                    chapterListResult = result.chapters || [];

                    if (chapterListResult.length > 1) {
                        // D·ªãch ti√™u ƒë·ªÅ
                        const originalTitles = chapterListResult.map(c => c.title);
                        const translatedTitles = await window.translateChapterTitles(originalTitles);
                        chapterListResult.forEach((chapter, index) => {
                            chapter.translatedTitle = translatedTitles[index] || chapter.title;
                        });
                    }

                    newNovel.chapterList = chapterListResult;
                    
                    // L∆∞u Novel v√†o Firestore
                    const novelDocRef = doc(getNovelCollectionRef(), novelId);
                    await setDoc(novelDocRef, newNovel);
                    
                    // C·∫≠p nh·∫≠t UI v√† ch·ªçn truy·ªán m·ªõi
                    await loadNovels();
                    selectNovel(novelId);
                    
                    window.hideModal(novelMetadataModal);
                    
                } catch (error) {
                    console.error("L·ªói ph√¢n t√≠ch/l∆∞u:", error);
                    alert(`L·ªói khi ph√¢n t√≠ch ho·∫∑c l∆∞u truy·ªán: ${error.message}`);
                } finally {
                    metadataSpinner.classList.add('hidden');
                    saveNovelMetadataBtn.disabled = false;
                }
            };
            reader.readAsText(file);
        });

        // --- GHI ƒê√à CH·ª®C NƒÇNG V√Ä C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI TO√ÄN C·ª§C ---

        // Ghi ƒë√® selectChapter ƒë·ªÉ t√≠ch h·ª£p logic t·∫£i d·ªãch Firestore
        window.selectChapter = async function(index, autoScroll = true) { 
            if (index < 0 || index >= window.chapterList.length) return;
            window.currentChapterIndex = index;
            window.renderChapterNavigator();
            window.runtimeSubstitutions = []; 
            window.renderRuntimeSubstitutions();
            
            const chapterTitle = window.chapterList[index].translatedTitle || window.chapterList[index].title;
            
            chineseInputLabel.textContent = `VƒÉn b·∫£n ti·∫øng Trung: ƒêang t·∫£i n·ªôi dung ch∆∞∆°ng "${chapterTitle}"...`;
            chineseInput.value = "ƒêang t·∫£i n·ªôi dung...";
            
            // 1. Ki·ªÉm tra b·∫£n d·ªãch ƒë√£ l∆∞u tr√™n Firestore
            const savedTranslation = await loadChapterTranslation(index);

            if (savedTranslation) {
                // T·∫£i b·∫£n d·ªãch ƒë√£ l∆∞u
                window.lastAITranslationOutput = savedTranslation;
                window.lastTranslatedChineseInput = window.sliceChapterContent(index);
                chineseInput.value = window.lastTranslatedChineseInput;
                
                // Chuy·ªÉn th·∫≥ng sang Reading Mode
                window.toggleInterfaceMode('reading');
                window.showReadingStatus('T·∫£i b·∫£n d·ªãch ƒë√£ l∆∞u th√†nh c√¥ng!', false);
                
                // C·∫≠p nh·∫≠t UI
                aiTranslateBtn.classList.add('hidden'); // ·∫®n n√∫t AI d·ªãch
            } else {
                // 2. Kh√¥ng c√≥ b·∫£n d·ªãch l∆∞u, t·∫£i n·ªôi dung th√¥ ƒë·ªÉ b·∫Øt ƒë·∫ßu d·ªãch
                const content = window.sliceChapterContent(index);
                window.currentChapterContent = content; // L∆∞u n·ªôi dung th√¥ cho AI
                chineseInput.value = content;
                window.vietnameseOutput.innerHTML = '<p class="text-gray-400">K·∫øt qu·∫£ d·ªãch s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y...</p>';
                window.lastTranslatedChineseInput = ''; 
                window.lastAITranslationOutput = '';
                
                // Quay l·∫°i Editing Mode ƒë·ªÉ ng∆∞·ªùi d√πng b·∫•m D·ªãch
                if (window.isReadingMode) window.toggleInterfaceMode('editing');

                // T·ª± ƒë·ªông ch·∫°y H√°n Vi·ªát
                window.translateText(); 
                aiTranslateBtn.classList.remove('hidden'); // Hi·ªán n√∫t AI d·ªãch
            }
            
            window.updateNextChapterButton();
            if (autoScroll) {
                chineseInput.scrollIntoView({ behavior: 'smooth' });
                chineseInput.focus();
            }
        };

        // Ghi ƒë√® AI d·ªãch ƒë·ªÉ l∆∞u k·∫øt qu·∫£ v√†o Firestore
        window.originalFetchAITranslation_APP = window.fetchAITranslation;
        window.fetchAITranslation = async function() {
            const originalOutput = await window.originalFetchAITranslation_APP();

            if (window.lastAITranslationOutput && window.currentChapterIndex !== -1 && window.selectedNovel && db) {
                 const isSaved = await saveChapterTranslation(window.currentChapterIndex, window.lastAITranslationOutput);
                 if (isSaved) {
                    window.showReadingStatus('L∆∞u b·∫£n d·ªãch AI v√†o Firestore th√†nh c√¥ng!', false);
                 } else {
                    window.showReadingStatus('L·ªói: Kh√¥ng th·ªÉ l∆∞u b·∫£n d·ªãch v√†o Firestore!', true);
                 }
            }
            return originalOutput;
        };

        // G·∫Øn s·ª± ki·ªán Download
        const downloadChapterBtn = document.getElementById('download-chapter-btn');
        const downloadNovelBtn = document.getElementById('download-novel-btn');
        downloadChapterBtn.addEventListener('click', window.downloadCurrentChapter);
        downloadNovelBtn.addEventListener('click', window.downloadFullNovel);
        
        // C·∫≠p nh·∫≠t logic khi t·∫£i l√™n dictionary
        const downloadDictionaryBtn = document.getElementById('download-dictionary-btn');
        downloadDictionaryBtn.addEventListener('click', window.downloadDictionary);


        // Kh·ªüi t·∫°o Firebase
        initFirebase();
    </script>
</body>
</html>
