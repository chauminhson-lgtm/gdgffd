<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng c·ª• D·ªãch H√°n Vi·ªát</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chosen Palette: Scholarly Calm -->
    <!-- Application Structure Plan: The layout maintains two main columns. The AI error handling has been updated to remove the blocking 'alert()' and instead display a clear error message directly in the results pane, while automatically restoring the H√°n Vi·ªát translation (Manual/H√°n Vi·ªát result) for a smooth workflow continuation. -->
    <!-- Visualization & Content Choices: Report Info: Needs non-blocking error handling for full AI translation failure. -> Goal: Ensure continuous workflow despite API issues. -> Viz/Presentation Method: Error message box with clear explanation and red border inserted into the results area. -> Interaction: Failure of 'fetchAITranslation' triggers UI restore and error display, allowing user to continue. -> Justification: Improves UX by making failure non-blocking and informative. -> Library/Method: Vanilla JavaScript and Fetch API for Gemini calls. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fdfaf6;
            color: #4a4a4a;
        }
        .highlight {
            background-color: #ffe680;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 600;
            color: #333;
            line-height: 1.8;
            white-space: pre-wrap;
            display: inline-block;
        }
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        .card:hover {
             box-shadow: 0 8px 24px rgba(0,0,0,0.08);
        }
        .btn {
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .btn-primary {
            background-color: #4a7c59;
            color: white;
        }
        .btn-primary:hover {
            background-color: #3e684b;
        }
        .btn-secondary {
            background-color: #e0e0e0;
            color: #555;
        }
        .btn-secondary:hover {
            background-color: #d1d1d1;
        }
        .btn-ai {
            background-color: #8c52ff;
            color: white;
        }
        .btn-ai:hover {
            background-color: #7a46e1;
        }
        .btn-danger {
            background-color: #d9534f;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c9302c;
        }
        input[type="text"], textarea {
            border: 1px solid #e0e0e0;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        input[type="text"]:focus, textarea:focus {
            border-color: #4a7c59;
            box-shadow: 0 0 0 2px rgba(74, 124, 89, 0.2);
            outline: none;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .chapter-active {
            background-color: #e6e9f2;
            border-left: 4px solid #8c52ff;
        }
        .btn-promote {
            background-color: #10b981;
            color: white;
        }
        .btn-promote:hover {
            background-color: #059669;
        }
        .post-sub-item {
            background-color: #f0f9ff;
        }
    </style>
     <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="p-4 sm:p-6 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold text-[#3e684b]">Kh√¥ng gian D·ªãch thu·∫≠t H√°n Vi·ªát</h1>
            <p class="mt-2 text-lg text-gray-600">C·∫•u h√¨nh linh ho·∫°t, AI h·ªó tr·ª£ v√† t·ª´ ƒëi·ªÉn c√° nh√¢n h√≥a.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            
            <div class="lg:col-span-2 space-y-8">
                
                <!-- Book Upload & Chapter Analysis -->
                <div class="card p-6">
                    <button id="book-toggle" class="w-full text-left font-bold text-xl text-red-500 flex justify-between items-center py-2">
                        <span>üìö T·∫£i l√™n S√°ch & Ph√¢n t√≠ch Ch∆∞∆°ng</span>
                        <span id="book-toggle-icon">‚ñº</span>
                    </button>
                    <div id="book-analysis-content" class="mt-4 space-y-4 hidden">
                        <p class="text-sm text-gray-600 font-semibold">T·∫£i l√™n t·ªáp (.txt) ch·ª©a to√†n b·ªô n·ªôi dung truy·ªán ti·∫øng Trung.</p>
                        
                        <div class="flex space-x-2 items-center">
                            <input type="file" id="book-file-input" accept=".txt" class="hidden">
                            <label for="book-file-input" id="book-file-label" class="cursor-pointer btn btn-secondary py-2 px-4 rounded-md text-sm whitespace-nowrap">Ch·ªçn T·ªáp S√°ch...</label>
                            <button id="extract-chapters-btn" class="btn btn-ai w-full font-bold py-2 px-4 rounded-md text-sm flex items-center justify-center relative" disabled>
                                <span id="extract-loading-spinner" class="spinner mr-2 w-4 h-4 border-white hidden"></span>
                                ‚ú® AI Ph√¢n t√≠ch & Tr√≠ch xu·∫•t Ch∆∞∆°ng
                            </button>
                        </div>
                        <div id="book-status" class="text-sm mt-2"></div>

                        <div id="chapter-navigator" class="mt-4 border border-gray-200 rounded-md p-3 max-h-48 overflow-y-auto hidden">
                            <h4 class="font-semibold mb-2">B·ªô ƒëi·ªÅu h∆∞·ªõng Ch∆∞∆°ng (T·∫£i t·ª± ƒë·ªông)</h4>
                            <ul id="chapters-ul" class="space-y-1">
                                <li class="text-gray-500 text-sm">Ch∆∞a c√≥ ch∆∞∆°ng n√†o ƒë∆∞·ª£c tr√≠ch xu·∫•t.</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Runtime Substitution & Post-Substitution Card -->
                <div class="card p-6">
                    <h2 class="text-2xl font-bold mb-4 text-[#4a7c59]">üîß Tinh ch·ªânh T·ª´ v·ª±ng & H·∫≠u k·ª≥ (Runtime)</h2>
                    
                    <!-- H√°n -> Vi·ªát Substitution Override -->
                    <h3 class="font-bold text-lg text-gray-700 mb-3 border-b pb-2">1. H√°n -> Vi·ªát (∆Øu ti√™n, T·∫°m th·ªùi)</h3>
                    <p class="text-sm text-gray-600 mb-3">Th√™m nhi·ªÅu c·∫∑p r·ªìi nh·∫•n "√Åp d·ª•ng & D·ªãch l·∫°i" 1 l·∫ßn.</p>
                    <div class="space-y-4 mb-4">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label for="han-replace" class="block text-sm font-medium text-gray-700 mb-1">H√°n t·ª± (C·∫ßn thay th·∫ø)</label>
                                <input type="text" id="han-replace" placeholder="Êàë" class="w-full p-2 rounded-md text-sm">
                            </div>
                            <div>
                                <label for="viet-new-value" class="block text-sm font-medium text-gray-700 mb-1">Nghƒ©a Vi·ªát (M·ªöI)</label>
                                <input type="text" id="viet-new-value" placeholder="ta / t√¥i" class="w-full p-2 rounded-md text-sm">
                            </div>
                        </div>
                        <button id="add-runtime-substitution-btn" class="btn btn-secondary w-full font-bold py-2 px-4 rounded-md text-sm">
                            + Th√™m v√†o danh s√°ch t·∫°m
                        </button>
                    </div>
                    
                    <div id="runtime-substitution-list" class="space-y-2 max-h-36 overflow-y-auto pr-2 mb-6 border border-yellow-200 p-2 rounded-md bg-yellow-50">
                         <p class="text-gray-500 text-sm">Ch∆∞a c√≥ c·∫∑p H√°n -> Vi·ªát t·∫°m th·ªùi.</p>
                    </div>

                    <!-- NEW: Vi·ªát -> Vi·ªát Post-Substitution -->
                    <h3 class="font-bold text-lg text-gray-700 mb-3 border-b pb-2">2. Vi·ªát -> Vi·ªát (H·∫≠u k·ª≥, Vƒ©nh vi·ªÖn)</h3>
                     <p class="text-sm text-gray-600 mb-3">M·ªçi thay ƒë·ªïi ƒë·ªÅu ƒë∆∞·ª£c **l∆∞u vƒ©nh vi·ªÖn** v√† d√πng cho c√°c ch∆∞∆°ng/s√°ch kh√°c. Th√™m nhi·ªÅu c·∫∑p r·ªìi nh·∫•n "√Åp d·ª•ng & D·ªãch l·∫°i" 1 l·∫ßn.</p>
                    <div class="space-y-4 mb-4">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label for="viet-old-post" class="block text-sm font-medium text-gray-700 mb-1">C·ª•m t·ª´ Vi·ªát C≈® (ƒê√£ d·ªãch)</label>
                                <input type="text" id="viet-old-post" placeholder="√°o b√†o r·ªìng" class="w-full p-2 rounded-md text-sm">
                            </div>
                            <div>
                                <label for="viet-new-post" class="block text-sm font-medium text-gray-700 mb-1">C·ª•m t·ª´ Vi·ªát M·ªöI (Tinh ch·ªânh)</label>
                                <input type="text" id="viet-new-post" placeholder="√°o long b√†o" class="w-full p-2 rounded-md text-sm">
                            </div>
                        </div>
                        <button id="add-post-substitution-btn" class="btn btn-secondary w-full font-bold py-2 px-4 rounded-md text-sm">
                            + Th√™m v√†o danh s√°ch vƒ©nh vi·ªÖn
                        </button>
                    </div>
                    
                    <div id="post-substitution-list" class="space-y-2 max-h-36 overflow-y-auto pr-2 border border-blue-200 p-2 rounded-md post-sub-item mb-4">
                        <p class="text-gray-500 text-sm">Ch∆∞a c√≥ c·∫∑p Vi·ªát -> Vi·ªát vƒ©nh vi·ªÖn.</p>
                    </div>
                     <button id="apply-all-substitution-btn" class="btn btn-ai w-full font-bold py-2 px-4 rounded-md text-lg">
                        √Åp d·ª•ng & D·ªãch l·∫°i (Batch)
                    </button>
                </div>

                <div class="card p-6">
                    <button id="settings-toggle" class="w-full text-left font-bold text-xl text-[#8c52ff] flex justify-between items-center py-2">
                        <span>‚öôÔ∏è C√†i ƒë·∫∑t N√¢ng cao (API & Prompt)</span>
                        <span id="toggle-icon">‚ñº</span>
                    </button>
                    <div id="advanced-settings" class="mt-4 space-y-4 hidden">
                        <!-- API Key Management Section -->
                        <div class="space-y-2">
                            <h3 class="font-semibold text-base text-gray-700 flex justify-between items-center">
                                Qu·∫£n l√Ω API Keys
                                <span id="key-count" class="text-sm bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full">0 Kh√≥a</span>
                            </h3>
                            <div class="flex space-x-2">
                                <input type="text" id="new-api-key-input" placeholder="Nh·∫≠p kh√≥a API m·ªõi..." class="flex-1 p-2 rounded-md text-sm">
                                <button id="add-api-key-btn" class="btn btn-primary py-2 px-4 rounded-md text-sm">Th√™m Kh√≥a</button>
                            </div>
                            <div id="api-key-list" class="space-y-2 max-h-32 overflow-y-auto pr-1 border border-gray-100 p-2 rounded-md">
                                <!-- Key list will be rendered here -->
                                <p class="text-xs text-gray-400">Kh√≥a s·∫Ω ƒë∆∞·ª£c l∆∞u trong tr√¨nh duy·ªát.</p>
                            </div>
                            <p class="text-xs text-gray-500">·ª®ng d·ª•ng s·∫Ω t·ª± ƒë·ªông xoay v√≤ng c√°c kh√≥a khi c√≥ l·ªói.</p>
                        </div>
                        <!-- End API Key Management Section -->

                        <div class="h-px bg-gray-200 my-4"></div>

                        <div class="space-y-2">
                            <label for="custom-prompt" class="block text-sm font-medium text-gray-700">Custom Prompt (Cho AI D·ªãch Ho√†n Ch·ªânh)</label>
                            <textarea id="custom-prompt" rows="3" class="w-full p-2 rounded-md" placeholder="V√≠ d·ª•: D·ªãch m∆∞·ª£t m√† theo phong c√°ch truy·ªán c·ªï trang..."></textarea>
                            <p class="text-xs text-gray-500">Thay ƒë·ªïi vai tr√≤ v√† phong c√°ch d·ªãch c·ªßa AI.</p>
                        </div>

                        <div class="h-px bg-gray-200 my-4"></div>
                        
                        <h3 class="text-lg font-semibold mb-3">T·∫£i l√™n T·ª´ ƒëi·ªÉn (H√†ng lo·∫°t)</h3>
                        <p class="text-sm text-gray-600 mb-2">ƒê·ªãnh d·∫°ng t·ªáp: TXT ho·∫∑c CSV. M·ªói d√≤ng l√† m·ªôt c·∫∑p **H√°n t·ª±,Nghƒ©a Vi·ªát**.</p>
                        <div class="flex space-x-2 items-center">
                            <input type="file" id="dictionary-file-input" accept=".txt, .csv" class="hidden">
                            <label for="dictionary-file-input" class="cursor-pointer btn btn-secondary py-2 px-4 rounded-md text-sm">Ch·ªçn T·ªáp...</label>
                            <button id="upload-dictionary-btn" class="btn btn-primary py-2 px-4 rounded-md text-sm" disabled>T·∫£i & Th√™m</button>
                        </div>
                        <div id="upload-status" class="text-sm mt-2"></div>
                    </div>
                </div>

                <div class="card p-6">
                    <h2 class="text-2xl font-bold mb-4 text-[#3e684b]">T·ª´ ƒëi·ªÉn c·ªßa b·∫°n (Vƒ©nh Vi·ªÖn)</h2>
                    <div class="space-y-4 mb-6">
                        <div>
                            <label for="han-input" class="block text-sm font-medium text-gray-700 mb-1">T·ª´ H√°n</label>
                            <input type="text" id="han-input" placeholder="‰Ω†Â•Ω" class="w-full p-2 rounded-md">
                        </div>
                        <div>
                            <label for="viet-input" class="block text-sm font-medium text-gray-700 mb-1">Nghƒ©a Vi·ªát</label>
                            <input type="text" id="viet-input" placeholder="N«ê h«éo / Xin ch√†o" class="w-full p-2 rounded-md">
                        </div>
                        <div class="flex space-x-2">
                            <button id="add-word-btn" class="flex-1 btn btn-primary font-bold py-2 px-4 rounded-md">Th√™m v√†o t·ª´ ƒëi·ªÉn</button>
                            <button id="ai-explain-btn" class="btn btn-ai font-bold py-2 px-4 rounded-md text-sm whitespace-nowrap flex items-center justify-center">
                                ‚ú® Ph√¢n T√≠ch
                            </button>
                        </div>
                        <div id="han-explain-output" class="text-sm bg-indigo-50 p-3 rounded-md hidden"></div>
                    </div>
                    
                    <div class="h-px bg-gray-200 my-6"></div>

                    <h3 class="text-lg font-semibold mb-3">C√°c t·ª´ ƒë√£ l∆∞u (Vƒ©nh Vi·ªÖn)</h3>
                    <div id="dictionary-list" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                    </div>
                </div>
            </div>

            <div class="lg:col-span-3">
                <div class="card p-6">
                    <h2 class="text-2xl font-bold mb-4 text-[#3e684b]">C√¥ng c·ª• D·ªãch</h2>
                    
                    <div class="mb-4">
                        <label for="chinese-input" id="chinese-input-label" class="block text-lg font-medium text-gray-700 mb-2">VƒÉn b·∫£n ti·∫øng Trung (Vui l√≤ng ch·ªçn s√°ch ƒë·ªÉ b·∫Øt ƒë·∫ßu):</label>
                        <textarea id="chinese-input" rows="10" class="w-full p-3 rounded-md text-base" placeholder="N·ªôi dung ch∆∞∆°ng s·∫Ω ƒë∆∞·ª£c t·∫£i t·ª± ƒë·ªông v√†o ƒë√¢y..."></textarea>
                    </div>

                    <div class="flex items-center space-x-4 mb-6">
                        <button id="translate-btn" class="flex-1 btn btn-primary font-bold py-3 px-4 rounded-md text-lg flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m4 13l4-4M19 17v-2m-4-2l-4 4m-5-4v2m4-2l-4 4M3 11h12M9 9v2m4 7h.01M12 3h.01M3 21h18M3 17h.01M9 21v-2m4 2v-2m4-2v2m-4-2h.01M15 9h.01M12 9h.01M9 5h.01M12 5h.01M15 5h.01M3 5h.01M3 9h.01" /></svg>
                            D·ªãch sang H√°n Vi·ªát
                        </button>
                        <button id="clear-btn" class="btn btn-secondary font-bold py-3 px-4 rounded-md">X√≥a</button>
                    </div>
                    
                    <div id="ai-feature-area" class="mt-4 flex flex-col space-y-4">
                        <button id="ai-translate-btn" class="w-full btn btn-ai font-bold py-3 px-4 rounded-md text-lg flex items-center justify-center relative">
                            <span id="ai-loading-spinner" class="spinner mr-2 hidden"></span>
                            ‚ú® AI D·ªãch Ho√†n Ch·ªânh & Tr√¥i Ch·∫£y
                        </button>
                        <button id="next-chapter-btn" class="w-full btn btn-secondary font-bold py-3 px-4 rounded-md text-lg flex items-center justify-center relative hidden" disabled>
                            Ti·∫øp t·ª•c: D·ªãch Ch∆∞∆°ng <span id="next-chapter-title" class="ml-2 font-extrabold text-[#4a7c59]">...</span>
                        </button>
                    </div>
                    
                    <div class="mt-6">
                        <label for="vietnamese-output" class="block text-lg font-medium text-gray-700 mb-2">K·∫øt qu·∫£ H√°n Vi·ªát (v√† AI):</label>
                        <div id="vietnamese-output" class="w-full p-3 rounded-md bg-gray-50 h-64 min-h-[256px] overflow-y-auto border border-gray-200 text-gray-800">
                            <p class="text-gray-400">K·∫øt qu·∫£ d·ªãch s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y...</p>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        const DEFAULT_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
        const DEFAULT_TRANSLATION_PROMPT = "B·∫°n l√† m·ªôt chuy√™n gia d·ªãch thu·∫≠t ti·∫øng Trung sang ti·∫øng Vi·ªát. B·∫°n nh·∫≠n ƒë∆∞·ª£c m·ªôt ƒëo·∫°n vƒÉn ƒë√£ ƒë∆∞·ª£c d·ªãch m·ªôt ph·∫ßn sang ti·∫øng Vi·ªát b·∫±ng t·ª´ ƒëi·ªÉn c√° nh√¢n (C√°c t·ª´ ƒë√£ d·ªãch ƒë∆∞·ª£c bao quanh b·ªüi th·∫ª <span class='highlight'>...</span>). Nhi·ªám v·ª• c·ªßa b·∫°n l√† b·ªè qua c√°c th·∫ª HTML v√† d·ªãch to√†n b·ªô ƒëo·∫°n vƒÉn sang ti·∫øng Vi·ªát t·ª± nhi√™n, tr√¥i ch·∫£y, s·ª≠ d·ª•ng c√°c t·ª´ H√°n Vi·ªát ƒë√£ ƒë∆∞·ª£c thay th·∫ø (n·∫øu ch√∫ng h·ª£p ng·ªØ c·∫£nh) v√† d·ªãch n·ªët c√°c t·ª´ ti·∫øng Trung c√≤n l·∫°i. Tr·∫£ l·ªùi ch·ªâ b·∫±ng vƒÉn b·∫£n d·ªãch, kh√¥ng th√™m l·ªùi gi·∫£i th√≠ch.";
        const DEFAULT_EXPLANATION_PROMPT = "B·∫°n l√† m·ªôt tr·ª£ l√Ω ng√¥n ng·ªØ, chuy√™n cung c·∫•p th√¥ng tin chi ti·∫øt v·ªÅ H√°n t·ª±. Ph·∫£n h·ªìi b·∫±ng ti·∫øng Vi·ªát, cung c·∫•p Pinyin, nghƒ©a ph·ªï bi·∫øn nh·∫•t v√† m·ªôt c√¢u v√≠ d·ª• ti·∫øng Trung v·ªõi b·∫£n d·ªãch ti·∫øng Vi·ªát.";
        const MAX_CONTENT_LENGTH = 100000; // TƒÉng t·ª´ 30,000 l√™n 100,000 k√Ω t·ª± ƒë·ªÉ ph√¢n t√≠ch c·∫•u tr√∫c ch∆∞∆°ng

        document.addEventListener('DOMContentLoaded', () => {
            // UI elements
            const settingsToggle = document.getElementById('settings-toggle');
            const advancedSettings = document.getElementById('advanced-settings');
            const toggleIcon = document.getElementById('toggle-icon');
            const bookToggle = document.getElementById('book-toggle');
            const bookAnalysisContent = document.getElementById('book-analysis-content');
            const bookToggleIcon = document.getElementById('book-toggle-icon');
            
            const bookFileInput = document.getElementById('book-file-input');
            const bookFileLabel = document.getElementById('book-file-label');
            const extractChaptersBtn = document.getElementById('extract-chapters-btn');
            const extractLoadingSpinner = document.getElementById('extract-loading-spinner');
            const bookStatus = document.getElementById('book-status');
            const chapterNavigator = document.getElementById('chapter-navigator');
            const chaptersUl = document.getElementById('chapters-ul');
            const chineseInputLabel = document.getElementById('chinese-input-label');

            const nextChapterBtn = document.getElementById('next-chapter-btn');
            const nextChapterTitleSpan = document.getElementById('next-chapter-title');

            const newApiKeyInput = document.getElementById('new-api-key-input');
            const addApiKeyBtn = document.getElementById('add-api-key-btn');
            const apiKeyList = document.getElementById('api-key-list');
            const keyCountSpan = document.getElementById('key-count');

            const customPromptInput = document.getElementById('custom-prompt');
            const dictionaryFileInput = document.getElementById('dictionary-file-input');
            const uploadDictionaryBtn = document.getElementById('upload-dictionary-btn');
            const uploadStatus = document.getElementById('upload-status');

            const hanInput = document.getElementById('han-input');
            const vietInput = document.getElementById('viet-input');
            const addWordBtn = document.getElementById('add-word-btn');
            const aiExplainBtn = document.getElementById('ai-explain-btn');
            const hanExplainOutput = document.getElementById('han-explain-output');
            const dictionaryList = document.getElementById('dictionary-list');
            const chineseInput = document.getElementById('chinese-input');
            const translateBtn = document.getElementById('translate-btn');
            const clearBtn = document.getElementById('clear-btn');
            const vietnameseOutput = document.getElementById('vietnamese-output');
            const aiTranslateBtn = document.getElementById('ai-translate-btn');
            const aiLoadingSpinner = document.getElementById('ai-loading-spinner');

            // H√°n -> Vi·ªát Runtime substitution elements
            const hanReplaceInput = document.getElementById('han-replace');
            const vietNewValueInput = document.getElementById('viet-new-value');
            const addRuntimeSubstitutionBtn = document.getElementById('add-runtime-substitution-btn'); 
            const runtimeSubstitutionList = document.getElementById('runtime-substitution-list');
            
            // Viet -> Viet Post-Substitution elements
            const vietOldPostInput = document.getElementById('viet-old-post');
            const vietNewPostInput = document.getElementById('viet-new-post');
            const addPostSubstitutionBtn = document.getElementById('add-post-substitution-btn'); 
            const postSubstitutionList = document.getElementById('post-substitution-list');

            // NEW: Batch apply button
            const applyAllSubstitutionBtn = document.getElementById('apply-all-substitution-btn');


            // State
            let dictionary = []; // Permanent H√°n -> Vi·ªát
            let geminiApiKeys = [];
            let lastManualTranslationOutput = ''; 
            let rawBookContent = ''; 
            let chapterList = [];
            let currentChapterIndex = -1;
            let runtimeSubstitutions = []; // Runtime H√°n -> Vi·ªát overrides (Temporary)
            let postSubstitutions = []; // Viet (Old) -> Vi·ªát (New) edits (Permanent)

            // Utility Functions
            function escapeHtml(text) {
                const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
                return text.replace(/[&<>"']/g, m => map[m]);
            }

            function escapeRegExp(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            // API Call Handling (Multi-Key Failover)
            async function callGeminiAPI(systemPrompt, userQuery, mimeType = "text/plain", schema = null, retries = 0) {
                const keys = geminiApiKeys;
                const apiUrl = DEFAULT_API_URL;
                
                if (keys.length === 0) {
                    throw new Error("Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt Gemini API Key trong ph·∫ßn C√†i ƒë·∫∑t N√¢ng cao.");
                }

                let lastError = null;

                const generationConfig = { responseMimeType: mimeType };
                if (mimeType === "application/json" && schema) {
                    generationConfig.responseSchema = schema;
                }

                for (let i = 0; i < keys.length; i++) {
                    const apiKey = keys[i];
                    const url = apiUrl + apiKey;
                    const payload = {
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: generationConfig
                    };

                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            if (response.status === 429) {
                                lastError = `Kh√≥a API ${i + 1} (${apiKey.substring(0,4)}...) ƒë√£ b·ªã gi·ªõi h·∫°n t·ªëc ƒë·ªô (429). ƒêang th·ª≠ kh√≥a ti·∫øp theo...`;
                            } else if (response.status === 400 || response.status === 403) {
                                lastError = `Kh√≥a API ${i + 1} (${apiKey.substring(0,4)}...) kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng c√≥ quy·ªÅn truy c·∫≠p (400/403). ƒêang th·ª≠ kh√≥a ti·∫øp theo...`;
                            } else {
                                const errorData = await response.json();
                                lastError = `Kh√≥a API ${i + 1} (${apiKey.substring(0,4)}...) l·ªói: ${errorData.error.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh.'}`;
                            }
                            console.error(lastError);
                            continue;
                        }

                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) {
                            return text;
                        } else {
                            lastError = `Kh√≥a API ${i + 1} (${apiKey.substring(0,4)}...) tr·∫£ v·ªÅ c·∫•u tr√∫c r·ªóng. ƒêang th·ª≠ kh√≥a ti·∫øp theo...`;
                            console.error(lastError);
                            continue;
                        }

                    } catch (error) {
                        lastError = `Kh√≥a API ${i + 1} (${apiKey.substring(0,4)}...) l·ªói k·∫øt n·ªëi: ${error.message}. ƒêang th·ª≠ kh√≥a ti·∫øp theo...`;
                        console.error(lastError);
                        if (i === keys.length - 1 && retries < 3) {
                            const delay = Math.pow(2, retries) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            return callGeminiAPI(systemPrompt, userQuery, mimeType, schema, retries + 1);
                        }
                    }
                }

                throw new Error(`T·∫•t c·∫£ ${keys.length} kh√≥a API ƒë·ªÅu ƒë√£ th·∫•t b·∫°i. L·ªói cu·ªëi c√πng: ${lastError || 'Kh√¥ng c√≥ ph·∫£n h·ªìi.'}`);
            }

            // Core App Logic
            function loadSettings() {
                geminiApiKeys = JSON.parse(localStorage.getItem('geminiApiKeys') || '[]');
                const storedPrompt = localStorage.getItem('customPrompt') || DEFAULT_TRANSLATION_PROMPT;
                customPromptInput.value = storedPrompt;
                renderKeyList();
            }

            function savePrompt() {
                localStorage.setItem('customPrompt', customPromptInput.value.trim());
            }
            
            function saveKeys() {
                localStorage.setItem('geminiApiKeys', JSON.stringify(geminiApiKeys));
                renderKeyList();
            }

            // Key Management
            function addKey() {
                const key = newApiKeyInput.value.trim();
                if (key && !geminiApiKeys.includes(key)) {
                    geminiApiKeys.unshift(key);
                    saveKeys(); // T·ª± ƒë·ªông l∆∞u sau khi th√™m
                    newApiKeyInput.value = '';
                    newApiKeyInput.focus();
                } else if (geminiApiKeys.includes(key)) {
                    alert('Kh√≥a API n√†y ƒë√£ t·ªìn t·∫°i.');
                }
            }

            function deleteKey(index) {
                geminiApiKeys.splice(index, 1);
                saveKeys();
            }

            function renderKeyList() {
                apiKeyList.innerHTML = '';
                keyCountSpan.textContent = `${geminiApiKeys.length} Kh√≥a`;

                if (geminiApiKeys.length === 0) {
                    apiKeyList.innerHTML = '<p class="text-xs text-red-500">Ch∆∞a c√≥ kh√≥a n√†o. C√°c t√≠nh nƒÉng AI s·∫Ω kh√¥ng ho·∫°t ƒë·ªông.</p>';
                    return;
                }

                geminiApiKeys.forEach((key, index) => {
                    const keyEl = document.createElement('div');
                    keyEl.className = 'flex justify-between items-center bg-gray-50 p-2 rounded-md';
                    keyEl.innerHTML = `
                        <div>
                            <span class="font-medium">Key ${index + 1}: </span>
                            <span class="text-sm font-mono text-gray-700">${key.substring(0, 4)}...${key.substring(key.length - 4)}</span>
                        </div>
                        <button data-index="${index}" class="delete-key-btn text-red-500 hover:text-red-700 text-xs font-bold py-1 px-2 rounded-md">X√≥a</button>
                    `;
                    apiKeyList.appendChild(keyEl);
                });
            }

            function getCustomPrompt(type) {
                if (type === 'translation') {
                    return customPromptInput.value.trim() || DEFAULT_TRANSLATION_PROMPT;
                }
                return DEFAULT_EXPLANATION_PROMPT; 
            }
            
            // Permanent H√°n -> Vi·ªát Dictionary Management
            function saveDictionary() {
                localStorage.setItem('hanVietDict', JSON.stringify(dictionary));
            }

            function loadDictionary() {
                const storedDict = localStorage.getItem('hanVietDict');
                if (storedDict) {
                    dictionary = JSON.parse(storedDict);
                }
            }

            function renderDictionary() {
                dictionaryList.innerHTML = '';
                if (dictionary.length === 0) {
                    dictionaryList.innerHTML = '<p class="text-gray-500 text-sm">T·ª´ ƒëi·ªÉn c·ªßa b·∫°n ch∆∞a c√≥ t·ª´ n√†o.</p>';
                    return;
                }
                dictionary.forEach((word, index) => {
                    const wordEl = document.createElement('div');
                    wordEl.className = 'flex justify-between items-center bg-gray-50 p-2 rounded-md';
                    wordEl.innerHTML = `
                        <div>
                            <span class="font-semibold text-gray-800">${word.han}</span>
                            <span class="text-gray-500 mx-2">‚Üí</span>
                            <span class="text-gray-700">${word.viet}</span>
                        </div>
                        <button data-index="${index}" class="delete-btn text-red-500 hover:text-red-700 text-xs font-bold py-1 px-2 rounded-md">X√≥a</button>
                    `;
                    dictionaryList.appendChild(wordEl);
                });
            }

            function addWord(han, viet) {
                if (han && viet) {
                    const existingIndex = dictionary.findIndex(w => w.han === han);
                    if (existingIndex !== -1) {
                        dictionary[existingIndex].viet = viet;
                    } else {
                        dictionary.unshift({ han, viet });
                    }
                    return true;
                }
                return false;
            }
            
            // Runtime Substitution Logic (H√°n -> Vi·ªát)
            function renderRuntimeSubstitutions() {
                runtimeSubstitutionList.innerHTML = '';
                if (runtimeSubstitutions.length === 0) {
                    runtimeSubstitutionList.innerHTML = '<p class="text-gray-500 text-sm">Ch∆∞a c√≥ c·∫∑p H√°n -> Vi·ªát t·∫°m th·ªùi.</p>';
                    return;
                }

                runtimeSubstitutions.forEach((word, index) => {
                    const wordEl = document.createElement('div');
                    wordEl.className = 'flex justify-between items-center bg-yellow-100 p-2 rounded-md';
                    wordEl.innerHTML = `
                        <div class="flex flex-col text-sm">
                            <span class="font-bold text-gray-800">${word.han}</span>
                            <span class="text-gray-600">‚Üí ${word.viet}</span>
                        </div>
                        <div class="flex space-x-1">
                            <button data-han="${word.han}" data-viet="${word.viet}" class="promote-btn btn btn-promote text-xs py-1 px-2 rounded-md">L∆∞u vƒ©nh vi·ªÖn</button>
                            <button data-index="${index}" class="delete-runtime-btn btn btn-danger text-xs py-1 px-2 rounded-md">X√≥a</button>
                        </div>
                    `;
                    runtimeSubstitutionList.appendChild(wordEl);
                });
            }

            function addRuntimeSubstitution(han, viet) {
                 if (han && viet) {
                    const existingIndex = runtimeSubstitutions.findIndex(w => w.han === han);
                    if (existingIndex !== -1) {
                        runtimeSubstitutions[existingIndex].viet = viet;
                    } else {
                        runtimeSubstitutions.unshift({ han, viet });
                    }
                    renderRuntimeSubstitutions();
                    return true;
                }
                return false;
            }
            
            function deleteRuntimeSubstitution(index) {
                runtimeSubstitutions.splice(index, 1);
                renderRuntimeSubstitutions();
            }

            function promoteToPermanent(han, viet) {
                addWord(han, viet);
                saveDictionary();
                renderDictionary();
                runtimeSubstitutions = runtimeSubstitutions.filter(w => w.han !== han);
                renderRuntimeSubstitutions();
                translateText(); 
            }
            
            // Permanent Post Substitution Logic (Viet -> Viet)
            function savePostSubstitutions() {
                localStorage.setItem('postSubstitutions', JSON.stringify(postSubstitutions));
            }
            
            function loadPostSubstitutions() {
                const storedSubs = localStorage.getItem('postSubstitutions');
                if (storedSubs) {
                    postSubstitutions = JSON.parse(storedSubs);
                }
            }
            
            function renderPostSubstitutions() {
                postSubstitutionList.innerHTML = '';
                if (postSubstitutions.length === 0) {
                    postSubstitutionList.innerHTML = '<p class="text-gray-500 text-sm">Ch∆∞a c√≥ c·∫∑p Vi·ªát -> Vi·ªát vƒ©nh vi·ªÖn.</p>';
                    return;
                }

                postSubstitutions.forEach((pair, index) => {
                    const wordEl = document.createElement('div');
                    wordEl.className = 'flex justify-between items-center post-sub-item p-2 rounded-md';
                    wordEl.innerHTML = `
                        <div class="flex flex-col text-sm">
                            <span class="font-bold text-gray-800">C≈©: ${pair.old}</span>
                            <span class="text-gray-600">‚Üí M·ªõi: ${pair.new}</span>
                        </div>
                        <div class="flex space-x-1">
                            <button data-index="${index}" class="delete-post-btn btn btn-danger text-xs py-1 px-2 rounded-md">X√≥a</button>
                        </div>
                    `;
                    postSubstitutionList.appendChild(wordEl);
                });
            }
            
            function addPostSubstitution(oldValue, newValue) {
                if (oldValue && newValue) {
                    const existingIndex = postSubstitutions.findIndex(p => p.old === oldValue);
                    if (existingIndex !== -1) {
                        postSubstitutions[existingIndex].new = newValue;
                    } else {
                        postSubstitutions.unshift({ old: oldValue, new: newValue });
                    }
                    savePostSubstitutions(); // Now always permanent
                    renderPostSubstitutions();
                    return true;
                }
                return false;
            }
            
            function deletePostSubstitution(index) {
                postSubstitutions.splice(index, 1);
                savePostSubstitutions(); // Vƒ©nh vi·ªÖn l∆∞u l·∫°i sau khi x√≥a
                renderPostSubstitutions();
            }
            
            // File Upload (Dictionary)
            function handleFileUpload() {
                const file = dictionaryFileInput.files[0];
                if (!file) {
                    uploadStatus.className = 'text-red-500 text-sm mt-2';
                    uploadStatus.textContent = 'Vui l√≤ng ch·ªçn m·ªôt t·ªáp ƒë·ªÉ t·∫£i l√™n.';
                    return;
                }

                uploadDictionaryBtn.disabled = true;
                uploadStatus.className = 'text-gray-500 text-sm mt-2';
                uploadStatus.textContent = 'ƒêang ƒë·ªçc t·ªáp...';

                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    const lines = content.split('\n').filter(line => line.trim() !== '');
                    let newWordsCount = 0;
                    
                    lines.forEach(line => {
                        const parts = line.split(/[,=]/).map(p => p.trim()).filter(p => p.length > 0);
                        if (parts.length >= 2) {
                            const han = parts[0];
                            const viet = parts[1];
                            if (addWord(han, viet)) {
                                newWordsCount++;
                            }
                        }
                    });

                    saveDictionary();
                    renderDictionary();
                    uploadStatus.className = 'text-green-600 text-sm mt-2 font-semibold';
                    uploadStatus.textContent = `T·∫£i l√™n th√†nh c√¥ng! ƒê√£ th√™m/c·∫≠p nh·∫≠t ${newWordsCount} t·ª´.`;
                    dictionaryFileInput.value = '';
                    uploadDictionaryBtn.disabled = false;
                };

                reader.onerror = () => {
                    uploadStatus.className = 'text-red-500 text-sm mt-2';
                    uploadStatus.textContent = 'L·ªói khi ƒë·ªçc t·ªáp.';
                    uploadDictionaryBtn.disabled = false;
                };

                reader.readAsText(file);
            }

            // Translation & AI Features
            function translateText() {
                let inputText = chineseInput.value;
                if (!inputText.trim()) {
                    vietnameseOutput.innerHTML = '<p class="text-gray-400">Vui l√≤ng nh·∫≠p vƒÉn b·∫£n c·∫ßn d·ªãch.</p>';
                    return;
                }
                
                // --- STEP 1: H√°n -> Vi·ªát Substitution (Permanent + Runtime Overrides) ---
                let translatedText = escapeHtml(inputText);
                
                const masterDictionary = [
                    ...runtimeSubstitutions, 
                    ...dictionary.filter(perm => !runtimeSubstitutions.some(runtime => runtime.han === perm.han))
                ];

                const sortedDictionary = masterDictionary.sort((a, b) => b.han.length - a.han.length);

                sortedDictionary.forEach(word => {
                    const regex = new RegExp(escapeRegExp(escapeHtml(word.han)), 'g');
                    translatedText = translatedText.replace(regex, `<span class="highlight">${escapeHtml(word.viet)}</span>`);
                });

                // --- STEP 2: Vi·ªát -> Vi·ªát Post Substitution (Permanent Edits) ---
                let postRefinedText = translatedText;
                const sortedPostSubstitutions = [...postSubstitutions].sort((a, b) => b.old.length - a.old.length);

                sortedPostSubstitutions.forEach(postSub => {
                    const oldEscaped = escapeHtml(postSub.old);
                    const newEscaped = escapeHtml(postSub.new);

                    const oldHighlightRegex = new RegExp(`<span class="highlight">${escapeRegExp(oldEscaped)}</span>`, 'g');
                    postRefinedText = postRefinedText.replace(oldHighlightRegex, `<span class="highlight">${newEscaped}</span>`);

                    const oldTextRegex = new RegExp(escapeRegExp(oldEscaped), 'g');
                    postRefinedText = postRefinedText.replace(oldTextRegex, `<span class="highlight">${newEscaped}</span>`);
                });
                
                lastManualTranslationOutput = postRefinedText;
                vietnameseOutput.innerHTML = postRefinedText.replace(/\n/g, '<br>');
                
                if (geminiApiKeys.length > 0) {
                     aiTranslateBtn.classList.remove('hidden');
                } else {
                    aiTranslateBtn.classList.add('hidden');
                }
            }
            
            async function fetchAITranslation() {
                if (!lastManualTranslationOutput.trim()) {
                    alert("Vui l√≤ng th·ª±c hi·ªán d·ªãch H√°n Vi·ªát th·ªß c√¥ng tr∆∞·ªõc.");
                    return;
                }

                aiTranslateBtn.disabled = true;
                aiLoadingSpinner.classList.remove('hidden');
                
                // Store the H√°n Vi·ªát result to restore it on failure
                const originalContentForRecovery = vietnameseOutput.innerHTML; 
                
                vietnameseOutput.innerHTML = `<div class="text-center py-4 text-gray-500 flex items-center justify-center">
                    <span class="spinner mr-2 border-top-4 border-indigo-600 w-6 h-6"></span>
                    AI ƒëang x·ª≠ l√Ω d·ªãch thu·∫≠t ho√†n ch·ªânh... (S·ª≠ d·ª•ng c∆° ch·∫ø xoay v√≤ng keys)
                </div>`;


                const systemPrompt = getCustomPrompt('translation');
                const userQuery = `D·ªãch ƒëo·∫°n vƒÉn sau:\n\n${lastManualTranslationOutput}`;

                try {
                    const aiResult = await callGeminiAPI(systemPrompt, userQuery);
                    vietnameseOutput.innerHTML = `<h3 class="text-xl font-semibold mb-2 text-[#8c52ff]">‚ú® D·ªãch Ho√†n Ch·ªânh (AI)</h3><p class="whitespace-pre-wrap">${aiResult}</p>`;
                } catch (error) {
                    // --- NEW FAILOVER VISUAL FEEDBACK ---
                    // 1. Restore the H√°n Vi·ªát result
                    vietnameseOutput.innerHTML = originalContentForRecovery; 
                    
                    // 2. Show a clear error message below the H√°n Vi·ªát result
                    vietnameseOutput.innerHTML += `
                        <div class="mt-4 p-4 rounded-md bg-red-100 border border-red-400 text-red-700">
                            <h4 class="font-bold">‚ö†Ô∏è L·ªñI D·ªäCH THU·∫¨T AI</h4>
                            <p class="text-sm">H·ªá th·ªëng ƒë√£ t·ª± ƒë·ªông th·ª≠ v·ªõi t·∫•t c·∫£ c√°c kh√≥a API (${geminiApiKeys.length} keys) nh∆∞ng kh√¥ng th√†nh c√¥ng. K·∫øt qu·∫£ H√°n Vi·ªát th·ªß c√¥ng ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c. Vui l√≤ng ki·ªÉm tra l·∫°i Keys ho·∫∑c gi·ªõi h·∫°n s·ª≠ d·ª•ng.</p>
                            <p class="text-xs mt-1">Chi ti·∫øt l·ªói: ${error.message}</p>
                        </div>
                    `;
                    console.error("AI Translation Error:", error);
                    // --- END NEW FAILOVER VISUAL FEEDBACK ---
                } finally {
                    aiTranslateBtn.disabled = false;
                    aiLoadingSpinner.classList.add('hidden');
                    updateNextChapterButton();
                }
            }

            async function fetchHanZiExplanation() {
                const han = hanInput.value.trim();
                if (!han) {
                    hanExplainOutput.innerHTML = '<p class="text-red-500">Vui l√≤ng nh·∫≠p H√°n t·ª± ƒë·ªÉ ph√¢n t√≠ch.</p>';
                    hanExplainOutput.classList.remove('hidden');
                    return;
                }

                aiExplainBtn.disabled = true;
                aiExplainBtn.innerHTML = '<span class="spinner mr-2 w-4 h-4 border-white"></span> ƒêang ph√¢n t√≠ch...';
                hanExplainOutput.classList.remove('hidden');
                hanExplainOutput.innerHTML = `<div class="text-gray-500">ƒêang t·∫£i...</div>`;

                const systemPrompt = DEFAULT_EXPLANATION_PROMPT;
                const userQuery = `Ph√¢n t√≠ch chi ti·∫øt t·ª´ H√°n t·ª±/t·ª´ v·ª±ng: "${han}"`;

                try {
                    const aiResult = await callGeminiAPI(systemPrompt, userQuery);
                    hanExplainOutput.innerHTML = `<h4 class="font-semibold text-indigo-700">Ph√¢n t√≠ch cho "${han}":</h4><p class="mt-1">${aiResult.replace(/\n/g, '<br>')}</p>`;
                } catch (error) {
                    hanExplainOutput.innerHTML = `<p class="text-red-500">L·ªói AI: ${error.message}</p>`;
                } finally {
                    aiExplainBtn.disabled = false;
                    aiExplainBtn.innerHTML = '‚ú® Ph√¢n T√≠ch';
                }
            }

            // Chapter Navigation & Book Slicing Logic 
            const chapterSchema = {
                type: "OBJECT",
                properties: {
                    chapters: {
                        type: "ARRAY",
                        description: "An array of extracted chapter titles and their starting markers. The order must be maintained.",
                        items: {
                            type: "OBJECT",
                            properties: {
                                title: { type: "STRING", description: "The clean title of the chapter (e.g., 'Ch∆∞∆°ng 1: B·∫Øt ƒë·∫ßu')." },
                                startMarker: { type: "STRING", description: "The exact H√°n t·ª± string marking the start of this chapter in the raw text (e.g., 'Á¨¨1Á´†', 'Ch∆∞∆°ng 1', 'Á¨¨‰∏ÄÁ´†'). This marker is used for slicing." }
                            },
                            required: ["title", "startMarker"]
                        }
                    }
                }
            };

            function handleBookUpload() {
                const file = bookFileInput.files[0];
                if (!file) return;

                bookFileLabel.textContent = `T·ªáp: ${file.name}`;
                rawBookContent = ''; 
                chapterList = [];
                currentChapterIndex = -1;
                chapterNavigator.classList.add('hidden');
                extractChaptersBtn.disabled = false;
                bookStatus.className = 'text-gray-500 text-sm mt-2';
                bookStatus.textContent = `T·ªáp "${file.name}" ƒë√£ s·∫µn s√†ng. Vui l√≤ng b·∫•m "AI Ph√¢n t√≠ch..."`;
                runtimeSubstitutions = []; 
                renderRuntimeSubstitutions();
                renderPostSubstitutions();


                const reader = new FileReader();
                reader.onload = (e) => {
                    rawBookContent = e.target.result;
                    if (rawBookContent.length > 5000000) {
                        bookStatus.className = 'text-red-500 text-sm mt-2 font-bold';
                        bookStatus.textContent = 'T·ªáp qu√° l·ªõn (>5MB). Vui l√≤ng ch·ªçn t·ªáp nh·ªè h∆°n.';
                        extractChaptersBtn.disabled = true;
                        rawBookContent = '';
                    } else {
                        const contentForAI = rawBookContent.substring(0, MAX_CONTENT_LENGTH);
                        extractChapters(contentForAI);
                    }
                };
                reader.onerror = () => {
                    bookStatus.className = 'text-red-500 text-sm mt-2';
                    bookStatus.textContent = 'L·ªói khi ƒë·ªçc t·ªáp.';
                };
                reader.readAsText(file);
            }

            async function extractChapters(contentForAI) {
                if (geminiApiKeys.length === 0) {
                    bookStatus.className = 'text-red-500 text-sm mt-2';
                    bookStatus.textContent = 'Kh√¥ng th·ªÉ ph√¢n t√≠ch: Vui l√≤ng th√™m API Key.';
                    return;
                }

                extractChaptersBtn.disabled = true;
                extractLoadingSpinner.classList.remove('hidden');
                bookStatus.className = 'text-gray-500 text-sm mt-2';
                bookStatus.textContent = `AI ƒëang ph√¢n t√≠ch c·∫•u tr√∫c ch∆∞∆°ng t·ª´ ${MAX_CONTENT_LENGTH.toLocaleString('vi-VN')} k√Ω t·ª± ƒë·∫ßu...`;
                
                const systemPrompt = "B·∫°n l√† m·ªôt c√¥ng c·ª• ph√¢n t√≠ch c·∫•u tr√∫c truy·ªán/ti·ªÉu thuy·∫øt. Nhi·ªám v·ª• c·ªßa b·∫°n l√† tr√≠ch xu·∫•t ti√™u ƒë·ªÅ c·ªßa c√°c ch∆∞∆°ng v√† chu·ªói H√°n t·ª± ch√≠nh x√°c ƒë√°nh d·∫•u s·ª± b·∫Øt ƒë·∫ßu c·ªßa ch∆∞∆°ng ƒë√≥ (startMarker) t·ª´ vƒÉn b·∫£n th√¥. Ch·ªâ tr·∫£ v·ªÅ JSON theo Schema ƒë∆∞·ª£c cung c·∫•p, kh√¥ng th√™m l·ªùi gi·∫£i th√≠ch. H√£y ƒë·∫£m b·∫£o startMarker l√† chu·ªói H√°n t·ª± ƒë·∫ßu ti√™n c·ªßa ch∆∞∆°ng, kh√¥ng ph·∫£i ti·∫øng Vi·ªát.";
                const userQuery = `Tr√≠ch xu·∫•t danh s√°ch ch∆∞∆°ng (title v√† startMarker) t·ª´ n·ªôi dung sau:\n\n${contentForAI}`; 

                try {
                    const jsonString = await callGeminiAPI(systemPrompt, userQuery, "application/json", chapterSchema);
                    const result = JSON.parse(jsonString);
                    chapterList = result.chapters || [];

                    if (chapterList.length > 1) {
                        currentChapterIndex = 0;
                        renderChapterNavigator();
                        chapterNavigator.classList.remove('hidden');
                        selectChapter(0, false); 
                        bookStatus.className = 'text-green-600 text-sm mt-2 font-semibold';
                        bookStatus.textContent = `Th√†nh c√¥ng! ƒê√£ tr√≠ch xu·∫•t ${chapterList.length} ch∆∞∆°ng. ƒêang t·∫£i ch∆∞∆°ng ƒë·∫ßu ti√™n.`;
                    } else {
                        chapterList = [];
                        bookStatus.className = 'text-red-500 text-sm mt-2';
                        bookStatus.textContent = 'AI kh√¥ng th·ªÉ tr√≠ch xu·∫•t c·∫•u tr√∫c ch∆∞∆°ng r√µ r√†ng. Vui l√≤ng ki·ªÉm tra l·∫°i ƒë·ªãnh d·∫°ng t·ªáp.';
                        chapterNavigator.classList.add('hidden');
                    }
                } catch (error) {
                    bookStatus.className = 'text-red-500 text-sm mt-2';
                    bookStatus.textContent = `L·ªói ph√¢n t√≠ch AI: ${error.message}`;
                    chapterList = [];
                } finally {
                    extractChaptersBtn.disabled = false;
                    extractLoadingSpinner.classList.add('hidden');
                }
            }

            function sliceChapterContent(index) {
                if (index < 0 || index >= chapterList.length) return '';
                
                const currentChapter = chapterList[index];
                const startMarker = currentChapter.startMarker;
                let endMarker = '';

                if (index < chapterList.length - 1) {
                    endMarker = chapterList[index + 1].startMarker;
                }
                
                const startIndex = rawBookContent.indexOf(startMarker);
                
                if (startIndex === -1) {
                    console.error("L·ªói: Kh√¥ng t√¨m th·∫•y Start Marker c·ªßa ch∆∞∆°ng.", startMarker);
                    return `L·ªói: Kh√¥ng t√¨m th·∫•y ƒëi·ªÉm b·∫Øt ƒë·∫ßu "${startMarker}" trong t·ªáp s√°ch.`;
                }

                let endIndex;
                if (endMarker) {
                    endIndex = rawBookContent.indexOf(endMarker, startIndex + startMarker.length);
                    if (endIndex === -1) {
                        endIndex = rawBookContent.length; 
                    }
                } else {
                    endIndex = rawBookContent.length;
                }
                
                let content = rawBookContent.substring(startIndex, endIndex).trim();
                
                const maxChapterLength = 20000; 
                if (content.length > maxChapterLength) {
                    content = content.substring(0, maxChapterLength) + "\n\n[...N·ªôi dung c√≤n l·∫°i c·ªßa ch∆∞∆°ng ƒë√£ b·ªã c·∫Øt do qu√° d√†i. Vui l√≤ng t·∫£i l√™n t·ªáp ƒë∆∞·ª£c chia nh·ªè h∆°n ho·∫∑c sao ch√©p th·ªß c√¥ng ph·∫ßn ti·∫øp theo.]";
                }
                
                return content;
            }

            function renderChapterNavigator() {
                chaptersUl.innerHTML = '';
                chapterList.forEach((chapter, index) => {
                    const li = document.createElement('li');
                    li.className = `p-2 rounded-md text-sm cursor-pointer hover:bg-gray-100 transition-colors ${index === currentChapterIndex ? 'chapter-active font-semibold' : ''}`;
                    li.textContent = chapter.title;
                    li.dataset.index = index;
                    li.addEventListener('click', () => selectChapter(index));
                    chaptersUl.appendChild(li);
                });
            }

            function selectChapter(index, autoScroll = true) {
                if (index < 0 || index >= chapterList.length) return;

                currentChapterIndex = index;
                renderChapterNavigator();
                
                runtimeSubstitutions = []; 
                renderRuntimeSubstitutions();

                const chapterTitle = chapterList[index].title;
                chineseInputLabel.textContent = `VƒÉn b·∫£n ti·∫øng Trung: ƒêang d·ªãch "${chapterTitle}"`;
                
                chineseInput.value = "ƒêang t·∫£i n·ªôi dung...";
                const content = sliceChapterContent(index);
                chineseInput.value = content;
                
                vietnameseOutput.innerHTML = '<p class="text-gray-400">K·∫øt qu·∫£ d·ªãch s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y...</p>';
                updateNextChapterButton();
                
                if (autoScroll) {
                    chineseInput.scrollIntoView({ behavior: 'smooth' });
                    chineseInput.focus();
                }
            }

            function updateNextChapterButton() {
                if (currentChapterIndex >= 0 && currentChapterIndex < chapterList.length - 1) {
                    const nextChapter = chapterList[currentChapterIndex + 1];
                    nextChapterTitleSpan.textContent = nextChapter.title;
                    nextChapterBtn.classList.remove('hidden');
                    nextChapterBtn.disabled = false;
                } else if (currentChapterIndex === chapterList.length - 1 && chapterList.length > 0) {
                    nextChapterTitleSpan.textContent = 'ƒê√£ ho√†n th√†nh cu·ªën s√°ch!';
                    nextChapterBtn.classList.remove('hidden');
                    nextChapterBtn.disabled = true;
                } else {
                    nextChapterBtn.classList.add('hidden');
                    nextChapterBtn.disabled = true;
                }
            }
            
            function goToNextChapter() {
                if (currentChapterIndex < chapterList.length - 1) {
                    selectChapter(currentChapterIndex + 1);
                } else {
                    alert('B·∫°n ƒë√£ ho√†n th√†nh ch∆∞∆°ng cu·ªëi c√πng trong s√°ch!');
                }
            }

            function initialize() {
                loadSettings();
                loadDictionary();
                loadPostSubstitutions(); 
                renderDictionary();
                renderRuntimeSubstitutions();
                renderPostSubstitutions();
            }

            // Global Event Listeners
            settingsToggle.addEventListener('click', () => {
                const isHidden = advancedSettings.classList.contains('hidden');
                if (isHidden) {
                    advancedSettings.classList.remove('hidden');
                    toggleIcon.textContent = '‚ñ≤';
                } else {
                    advancedSettings.classList.add('hidden');
                    toggleIcon.textContent = '‚ñº';
                }
            });
            
            bookToggle.addEventListener('click', () => {
                const isHidden = bookAnalysisContent.classList.contains('hidden');
                if (isHidden) {
                    bookAnalysisContent.classList.remove('hidden');
                    bookToggleIcon.textContent = '‚ñ≤';
                } else {
                    bookAnalysisContent.classList.add('hidden');
                    bookToggleIcon.textContent = '‚ñº';
                }
            });

            customPromptInput.addEventListener('input', savePrompt);
            addApiKeyBtn.addEventListener('click', addKey);
            newApiKeyInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addKey();
            });
            apiKeyList.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-key-btn')) {
                    const index = e.target.getAttribute('data-index');
                    deleteKey(index);
                }
            });
            
            dictionaryFileInput.addEventListener('change', () => {
                uploadDictionaryBtn.disabled = !dictionaryFileInput.files.length;
                uploadStatus.textContent = '';
            });
            uploadDictionaryBtn.addEventListener('click', handleFileUpload);
            
            bookFileInput.addEventListener('change', handleBookUpload);
            extractChaptersBtn.addEventListener('click', () => {
                if(rawBookContent) extractChapters(rawBookContent.substring(0, MAX_CONTENT_LENGTH));
            });
            nextChapterBtn.addEventListener('click', goToNextChapter);

            // Permanent Dictionary Events
            addWordBtn.addEventListener('click', () => {
                addWord(hanInput.value.trim(), vietInput.value.trim());
                saveDictionary();
                renderDictionary();
                hanInput.value = '';
                vietInput.value = '';
                hanExplainOutput.classList.add('hidden');
                hanInput.focus();
            });
            dictionaryList.addEventListener('click', (e) => {
                 if (e.target.classList.contains('delete-btn')) {
                    const index = e.target.getAttribute('data-index');
                    dictionary.splice(index, 1);
                    saveDictionary();
                    renderDictionary();
                    translateText();
                }
            });
            
            // H√°n -> Vi·ªát Runtime Substitution Events (Batching)
            addRuntimeSubstitutionBtn.addEventListener('click', () => {
                const han = hanReplaceInput.value.trim();
                const viet = vietNewValueInput.value.trim();
                if (addRuntimeSubstitution(han, viet)) {
                    hanReplaceInput.value = '';
                    vietNewValueInput.value = '';
                } else {
                    alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß H√°n t·ª± v√† Nghƒ©a Vi·ªát m·ªõi.');
                }
            });
            runtimeSubstitutionList.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-runtime-btn')) {
                    const index = e.target.getAttribute('data-index');
                    deleteRuntimeSubstitution(index);
                    translateText();
                } else if (e.target.classList.contains('promote-btn')) {
                    const han = e.target.getAttribute('data-han');
                    const viet = e.target.getAttribute('data-viet');
                    promoteToPermanent(han, viet);
                }
            });
            
            // Viet -> Viet Post Substitution Events (Batching and Permanent Save)
            addPostSubstitutionBtn.addEventListener('click', () => {
                const oldVal = vietOldPostInput.value.trim();
                const newVal = vietNewPostInput.value.trim();
                if (addPostSubstitution(oldVal, newVal)) {
                    vietOldPostInput.value = '';
                    vietNewPostInput.value = '';
                } else {
                    alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß C·ª•m t·ª´ Vi·ªát C≈® v√† C·ª•m t·ª´ Vi·ªát M·ªöI.');
                }
            });
            postSubstitutionList.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-post-btn')) {
                    const index = e.target.getAttribute('data-index');
                    deletePostSubstitution(index); 
                    translateText();
                }
            });
            
            // NEW: Unified Batch Apply Button
            applyAllSubstitutionBtn.addEventListener('click', translateText);
            
            aiExplainBtn.addEventListener('click', fetchHanZiExplanation);
            aiTranslateBtn.addEventListener('click', fetchAITranslation);
            translateBtn.addEventListener('click', translateText);
            
            clearBtn.addEventListener('click', () => {
                chineseInput.value = '';
                vietnameseOutput.innerHTML = '<p class="text-gray-400">K·∫øt qu·∫£ d·ªãch s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y...</p>';
                lastManualTranslationOutput = '';
            });


            initialize();
        });
    </script>
</body>
</html>