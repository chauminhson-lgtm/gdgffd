<!-- Chosen Palette: Warm Neutrals & Subtle Blue/Green Accents -->
<!-- Application Structure Plan: Dashboard Layout (Grid) for Edit Mode, Full-Screen Immersive for Reading Mode.
- Row 1: Key Configuration (Novel Manager, Settings) - Two equal columns.
- Row 2: Editing Workspace (Input/Tools) - Two columns (Tools on left, Input on right).
- Row 3: Reading Pane (Result Output) - Single column, dynamically fills remaining screen height for maximum reading space.

Rationale: This structure minimizes scrolling in the Edit Mode by placing tools side-by-side, while the Reading Mode maximizes focus by hiding all non-essential elements and dedicating the entire screen to the chapter content and a fixed control bar. This shift facilitates efficient batch editing/setup followed by comfortable reading/consumption.
-->
<!-- Visualization & Content Choices:
- Novel List -> Goal: Organize -> Presentation: Interactive List (HTML Table/List) -> Interaction: Click to load/select -> Justification: Clear selection/management.
- Translation Content -> Goal: Inform/Change -> Presentation: Text Output (HTML Div) -> Interaction: Real-time update, Post-substitution highlighting -> Justification: Core function, must be dynamic and clear.
- Chapter Structure -> Goal: Organize -> Presentation: Modal List (HTML List) -> Interaction: Click to jump/Auto next/prev -> Justification: Non-linear navigation for large documents.
- NO SVG/Mermaid used. Chart.js/Plotly not applicable as there is no numerical data or visualization required, only text processing and display.
-->
<!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng c·ª• D·ªãch H√°n Vi·ªát C√° nh√¢n h√≥a</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#10b981',
                        'background-light': '#f9fafb',
                        'card-bg': '#ffffff',
                        'text-dark': '#1f2937',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
            color: #1f2937;
        }
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        /* Style for highlighted H√°n Vi·ªát words */
        .han-viet-highlight {
            background-color: #d1fae5; /* Green 100 */
            font-weight: 600;
            padding: 1px 2px;
            border-radius: 2px;
        }
        /* Full-height container setup */
        .full-page-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .main-content-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        @media (min-width: 1024px) {
            .main-content-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        .input-output-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        /* Ensure the final output box grows to fill remaining space */
        #vietnamese-output-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        #vietnamese-output {
            flex-grow: 1;
            height: 100%;
            overflow-y: auto;
        }
        /* Reading Mode specific styles */
        #reading-mode-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: var(--bg-color, #f9fafb); /* Dynamic background */
            color: var(--text-color, #1f2937); /* Dynamic text color */
            z-index: 50;
            display: none; 
            flex-direction: column; /* Use flex to stack header, content, footer */
        }
        #reading-content-wrapper {
            flex-grow: 1;
            overflow-y: auto;
            padding: 2rem 5%;
        }
        #reading-content {
            max-width: 800px;
            margin: 0 auto;
            line-height: var(--line-height, 1.8); /* Dynamic line height */
            font-size: var(--font-size, 16px); /* Dynamic font size */
        }
        
        .sticky-header {
            flex-shrink: 0;
            padding: 1rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            z-index: 60;
        }

        .sticky-footer {
            flex-shrink: 0;
            width: 100%;
            background-color: #ffffff;
            border-top: 1px solid #e5e7eb;
            z-index: 60;
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .modal {
            display: none;
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Overlay */
            z-index: 100; /* Higher Z-index than reading mode */
            align-items: center; /* Center content vertically */
            justify-content: center; /* Center content horizontally */
        }
        .modal-content {
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            max-height: 90vh; /* Ensure modal fits screen */
            overflow-y: auto;
        }
        /* Custom file input styling to hide default button and show custom button */
        .custom-file-upload {
            display: inline-block;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            text-align: center;
            border: 1px solid #d1d5db;
            background-color: #f3f4f6;
            color: #4b5563;
        }
        .custom-file-upload:hover {
            background-color: #e5e7eb;
        }
        .custom-file-upload input[type="file"] {
            display: none;
        }
        /* Style for text formatting */
        .formatted-text p {
            margin-bottom: 1em; /* T·∫°o kho·∫£ng c√°ch gi·ªØa c√°c ƒëo·∫°n */
        }
    </style>
</head>
<body class="full-page-container">

    <!-- MODALS -->

    <!-- Modal for Novel Metadata Input -->
    <div id="novel-metadata-modal" class="modal">
        <div class="modal-content p-6 w-full max-w-lg">
            <h2 class="text-xl font-bold mb-4 text-text-dark">Th√™m Th√¥ng tin Truy·ªán M·ªõi</h2>
            <input type="text" id="novel-title-input" placeholder="T√™n Truy·ªán" class="w-full p-2 mb-3 border border-gray-300 rounded-md">
            <input type="text" id="novel-author-input" placeholder="T√™n T√°c Gi·∫£" class="w-full p-2 mb-3 border border-gray-300 rounded-md">
            <textarea id="novel-description-input" placeholder="Gi·ªõi thi·ªáu/M√¥ t·∫£ ng·∫Øn" rows="3" class="w-full p-2 mb-4 border border-gray-300 rounded-md"></textarea>
            
            <div class="flex justify-end space-x-3">
                <button onclick="saveNovelMetadata()" class="bg-primary text-white p-2 rounded-md font-semibold hover:bg-indigo-600">L∆∞u & T·∫£i truy·ªán</button>
            </div>
        </div>
    </div>

    <!-- Modal for Chapter List (Used in Edit Mode & Reading Mode) -->
    <div id="chapter-list-modal" class="modal">
        <div class="modal-content p-6 w-full max-w-4xl">
            <h2 class="text-xl font-bold mb-4 text-text-dark">M·ª•c l·ª•c Truy·ªán: <span id="modal-novel-title"></span></h2>
            
            <button onclick="editAllTitles()" id="edit-all-titles-btn" class="mb-4 p-2 bg-indigo-100 text-primary rounded-md font-semibold hover:bg-indigo-200 w-full">
                <span class="mr-1">‚úçÔ∏è</span> Ch·ªânh s·ª≠a/D·ªãch ti√™u ƒë·ªÅ th·ªß c√¥ng
            </button>
            
            <div id="chapter-list-container" class="space-y-2 max-h-[70vh] overflow-y-auto p-2 border rounded-md">
                <!-- Chapter list items will be injected here -->
            </div>
            <div class="flex justify-end mt-4">
                <button onclick="closeModal('chapter-list-modal')" class="bg-gray-300 text-text-dark p-2 rounded-md font-semibold hover:bg-gray-400">ƒê√≥ng</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for Viet -> Viet Editing (Used in Reading Mode) -->
    <div id="viet-viet-modal" class="modal">
        <div class="modal-content p-6 w-full max-w-2xl">
            <h2 class="text-xl font-bold mb-4 text-text-dark">üîß Tinh ch·ªânh Thu·∫≠t ng·ªØ (Vi·ªát -> Vi·ªát)</h2>
            <div class="space-y-4">
                <input type="text" id="vv-original-input" placeholder="T·ª´ Vi·ªát C≈© (C·∫ßn thay th·∫ø)" class="w-full p-2 border border-gray-300 rounded-md">
                <input type="text" id="vv-replacement-input" placeholder="T·ª´ Vi·ªát M·ªõi (Thay th·∫ø)" class="w-full p-2 border border-gray-300 rounded-md">
                <button onclick="addVietVietRuleFromModal();" class="bg-secondary text-white p-2 rounded-md font-semibold w-full hover:bg-emerald-600">Th√™m & √Åp d·ª•ng ngay</button>
            </div>
            <h3 class="font-semibold mt-6 mb-2">Danh s√°ch Thu·∫≠t ng·ªØ ƒë√£ l∆∞u Vƒ©nh vi·ªÖn:</h3>
            <div id="vv-list-container" class="max-h-60 overflow-y-auto border p-3 rounded-md">
                <!-- Viet-Viet rules will be injected here -->
            </div>
            <div class="flex justify-end mt-4">
                <button onclick="closeModal('viet-viet-modal')" class="bg-gray-300 text-text-dark p-2 rounded-md font-semibold hover:bg-gray-400">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Modal for Reading Style Settings (Used in Reading Mode Taskbar) -->
    <div id="style-settings-modal" class="modal">
        <div class="modal-content p-6 w-full max-w-lg">
            <h2 class="text-xl font-bold mb-4 text-text-dark">‚öôÔ∏è T√πy ch·ªânh Giao di·ªán ƒê·ªçc</h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">C·ª° ch·ªØ (px):</label>
                    <input type="number" id="setting-font-size" onchange="saveReadingStyle()" min="12" max="30" class="w-full p-2 border rounded-md" value="16">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Chi·ªÅu cao d√≤ng:</label>
                    <input type="number" id="setting-line-height" onchange="saveReadingStyle()" min="1.0" max="2.5" step="0.1" class="w-full p-2 border rounded-md" value="1.8">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">M√†u n·ªÅn (Hex/Name):</label>
                    <input type="text" id="setting-bg-color" onchange="saveReadingStyle()" class="w-full p-2 border rounded-md" value="#f9fafb">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">M√†u ch·ªØ (Hex/Name):</label>
                    <input type="text" id="setting-text-color" onchange="saveReadingStyle()" class="w-full p-2 border rounded-md" value="#1f2937">
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button onclick="closeModal('style-settings-modal')" class="bg-gray-300 text-text-dark p-2 rounded-md font-semibold hover:bg-gray-400">ƒê√≥ng</button>
            </div>
        </div>
    </div>


    <!-- Reading Mode Container (Full Screen) -->
    <div id="reading-mode-container">
        <header class="sticky-header">
            <div class="max-w-4xl mx-auto flex justify-between items-center">
                <button onclick="exitReadingMode()" class="px-4 py-2 bg-gray-200 rounded-md text-sm font-semibold hover:bg-gray-300">&larr; Tr·ªü l·∫°i Bi√™n t·∫≠p</button>
                <h1 id="reading-chapter-title" class="text-xl font-bold text-center text-text-dark truncate max-w-sm sm:max-w-lg"></h1>
                <div class="flex space-x-2">
                    <button onclick="navigateChapter(-1)" class="p-2 bg-gray-100 rounded-full hover:bg-gray-200 disabled:opacity-50" id="prev-chapter-btn-read" title="Ch∆∞∆°ng tr∆∞·ªõc">&lt;</button>
                    <button onclick="navigateChapter(1)" class="p-2 bg-gray-100 rounded-full hover:bg-gray-200 disabled:opacity-50" id="next-chapter-btn-read" title="Ch∆∞∆°ng ti·∫øp theo">&gt;</button>
                </div>
            </div>
        </header>
        
        <div id="reading-content-wrapper" class="flex-grow">
            <div id="reading-content" class="text-base formatted-text">
                <!-- D·ªãch ho√†n ch·ªânh s·∫Ω ƒë∆∞·ª£c ƒë∆∞a v√†o ƒë√¢y -->
            </div>
        </div>


        <!-- Sticky Footer Taskbar for Reading Mode -->
        <footer id="reading-footer" class="sticky-footer">
            <div class="flex items-center space-x-4">
                <button onclick="openModal('chapter-list-modal'); renderChapterList('chapter-list-container');" class="p-2 text-sm font-semibold rounded-md bg-secondary text-white hover:bg-emerald-600">
                    <span class="mr-2">üìö</span> M·ª•c l·ª•c
                </button>
                <button onclick="openModal('style-settings-modal')" class="p-2 text-sm font-semibold rounded-md bg-gray-100 hover:bg-gray-200">
                    <span class="mr-2">üé®</span> T√πy ch·ªânh ƒê·ªçc
                </button>
                <button onclick="openModal('viet-viet-modal'); renderVietVietRules('vv-list-container', true);" class="p-2 text-sm font-semibold rounded-md bg-gray-100 hover:bg-gray-200">
                    <span class="mr-2">üîß</span> Thu·∫≠t ng·ªØ
                </button>
                <button onclick="downloadChapter()" class="p-2 text-sm font-semibold rounded-md bg-gray-100 hover:bg-gray-200">
                    <span class="mr-2">‚¨áÔ∏è</span> T·∫£i Ch∆∞∆°ng
                </button>
                <button onclick="downloadBook()" class="p-2 text-sm font-semibold rounded-md bg-gray-100 hover:bg-gray-200">
                    <span class="mr-2">‚¨áÔ∏è</span> T·∫£i To√†n b·ªô
                </button>
            </div>
            <div id="reading-status" class="text-sm font-medium text-indigo-600">
                <!-- Tr·∫°ng th√°i d·ªãch s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
            </div>
            <button onclick="startAITranslation()" class="px-4 py-2 text-sm font-semibold rounded-md bg-primary text-white hover:bg-indigo-600">
                <span class="mr-2">üîÑ</span> D·ªãch l·∫°i Ch∆∞∆°ng
            </button>
        </footer>
    </div>
    
    <!-- Main Editing Container -->
    <main class="container mx-auto p-4 flex-grow" id="edit-mode-container">
        <h1 class="text-3xl font-bold mb-4 text-center text-text-dark">C√¥ng c·ª• D·ªãch H√°n Vi·ªát C√° nh√¢n h√≥a (Local Storage)</h1>
        
        <!-- C·∫¢NH B√ÅO LOCAL STORAGE -->
        <div id="storage-warning" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 rounded-md" role="alert">
            <p class="font-bold">C·∫¢NH B√ÅO L∆ØU TR·ªÆ C·ª§C B·ªò:</p>
            <p class="text-sm">·ª®ng d·ª•ng ƒëang s·ª≠ d·ª•ng **L∆∞u tr·ªØ C·ª•c b·ªô (Local Storage)**. D·ªØ li·ªáu (Truy·ªán, Ch∆∞∆°ng ƒë√£ d·ªãch) ƒë∆∞·ª£c l∆∞u tr√™n tr√¨nh duy·ªát n√†y v√† **KH√îNG** chia s·∫ª ƒë∆∞·ª£c gi·ªØa c√°c thi·∫øt b·ªã/tr√¨nh duy·ªát kh√°c. H√£y s·ª≠ d·ª•ng t√≠nh nƒÉng T·∫£i xu·ªëng ƒë·ªÉ sao l∆∞u.</p>
        </div>

        <!-- H√ÄNG 1: C·∫§U H√åNH (Qu·∫£n l√Ω truy·ªán & C√†i ƒë·∫∑t) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            
            <!-- Qu·∫£n l√Ω Truy·ªán (Giao di·ªán ƒë∆°n gi·∫£n) -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-200">
                <h2 class="text-xl font-bold mb-4 text-primary">üìë T·∫£i l√™n S√°ch & Ph√¢n t√≠ch Ch∆∞∆°ng</h2>
                <p class="text-gray-600 mb-4">T·∫£i l√™n t·ªáp (.txt) ch·ª©a to√†n b·ªô n·ªôi dung truy·ªán ti·∫øng Trung.</p>
                
                <div class="flex space-x-2">
                    <label class="custom-file-upload flex-1">
                        <input type="file" id="book-upload" accept=".txt">
                        Ch·ªçn T·ªáp S√°ch...
                    </label>
                    <button id="extract-chapters-btn" onclick="startChapterAnalysis()" class="flex-1 p-2 bg-primary text-white rounded-md font-semibold hover:bg-indigo-600 disabled:opacity-50" disabled>
                        <span class="mr-1">‚ú®</span> AI Ph√¢n t√≠ch & D·ªãch Ti√™u ƒë·ªÅ
                    </button>
                </div>
                
                <!-- Hi·ªÉn th·ªã th√¥ng tin truy·ªán ƒëang ho·∫°t ƒë·ªông -->
                <div id="current-novel-info" class="mt-4 p-3 bg-gray-50 border rounded-md hidden">
                    <div class="flex justify-between items-center">
                        <p class="text-sm font-medium text-text-dark">ƒêang l√†m vi·ªác: <span id="current-novel-title" class="font-semibold text-primary">Ch∆∞a t·∫£i</span></p>
                        <button onclick="deleteNovel()" class="text-red-500 hover:text-red-700 text-xs font-semibold" id="delete-novel-btn">X√≥a Truy·ªán</button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">T·ªïng Ch∆∞∆°ng: <span id="total-chapters">0</span> | ƒê√£ d·ªãch: <span id="translated-chapters">0</span></p>
                </div>
                
                <!-- N√∫t M·ª•c l·ª•c cho c√°c truy·ªán ƒë√£ l∆∞u -->
                <div class="mt-4 border-t pt-4">
                    <button onclick="openModal('chapter-list-modal'); renderNovelManagerModal();" class="w-full p-2 bg-gray-200 text-text-dark rounded-md font-semibold hover:bg-gray-300">
                        üìö M·ª•c l·ª•c Truy·ªán ƒë√£ L∆∞u
                    </button>
                </div>

                <div id="chapter-nav-display" class="mt-4 p-3 bg-gray-50 border rounded-md hidden">
                    <p class="text-sm font-medium text-text-dark">ƒêang xem: <span id="current-chapter-title" class="font-semibold text-primary"></span></p>
                    <button onclick="openModal('chapter-list-modal'); renderChapterList('chapter-list-container');" class="mt-2 text-sm text-primary font-semibold hover:underline">Xem M·ª•c l·ª•c chi ti·∫øt</button>
                    <!-- N√∫t Quay l·∫°i ƒê·ªçc -->
                    <button onclick="enterReadingMode(true)" id="back-to-reading-btn" class="hidden mt-2 ml-4 text-sm bg-indigo-100 text-primary font-semibold p-1 rounded hover:bg-indigo-200">Ti·∫øp t·ª•c ƒê·ªçc</button>
                </div>
            </div>

            <!-- C√†i ƒë·∫∑t N√¢ng cao -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-200">
                <h2 class="text-xl font-bold mb-4 text-primary">‚öôÔ∏è C√†i ƒë·∫∑t N√¢ng cao (API & Prompt)</h2>
                <div class="space-y-4">
                    
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-1">Qu·∫£n l√Ω API Keys</h3>
                        <div class="flex space-x-2 mb-2">
                            <input type="text" id="api-key-input" placeholder="Nh·∫≠p Gemini API Key" class="flex-grow p-2 border border-gray-300 rounded-md">
                            <button onclick="addApiKey()" class="bg-secondary text-white p-2 rounded-md font-semibold hover:bg-emerald-600">Th√™m Kh√≥a</button>
                        </div>
                        <div id="api-key-list" class="text-xs space-y-1 max-h-24 overflow-y-auto p-1 border rounded-md bg-gray-50">
                            <!-- Keys will be listed here -->
                        </div>
                        <p class="text-xs text-gray-500 mt-1">C√°c kh√≥a s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông l∆∞u v√† xoay v√≤ng khi c√≥ l·ªói.</p>
                    </div>

                    <div>
                        <h3 class="font-semibold text-gray-700 mb-1">Custom Prompt</h3>
                        <textarea id="system-prompt-input" onchange="saveGeneralSettings()" rows="3" placeholder="Y√™u c·∫ßu ƒë·∫∑c bi·ªát cho AI (v√≠ d·ª•: 'D·ªãch theo phong c√°ch ki·∫øm hi·ªáp c·ªï trang...')" class="w-full p-2 border border-gray-300 rounded-md"></textarea>
                        <p class="text-xs text-gray-500">T·ª± ƒë·ªông l∆∞u. ƒêi·ªÅu ch·ªânh phong c√°ch v√† gi·ªçng ƒëi·ªáu b·∫£n d·ªãch cu·ªëi c√πng.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- H√ÄNG 2: KHU V·ª∞C L√ÄM VI·ªÜC (Tools & Input) -->
        <div class="main-content-grid">
            
            <!-- C·ªòT TR√ÅI: C√îNG C·ª§ TINH CH·ªàNH V√Ä T·ª™ ƒêI·ªÇN -->
            <div class="space-y-6">
                
                <!-- 1. H√°n -> Vi·ªát Tinh ch·ªânh T·∫°m th·ªùi -->
                <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-200">
                    <h2 class="text-xl font-bold mb-4 text-primary">1. H√°n -> Vi·ªát (Tinh ch·ªânh T·∫°m th·ªùi)</h2>
                    <div class="space-y-3">
                        <input type="text" id="han-original-input" placeholder="H√°n t·ª± g·ªëc (V√≠ d·ª•: 'ÈÅì')" class="w-full p-2 border border-gray-300 rounded-md">
                        <input type="text" id="han-replacement-input" placeholder="Nghƒ©a Vi·ªát m·ªõi (V√≠ d·ª•: 'ƒê·∫°o')" class="w-full p-2 border border-gray-300 rounded-md">
                        <button onclick="addHanVietTempRule()" class="bg-secondary text-white p-2 rounded-md font-semibold w-full hover:bg-emerald-600">Th√™m v√†o Danh s√°ch T·∫°m</button>
                    </div>
                    <div id="han-viet-temp-list" class="mt-4 space-y-2 max-h-32 overflow-y-auto p-1 border rounded-md">
                        <!-- Temporary Han-Viet rules will be injected here -->
                    </div>
                    <p class="text-xs text-gray-500 mt-2">C√°c tinh ch·ªânh n√†y ch·ªâ ƒë∆∞·ª£c √°p d·ª•ng khi b·∫°n nh·∫•n "√Åp d·ª•ng & D·ªãch l·∫°i".</p>
                </div>

                <!-- 2. Vi·ªát -> Vi·ªát (H·∫≠u k·ª≥) - L∆∞u Vƒ©nh Vi·ªÖn -->
                <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-200">
                    <h2 class="text-xl font-bold mb-4 text-primary">2. Vi·ªát -> Vi·ªát (H·∫≠u k·ª≥) - L∆∞u Vƒ©nh Vi·ªÖn</h2>
                    <div class="space-y-3">
                        <!-- S·ª≠ d·ª•ng input edit cho ch·∫ø ƒë·ªô bi√™n t·∫≠p -->
                        <input type="text" id="vv-original-input-edit" placeholder="T·ª´ Vi·ªát C≈© (C·∫ßn thay th·∫ø)" class="w-full p-2 border border-gray-300 rounded-md">
                        <input type="text" id="vv-replacement-input-edit" placeholder="T·ª´ Vi·ªát M·ªõi (Thay th·∫ø)" class="w-full p-2 border border-gray-300 rounded-md">
                        <button onclick="addVietVietRule()" class="bg-secondary text-white p-2 rounded-md font-semibold w-full hover:bg-emerald-600">Th√™m & L∆∞u Vƒ©nh vi·ªÖn</button>
                    </div>
                    <h3 class="font-semibold mt-4 mb-2 text-gray-700">Danh s√°ch Thu·∫≠t ng·ªØ ƒë√£ l∆∞u:</h3>
                    <div id="vv-list-container-edit" class="max-h-32 overflow-y-auto border p-3 rounded-md">
                        <!-- Viet-Viet rules will be injected here -->
                    </div>
                    <p class="text-xs text-gray-500 mt-2">C√°c quy t·∫Øc n√†y ƒë∆∞·ª£c l∆∞u vƒ©nh vi·ªÖn v√† √°p d·ª•ng cho m·ªçi ch∆∞∆°ng.</p>
                </div>

                <!-- T·ª´ ƒëi·ªÉn C√° nh√¢n (H√°n -> Vi·ªát Vƒ©nh Vi·ªÖn) -->
                <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-200">
                    <h2 class="text-xl font-bold mb-4 text-primary">üìñ T·ª´ ƒëi·ªÉn H√°n Vi·ªát c·ªßa b·∫°n (Vƒ©nh Vi·ªÖn)</h2>
                    <div class="flex space-x-2">
                         <input type="file" id="dict-upload" accept=".txt,.csv" class="flex-grow block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-200 file:text-gray-700 hover:file:bg-gray-300">
                        <button onclick="downloadDictionary()" class="p-2 bg-gray-200 rounded-md font-semibold text-gray-700 hover:bg-gray-300 text-sm whitespace-nowrap">T·∫£i xu·ªëng</button>
                    </div>
                    <div id="dictionary-list" class="mt-4 space-y-1 max-h-40 overflow-y-auto p-2 border rounded-md bg-gray-50">
                        <!-- Dictionary entries will be injected here -->
                    </div>
                    <p class="text-xs text-gray-500 mt-2">C√°c c·∫∑p t·ª´ n√†y ƒë∆∞·ª£c l∆∞u vƒ©nh vi·ªÖn v√† d√πng l√†m n·ªÅn t·∫£ng d·ªãch H√°n Vi·ªát.</p>
                </div>

            </div>

            <!-- C·ªòT PH·∫¢I: KHU V·ª∞C NH·∫¨P V√Ä X·ª¨ L√ù D·ªäCH -->
            <div class="flex flex-col space-y-4">
                <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-200 h-full flex flex-col">
                    <h2 class="text-xl font-bold mb-4 text-primary">C√¥ng c·ª• D·ªãch & N·ªôi dung Ch∆∞∆°ng</h2>
                    <textarea id="chinese-input" rows="8" placeholder="D√°n vƒÉn b·∫£n ti·∫øng Trung (n·ªôi dung ch∆∞∆°ng) v√†o ƒë√¢y ho·∫∑c ch·ªçn m·ªôt ch∆∞∆°ng t·ª´ M·ª•c l·ª•c..." class="w-full p-3 border border-gray-300 rounded-md text-base flex-grow font-mono"></textarea>
                    
                    <div class="mt-4 flex flex-col space-y-3">
                        <button onclick="startHanVietTranslation()" class="w-full p-3 bg-indigo-200 text-primary rounded-md font-semibold hover:bg-indigo-300 disabled:opacity-50" id="han-viet-translate-btn">
                            √Åp d·ª•ng & D·ªãch H√°n Vi·ªát (Batch Apply)
                        </button>
                        <button onclick="startAITranslation()" class="w-full p-3 bg-primary text-white rounded-md font-semibold hover:bg-indigo-600 disabled:opacity-50" id="ai-translate-btn">
                            <span class="mr-1">‚ú®</span> AI D·ªãch Ho√†n Ch·ªânh & Tr√¥i Ch·∫£y
                        </button>
                    </div>
                    <div id="translation-progress" class="mt-3 text-sm text-center text-indigo-600 hidden">ƒêang chia ƒëo·∫°n v√† d·ªãch song song...</div>
                    <div id="error-message" class="mt-3 text-sm text-red-600 text-center hidden p-2 bg-red-100 rounded-md"></div>
                </div>
            </div>
        </div>

        <!-- H√ÄNG 3: K·∫æT QU·∫¢ D·ªäCH (Tr·∫£i r·ªông h·∫øt trang) -->
        <div id="vietnamese-output-wrapper" class="mt-6">
            <h2 class="text-xl font-bold mb-3 text-text-dark">K·∫øt qu·∫£ D·ªãch thu·∫≠t:</h2>
            <div id="vietnamese-output" class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-200 overflow-y-auto text-base">
                <p class="text-gray-500">K·∫øt qu·∫£ d·ªãch s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y. Vui l√≤ng t·∫£i s√°ch, ch·ªçn ch∆∞∆°ng ho·∫∑c d√°n vƒÉn b·∫£n ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
            </div>
        </div>
        
    </main>

    <script>
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
        const HAN_VIET_DICT_KEY = 'hanVietDictionary';
        const VIET_VIET_RULES_KEY = 'vietVietRules';
        const API_KEYS_KEY = 'geminiApiKeys';
        const GENERAL_SETTINGS_KEY = 'generalSettings';
        const NOVEL_DATA_KEY = 'novelManagerData';
        const READING_STYLE_KEY = 'readingStyle';

        const MAX_AI_ANALYSIS_LENGTH = 200000; // Ph√¢n t√≠ch ch∆∞∆°ng
        const MAX_BOOK_CONTENT_LENGTH = 20000000;
        const MAX_API_RETRIES = 5; 
        const API_CALL_DELAY_MS = 500; 
        const JSON_API_DELAY_MS = 750; // ƒê·ªô tr·ªÖ cao h∆°n cho c√°c l·ªánh g·ªçi JSON ph·ª©c t·∫°p (ph√¢n t√≠ch ch∆∞∆°ng)

        let hanVietDictionary = {};
        let vietVietRules = [];
        let apiKeys = [];
        
        let generalSettings = { prompt: "D·ªãch vƒÉn b·∫£n ti·∫øng Trung sau ƒë√¢y sang ti·∫øng Vi·ªát. H√£y gi·ªØ nguy√™n nghƒ©a v√† t·∫°o ra m·ªôt b·∫£n d·ªãch tr√¥i ch·∫£y, t·ª± nhi√™n. Tr·∫£ l·ªùi b·∫±ng vƒÉn b·∫£n thu·∫ßn t√∫y ti·∫øng Vi·ªát, kh√¥ng th√™m l·ªùi gi·∫£i th√≠ch hay b·∫•t k·ª≥ n·ªôi dung n√†o kh√°c." };
        let hanVietTempRules = {}; 
        let novelManagerData = {}; 
        let appState = {
            selectedNovelId: null,
            selectedChapterIndex: null,
            currentChapterContent: "",
            currentHanVietOutput: "",
            isReadingMode: false,
            readingStyle: { fontSize: '16px', lineHeight: 1.8, bgColor: '#f9fafb', textColor: '#1f2937' }
        };

        // --- CORE UTILITIES ---

        function getAppState() {
            return JSON.parse(localStorage.getItem('appState')) || appState;
        }

        function saveAppState() {
            localStorage.setItem('appState', JSON.stringify(appState));
        }

        function loadFromLocalStorage() {
            // Load all persistent data
            hanVietDictionary = JSON.parse(localStorage.getItem(HAN_VIET_DICT_KEY)) || {};
            vietVietRules = JSON.parse(localStorage.getItem(VIET_VIET_RULES_KEY)) || [];
            apiKeys = JSON.parse(localStorage.getItem(API_KEYS_KEY)) || [];
            
            // Load settings
            const loadedSettings = JSON.parse(localStorage.getItem(GENERAL_SETTINGS_KEY));
            if (loadedSettings) {
                generalSettings.prompt = loadedSettings.prompt || generalSettings.prompt;
            }

            novelManagerData = JSON.parse(localStorage.getItem(NOVEL_DATA_KEY)) || {};

            // Load App State
            const savedState = getAppState();
            appState = { ...appState, ...savedState };

            // Load Reading Style and apply immediately
            const savedStyle = JSON.parse(localStorage.getItem(READING_STYLE_KEY));
            if (savedStyle) {
                savedStyle.fontSize = savedStyle.fontSize.toString().endsWith('px') ? savedStyle.fontSize : savedStyle.fontSize + 'px';
                appState.readingStyle = savedStyle;
            }
            applyReadingStyle();

            // Render UI components
            renderDictionary();
            renderVietVietRules('vv-list-container-edit', false);
            renderApiKeys();
            loadGeneralSettingsUI();
            
            // Render Novel Manager Info
            updateNovelInfoDisplay();
            if (appState.selectedNovelId && novelManagerData[appState.selectedNovelId]) {
                loadSelectedNovel();
            }

            // Bind Event Listeners
            document.getElementById('book-upload').addEventListener('change', handleBookUpload);
            document.getElementById('dict-upload').addEventListener('change', handleDictionaryUpload);
            document.getElementById('api-key-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') addApiKey();
            });

            // Initial UI Setup
            updateUIState();
        }

        function saveGeneralSettings() {
            generalSettings.prompt = document.getElementById('system-prompt-input').value;
            localStorage.setItem(GENERAL_SETTINGS_KEY, JSON.stringify(generalSettings));
        }

        function loadGeneralSettingsUI() {
            document.getElementById('system-prompt-input').value = generalSettings.prompt;
        }

        function updateUIState() {
            const isNovelLoaded = appState.selectedNovelId && novelManagerData[appState.selectedNovelId];
            
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i hi·ªÉn th·ªã
            updateNovelInfoDisplay();

            // Enable/Disable buttons based on novel state
            document.getElementById('extract-chapters-btn').disabled = !isNovelLoaded; 
            document.getElementById('han-viet-translate-btn').disabled = !isNovelLoaded && !document.getElementById('chinese-input').value.trim();
            document.getElementById('ai-translate-btn').disabled = !isNovelLoaded && !document.getElementById('chinese-input').value.trim();

            const chapterNavDisplay = document.getElementById('chapter-nav-display');
            const backToReadingBtn = document.getElementById('back-to-reading-btn');

            if (isNovelLoaded && novelManagerData[appState.selectedNovelId].chapters.length > 0) {
                chapterNavDisplay.classList.remove('hidden');
                
                const chapterKey = `chapter_${appState.selectedChapterIndex}`;
                const translationExists = novelManagerData[appState.selectedNovelId].translations[chapterKey];
                
                if (translationExists && !appState.isReadingMode) {
                    backToReadingBtn.classList.remove('hidden');
                } else {
                    backToReadingBtn.classList.add('hidden');
                }

            } else {
                chapterNavDisplay.classList.add('hidden');
                backToReadingBtn.classList.add('hidden');
            }

            // FIX 2: Correctly handle reading mode display
            if (appState.isReadingMode) {
                document.getElementById('edit-mode-container').style.display = 'none';
                document.getElementById('reading-mode-container').style.display = 'flex'; 
                applyReadingStyle();
            } else {
                document.getElementById('edit-mode-container').style.display = 'block';
                document.getElementById('reading-mode-container').style.display = 'none';
            }
        }

        // --- API KEY MANAGEMENT ---

        function addApiKey() {
            const keyInput = document.getElementById('api-key-input');
            const newKey = keyInput.value.trim();
            if (newKey && !apiKeys.includes(newKey)) {
                apiKeys.push(newKey);
                localStorage.setItem(API_KEYS_KEY, JSON.stringify(apiKeys));
                keyInput.value = '';
                renderApiKeys();
            }
        }

        function removeApiKey(key) {
            apiKeys = apiKeys.filter(k => k !== key);
            localStorage.setItem(API_KEYS_KEY, JSON.stringify(apiKeys));
            renderApiKeys();
        }

        function renderApiKeys() {
            const listContainer = document.getElementById('api-key-list');
            listContainer.innerHTML = apiKeys.map(key => `
                <div class="flex justify-between items-center bg-white p-1 rounded-md">
                    <span class="truncate">...${key.slice(-4)}</span>
                    <button onclick="removeApiKey('${key}')" class="text-red-500 hover:text-red-700 text-xs ml-2">X√≥a</button>
                </div>
            `).join('');
            if (apiKeys.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-400 p-2 text-center">Ch∆∞a c√≥ Kh√≥a API n√†o ƒë∆∞·ª£c l∆∞u.</p>';
            }
        }


        // --- NOVEL MANAGEMENT ---

        function updateNovelInfoDisplay() {
            const infoDiv = document.getElementById('current-novel-info');
            const novel = appState.selectedNovelId ? novelManagerData[appState.selectedNovelId] : null;

            if (novel) {
                infoDiv.classList.remove('hidden');
                document.getElementById('current-novel-title').textContent = novel.metadata.title;
                document.getElementById('total-chapters').textContent = novel.chapters.length;
                
                const translatedCount = Object.keys(novel.translations).length;
                document.getElementById('translated-chapters').textContent = translatedCount;
            } else {
                infoDiv.classList.add('hidden');
            }
        }

        function renderNovelManagerModal() {
            const container = document.getElementById('chapter-list-container');
            container.innerHTML = ' '; // Clear previous chapter list
            document.getElementById('modal-novel-title').textContent = 'Danh s√°ch Truy·ªán ƒë√£ L∆∞u';

            const novelIds = Object.keys(novelManagerData);

            if (novelIds.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">B·∫°n ch∆∞a t·∫£i l√™n truy·ªán n√†o.</p>';
                return;
            }

            const listHtml = novelIds.map(id => {
                const novel = novelManagerData[id];
                const isSelected = id === appState.selectedNovelId;
                const translatedCount = Object.keys(novel.translations).length;
                
                return `
                    <div class="p-3 border rounded-md ${isSelected ? 'bg-indigo-100 border-indigo-600' : 'bg-white'} flex justify-between items-center hover:bg-indigo-50 cursor-pointer" onclick="loadNovelFromModal('${id}')">
                        <div>
                            <p class="font-semibold text-text-dark">${novel.metadata.title}</p>
                            <p class="text-xs text-gray-500">T√°c gi·∫£: ${novel.metadata.author || 'V√¥ danh'} | Ch∆∞∆°ng: ${novel.chapters.length} | ƒê√£ d·ªãch: ${translatedCount}</p>
                        </div>
                        <div class="flex space-x-2 items-center">
                            ${isSelected ? '<span class="text-xs font-bold text-indigo-600">ƒêang ho·∫°t ƒë·ªông</span>' : ''}
                            <button onclick="event.stopPropagation(); deleteNovel('${id}')" class="text-red-500 hover:text-red-700 text-xs font-semibold p-1 rounded-full bg-red-100">X√≥a</button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = listHtml;
            document.getElementById('edit-all-titles-btn').classList.add('hidden'); // Hide edit title button in novel list view
        }

        function loadNovelFromModal(novelId) {
            appState.selectedNovelId = novelId;
            appState.selectedChapterIndex = null;
            saveAppState();
            loadSelectedNovel();
            closeModal('chapter-list-modal');
        }


        function loadSelectedNovel() {
            const novelId = appState.selectedNovelId;
            const novel = novelManagerData[novelId];

            if (novel) {
                document.getElementById('current-novel-title').textContent = novel.metadata.title;
                
                if (novel.chapters.length > 0) {
                    // Load first chapter if available and not set
                    if (appState.selectedChapterIndex === null || appState.selectedChapterIndex >= novel.chapters.length) {
                        selectChapter(0);
                    } else if (appState.selectedChapterIndex !== null) {
                        selectChapter(appState.selectedChapterIndex); // Reload current chapter
                    }
                } else {
                    document.getElementById('chinese-input').value = novel.rawContent; 
                    document.getElementById('vietnamese-output').innerHTML = '<p class="text-gray-500">ƒê√£ t·∫£i n·ªôi dung truy·ªán. Vui l√≤ng nh·∫•n "AI Ph√¢n t√≠ch & D·ªãch Ti√™u ƒë·ªÅ" ƒë·ªÉ x√°c ƒë·ªãnh c√°c ch∆∞∆°ng.</p>';
                    appState.currentChapterContent = novel.rawContent;
                }
            } else {
                appState.selectedNovelId = null;
                appState.selectedChapterIndex = null;
                appState.currentHanVietOutput = "";
                document.getElementById('chinese-input').value = '';
                document.getElementById('vietnamese-output').innerHTML = '<p class="text-gray-500">Vui l√≤ng ch·ªçn ho·∫∑c t·∫£i l√™n m·ªôt truy·ªán.</p>';
                appState.currentChapterContent = "";
            }
            saveAppState();
            updateUIState();
        }
        
        function deleteNovel(novelIdToDelete = appState.selectedNovelId) {
            const novel = novelManagerData[novelIdToDelete];
            if (!novel || !confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a truy·ªán "${novel.metadata.title}" v√† to√†n b·ªô b·∫£n d·ªãch ƒë√£ l∆∞u?`)) {
                return;
            }

            delete novelManagerData[novelIdToDelete];
            localStorage.setItem(NOVEL_DATA_KEY, JSON.stringify(novelManagerData));
            
            if (novelIdToDelete === appState.selectedNovelId) {
                 appState.selectedNovelId = null;
                 appState.selectedChapterIndex = null;
                 appState.currentHanVietOutput = "";
                 loadSelectedNovel(); // Reset view
            }
            
            updateUIState();
            
            // Re-render modal if open
            if(document.getElementById('chapter-list-modal').style.display !== 'none') {
                renderNovelManagerModal();
            }
        }

        // --- BOOK UPLOAD & METADATA ---
        
        function handleBookUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                 document.getElementById('extract-chapters-btn').disabled = true;
                 return;
            }

            if (file.size > MAX_BOOK_CONTENT_LENGTH) {
                alert(`L·ªói: K√≠ch th∆∞·ªõc t·ªáp qu√° l·ªõn (${(file.size / 1024 / 1024).toFixed(2)} MB). Gi·ªõi h·∫°n l√† ${(MAX_BOOK_CONTENT_LENGTH / 1024 / 1024).toFixed(2)} MB.`);
                 document.getElementById('extract-chapters-btn').disabled = true;
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const rawContent = e.target.result;
                document.getElementById('chinese-input').value = rawContent;
                document.getElementById('novel-title-input').value = file.name.replace(/\.[^/.]+$/, ""); // Pre-fill title
                openModal('novel-metadata-modal');
                // Store raw content temporarily
                document.getElementById('novel-metadata-modal').dataset.rawContent = rawContent;
                 document.getElementById('extract-chapters-btn').disabled = false; // Enable extraction button after load
            };
            reader.readAsText(file, 'UTF-8');
        }

        function saveNovelMetadata() {
            const title = document.getElementById('novel-title-input').value.trim();
            const author = document.getElementById('novel-author-input').value.trim();
            const description = document.getElementById('novel-description-input').value.trim();
            const rawContent = document.getElementById('novel-metadata-modal').dataset.rawContent;

            if (!title || !rawContent) {
                alert("Vui l√≤ng nh·∫≠p T√™n Truy·ªán.");
                return;
            }

            const novelId = crypto.randomUUID();
            const chapters = []; 

            novelManagerData[novelId] = {
                metadata: { title, author, description, uploadedAt: new Date().toISOString() },
                rawContent: rawContent,
                chapters: chapters,
                translations: {}
            };
            localStorage.setItem(NOVEL_DATA_KEY, JSON.stringify(novelManagerData));
            
            closeModal('novel-metadata-modal');
            appState.selectedNovelId = novelId;
            appState.selectedChapterIndex = null;
            appState.currentHanVietOutput = "";
            saveAppState();
            updateUIState();
            
            // Auto start AI analysis for chapters
            startChapterAnalysis();
        }


        // --- CHAPTER EXTRACTION (AI & MANUAL) ---
        
        function getChapterContent(novel, index) {
            const chapters = novel.chapters;
            if (index < 0 || index >= chapters.length) return "";

            const startMarker = chapters[index].startMarker;
            const startIndex = novel.rawContent.indexOf(startMarker);

            if (startIndex === -1) return "";

            let endIndex = novel.rawContent.length;
            if (index < chapters.length - 1) {
                const nextStartMarker = chapters[index + 1].startMarker;
                // Start search for next marker *after* the current marker's length to prevent self-match
                const nextStartIndex = novel.rawContent.indexOf(nextStartMarker, startIndex + startMarker.length); 
                if (nextStartIndex !== -1) {
                    endIndex = nextStartIndex;
                }
            }
            return novel.rawContent.substring(startIndex, endIndex).trim();
        }

        function selectChapter(index) {
            const novel = novelManagerData[appState.selectedNovelId];
            if (!novel || index < 0 || index >= novel.chapters.length) return;

            appState.selectedChapterIndex = index;
            appState.currentHanVietOutput = ""; 
            saveAppState();

            const chapterTitle = novel.chapters[index].title_vi || novel.chapters[index].title_cn;
            document.getElementById('current-chapter-title').textContent = chapterTitle;
            
            const chapterKey = `chapter_${index}`;
            appState.currentChapterContent = getChapterContent(novel, index);

            if (novel.translations[chapterKey]) {
                document.getElementById('chinese-input').value = appState.currentChapterContent;
                document.getElementById('vietnamese-output').innerHTML = formatTranslatedText(novel.translations[chapterKey].translatedText);
                document.getElementById('ai-translate-btn').disabled = false; 
            } else {
                document.getElementById('chinese-input').value = appState.currentChapterContent;
                document.getElementById('vietnamese-output').innerHTML = `<p class="text-gray-500">ƒê√£ t·∫£i Ch∆∞∆°ng ${index + 1}. Vui l√≤ng nh·∫•n "√Åp d·ª•ng & D·ªãch H√°n Vi·ªát" ho·∫∑c "AI D·ªãch Ho√†n Ch·ªânh".</p>`;
                document.getElementById('ai-translate-btn').disabled = false;
            }
            updateUIState();
            hanVietTempRules = {};
            renderHanVietTempRules();
        }

        function renderChapterList(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            const novel = novelManagerData[appState.selectedNovelId];
            if (!novel) {
                 container.innerHTML = '<p class="text-center text-gray-500">Vui l√≤ng t·∫£i l√™n m·ªôt truy·ªán ƒë·ªÉ xem M·ª•c l·ª•c.</p>';
                 return;
            }

            document.getElementById('modal-novel-title').textContent = novel.metadata.title;
            document.getElementById('edit-all-titles-btn').classList.remove('hidden'); // Show edit title button when chapter list is rendered

            novel.chapters.forEach((chapter, index) => {
                const isTranslated = !!novel.translations[`chapter_${index}`];
                const isSelected = index === appState.selectedChapterIndex;
                const chapterTitle = chapter.title_vi || chapter.title_cn;

                const statusIcon = isTranslated ? '‚úÖ' : '‚è≥';
                const statusColor = isTranslated ? 'text-emerald-600' : 'text-gray-500';

                const div = document.createElement('div');
                div.className = `chapter-item flex justify-between items-center p-3 rounded-lg cursor-pointer hover:bg-indigo-50 ${isSelected ? 'bg-indigo-100 border-l-4 border-indigo-600' : 'bg-white'}`;
                div.setAttribute('data-index', index);
                
                // FIXED: Ch·ªâ th√™m STT (V·ªã tr√≠) v√† Ti√™u ƒë·ªÅ ƒë√£ d·ªãch (ho·∫∑c g·ªëc)
                div.innerHTML = `
                    <div class="flex flex-col flex-grow">
                        <span class="font-semibold text-text-dark">STT ${index + 1}. ${chapterTitle}</span>
                        <span class="text-xs text-gray-500 italic">(${chapter.title_cn})</span>
                    </div>
                    <span class="${statusColor} text-sm font-medium">${statusIcon}</span>
                `;
                div.onclick = () => {
                    selectChapter(index);
                    closeModal('chapter-list-modal');
                };
                container.appendChild(div);
            });
        }
        
        function editAllTitles() {
            const novel = novelManagerData[appState.selectedNovelId];
            if (!novel) return;

            const container = document.getElementById('chapter-list-container');
            container.innerHTML = ''; 

            novel.chapters.forEach((chapter, index) => {
                const div = document.createElement('div');
                div.className = 'p-3 border-b border-gray-100';
                div.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700">STT ${index + 1}. Ti√™u ƒë·ªÅ D·ªãch:</label>
                    <input type="text" id="title-vi-${index}" value="${chapter.title_vi || chapter.title_cn}" class="w-full p-2 border rounded-md text-sm mb-1">
                    <p class="text-xs text-gray-500 italic">Marker G·ªëc: ${chapter.startMarker}</p>
                `;
                container.appendChild(div);
            });

            // Replace the 'Edit' button with a 'Save' button temporarily
            const originalButton = document.getElementById('edit-all-titles-btn');
            originalButton.textContent = 'üíæ L∆∞u Ti√™u ƒë·ªÅ ƒë√£ Ch·ªânh s·ª≠a';
            originalButton.onclick = saveAllTitles;
        }

        function saveAllTitles() {
            const novel = novelManagerData[appState.selectedNovelId];
            if (!novel) return;

            novel.chapters.forEach((chapter, index) => {
                const input = document.getElementById(`title-vi-${index}`);
                if (input) {
                    chapter.title_vi = input.value.trim();
                }
            });

            localStorage.setItem(NOVEL_DATA_KEY, JSON.stringify(novelManagerData));
            alert("ƒê√£ l∆∞u c√°c ti√™u ƒë·ªÅ ch∆∞∆°ng m·ªõi!");

            // Restore the original button and list view
            const originalButton = document.getElementById('edit-all-titles-btn');
            originalButton.textContent = '‚úçÔ∏è Ch·ªânh s·ª≠a/D·ªãch ti√™u ƒë·ªÅ th·ªß c√¥ng';
            originalButton.onclick = editAllTitles;
            
            renderChapterList('chapter-list-container'); // Re-render in view mode
            loadSelectedNovel(); // Update main display
        }


        function navigateChapter(direction) {
            const novel = novelManagerData[appState.selectedNovelId];
            if (!novel) return;
            
            const newIndex = appState.selectedChapterIndex + direction;
            if (newIndex >= 0 && newIndex < novel.chapters.length) {
                selectChapter(newIndex);
                if (appState.isReadingMode) {
                    document.getElementById('reading-status').textContent = `ƒêang t·∫£i v√† d·ªãch Ch∆∞∆°ng ${newIndex + 1}...`;
                    startAITranslation(); 
                }
                
            }
        }


        // --- DICTIONARY & RULE MANAGEMENT ---

        function saveDictionary() {
            localStorage.setItem(HAN_VIET_DICT_KEY, JSON.stringify(hanVietDictionary));
            renderDictionary();
        }

        function renderDictionary() {
            const listContainer = document.getElementById('dictionary-list');
            listContainer.innerHTML = Object.entries(hanVietDictionary).map(([han, viet]) => `
                <div class="flex justify-between items-center text-sm">
                    <span class="font-mono text-text-dark">${han}</span>
                    <span class="text-secondary truncate ml-2">${viet}</span>
                </div>
            `).join('');
            if (Object.keys(hanVietDictionary).length === 0) {
                listContainer.innerHTML = '<p class="text-gray-400 p-2 text-center">T·ª´ ƒëi·ªÉn tr·ªëng.</p>';
            }
        }
        
        function handleDictionaryUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                const lines = content.split('\n').filter(line => line.trim() !== '');
                
                let count = 0;
                lines.forEach(line => {
                    const parts = line.split(/, |: /).map(p => p.trim());
                    if (parts.length >= 2) {
                        const han = parts[0];
                        const viet = parts[1];
                        if (han && viet) {
                            hanVietDictionary[han] = viet;
                            count++;
                        }
                    }
                });
                
                saveDictionary();
                alert(`ƒê√£ th√™m ${count} c·∫∑p t·ª´ m·ªõi v√†o t·ª´ ƒëi·ªÉn Vƒ©nh vi·ªÖn.`);
            };
            reader.readAsText(file, 'UTF-8');
        }

        function downloadDictionary() {
            const content = Object.entries(hanVietDictionary).map(([han, viet]) => `${han}, ${viet}`).join('\n');
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'han_viet_dictionary.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Han -> Viet Temporary Rules
        function addHanVietTempRule() {
            const han = document.getElementById('han-original-input').value.trim();
            const viet = document.getElementById('han-replacement-input').value.trim();
            if (han && viet) {
                hanVietTempRules[han] = viet;
                document.getElementById('han-original-input').value = '';
                document.getElementById('han-replacement-input').value = '';
                renderHanVietTempRules();
            }
        }

        function renderHanVietTempRules() {
            const listContainer = document.getElementById('han-viet-temp-list');
            listContainer.innerHTML = Object.entries(hanVietTempRules).map(([han, viet]) => `
                <div class="flex justify-between items-center text-sm bg-indigo-50 p-1 rounded-md">
                    <span class="font-mono text-text-dark">${han} -> ${viet}</span>
                    <button onclick="removeHanVietTempRule('${han}')" class="text-red-500 hover:text-red-700 text-xs ml-2">X√≥a</button>
                </div>
            `).join('');
            if (Object.keys(hanVietTempRules).length === 0) {
                 listContainer.innerHTML = '<p class="text-gray-400 p-2 text-center">Danh s√°ch tr·ªëng.</p>';
            }
        }
        
        function removeHanVietTempRule(han) {
            delete hanVietTempRules[han];
            renderHanVietTempRules();
        }

        // Viet -> Viet Permanent Rules
        function saveVietVietRules() {
            localStorage.setItem(VIET_VIET_RULES_KEY, JSON.stringify(vietVietRules));
            renderVietVietRules('vv-list-container-edit', false);
        }
        
        // Function used in Edit Mode
        function addVietVietRule() {
            const originalInput = document.getElementById('vv-original-input-edit');
            const replacementInput = document.getElementById('vv-replacement-input-edit');
            const original = originalInput.value.trim();
            const replacement = replacementInput.value.trim();

            if (original && replacement) {
                // Check for existing rule to avoid duplicates
                if (!vietVietRules.some(rule => rule.original === original)) {
                    vietVietRules.push({ original, replacement });
                    saveVietVietRules();
                    // Clear inputs
                    originalInput.value = '';
                    replacementInput.value = '';
                } else {
                    alert('Quy t·∫Øc thay th·∫ø n√†y ƒë√£ t·ªìn t·∫°i.');
                }
            }
        }
        
        // Function used in Reading Mode Modal
        function addVietVietRuleFromModal() {
            const originalInput = document.getElementById('vv-original-input');
            const replacementInput = document.getElementById('vv-replacement-input');
            const original = originalInput.value.trim();
            const replacement = replacementInput.value.trim();

            if (original && replacement) {
                // Check for existing rule to avoid duplicates
                if (!vietVietRules.some(rule => rule.original === original)) {
                    vietVietRules.push({ original, replacement });
                    saveVietVietRules();
                    // Clear inputs
                    originalInput.value = '';
                    replacementInput.value = '';
                } else {
                    alert('Quy t·∫Øc thay th·∫ø n√†y ƒë√£ t·ªìn t·∫°i.');
                }
            }
            // Run translation and close modal
            closeModal('viet-viet-modal'); 
            startHanVietTranslation(true); // Apply and start AI translation
        }

        function removeVietVietRule(index) {
            vietVietRules.splice(index, 1);
            saveVietVietRules();
            // Re-run Han Viet translation to reflect change immediately
            startHanVietTranslation(false); 
        }

        function renderVietVietRules(containerId, isModal) {
            const container = document.getElementById(containerId);
            const list = vietVietRules.map((rule, index) => `
                <div class="flex justify-between items-center text-sm bg-gray-50 p-1 rounded-md">
                    <span class="text-text-dark truncate">${rule.original} &rarr; <span class="text-red-500 font-semibold">${rule.replacement}</span></span>
                    <button onclick="removeVietVietRule(${index})" class="text-red-500 hover:text-red-700 text-xs ml-2 font-semibold">X√≥a</button>
                </div>
            `).join('');
            container.innerHTML = list;
             if (vietVietRules.length === 0) {
                 container.innerHTML = '<p class="text-gray-400 p-2 text-center">Danh s√°ch tr·ªëng.</p>';
            }

            // Also update the list in the Viet-Viet Modal (if open)
            if (isModal) {
                const modalContainer = document.getElementById('vv-list-container');
                modalContainer.innerHTML = list;
            }
        }


        // --- TRANSLATION LOGIC ---
        
        function formatTranslatedText(text) {
            // FIX: Ensure paragraphs and line breaks are handled correctly
            let formattedText = text.trim();
            
            // 1. Replace multiple newlines with paragraph closures
            formattedText = formattedText.replace(/\n{2,}/g, '</p><p>');

            // 2. Replace single newlines with line breaks (within a paragraph)
            formattedText = formattedText.replace(/\n/g, '<br>');
            
            // 3. Wrap the content in <p> tags if it hasn't been already
            if (!formattedText.startsWith('<p>')) {
                formattedText = '<p>' + formattedText + '</p>';
            }
            
            return formattedText;
        }

        function applyHanVietRules(text, dict) {
            let processedText = text;
            const regex = new RegExp(`(${Object.keys(dict).join('|')})`, 'g');
            
            // Apply Han -> Viet substitution
            processedText = processedText.replace(regex, (match) => {
                const translation = dict[match];
                // Wrap the substituted text for highlighting
                return `<span class="han-viet-highlight">${translation}</span>`;
            });
            
            // Apply Viet -> Viet substitution (Post-substitution)
            vietVietRules.forEach(rule => {
                // Use a non-global regex for all rules
                const vvRegex = new RegExp(rule.original, 'g');
                processedText = processedText.replace(vvRegex, (match) => {
                    // Wrap the substituted text for highlighting
                    return `<span class="han-viet-highlight bg-yellow-200">${rule.replacement}</span>`;
                });
            });

            return processedText;
        }

        async function startHanVietTranslation(shouldStartAI = false) {
            const rawContent = document.getElementById('chinese-input').value;
            if (!rawContent.trim()) {
                document.getElementById('vietnamese-output').innerHTML = '<p class="text-red-500 font-semibold">Vui l√≤ng nh·∫≠p ho·∫∑c ch·ªçn n·ªôi dung ch∆∞∆°ng tr∆∞·ªõc.</p>';
                return;
            }

            const combinedDict = { ...hanVietDictionary, ...hanVietTempRules };

            document.getElementById('vietnamese-output').innerHTML = '<p class="text-primary font-semibold">ƒêang √°p d·ª•ng t·ª´ ƒëi·ªÉn H√°n Vi·ªát v√† c√°c quy t·∫Øc tinh ch·ªânh...</p>';
            
            const hanVietOutput = applyHanVietRules(rawContent, combinedDict);
            
            document.getElementById('vietnamese-output').innerHTML = hanVietOutput;
            
            // Store the Han Viet output for AI step (clean up whitespace/newlines)
            appState.currentHanVietOutput = hanVietOutput.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim(); 
            saveAppState();
            
            document.getElementById('ai-translate-btn').disabled = false;

            if (shouldStartAI) {
                startAITranslation();
            }
        }

        async function startAITranslation() {
            if (apiKeys.length === 0) {
                displayError('Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt Gemini API Key trong m·ª•c C√†i ƒë·∫∑t N√¢ng cao.');
                return;
            }

            const novel = appState.selectedNovelId ? novelManagerData[appState.selectedNovelId] : null;

            // 1. T·ª∞ ƒê·ªòNG CH·∫†Y B∆Ø·ªöC H√ÅN VI·ªÜT (N·∫øu ch∆∞a c√≥)
            if (!appState.currentHanVietOutput) {
                 await startHanVietTranslation(false);
            }
            
            const hanVietContent = appState.currentHanVietOutput;
            if (!hanVietContent) {
                 displayError('L·ªói: Kh√¥ng th·ªÉ x·ª≠ l√Ω n·ªôi dung H√°n Vi·ªát ƒë√£ tinh ch·ªânh. Vui l√≤ng ki·ªÉm tra l·∫°i n·ªôi dung ƒë·∫ßu v√†o.');
                return;
            }
            
            // Disable buttons during process
            document.getElementById('ai-translate-btn').disabled = true;
            document.getElementById('han-viet-translate-btn').disabled = true;

            // Show loading and enter reading mode
            appState.isReadingMode = true;
            updateReadingModeContent('ƒêang chu·∫©n b·ªã d·ªãch...', 'ƒêang x·ª≠ l√Ω...');
            updateUIState();
            
            let finalTranslation = '';
            let successfulKey = null;
            const keyCount = apiKeys.length;
            
            try {
                // D·ªãch TO√ÄN B·ªò ch∆∞∆°ng trong m·ªôt l·∫ßn g·ªçi API
                document.getElementById('reading-status').textContent = `üöÄ ƒêang d·ªãch to√†n b·ªô Ch∆∞∆°ng...`;

                // --- X·ª¨ L√ù TU·∫¶N T·ª∞ M·ªòT L·∫¶N CHO TO√ÄN B·ªò CH∆Ø∆†NG ---
                for (let attempt = 0; attempt < MAX_API_RETRIES; attempt++) {
                    const keyIndex = attempt % keyCount;
                    const apiKeyToUse = apiKeys[keyIndex];
                    
                    try {
                        const translatedText = await callAITranslationAPI(hanVietContent, apiKeyToUse);
                        finalTranslation = translatedText;
                        successfulKey = apiKeyToUse;
                        break; // Th√†nh c√¥ng
                    } catch (error) {
                        // Ch·ªù tr∆∞·ªõc khi th·ª≠ l·∫°i v·ªõi Key ti·∫øp theo (ch·ªëng Rate Limit)
                        await new Promise(resolve => setTimeout(resolve, API_CALL_DELAY_MS));
                        if (attempt === MAX_API_RETRIES - 1) {
                            throw new Error(`L·ªñI D·ªäCH THU·∫¨T: To√†n b·ªô ${MAX_API_RETRIES} l·∫ßn th·ª≠ ƒë·ªÅu th·∫•t b·∫°i. L·ªói cu·ªëi c√πng: ${error.message}`);
                        }
                    }
                }
                
                if (!finalTranslation) throw new Error("Th·∫•t b·∫°i d·ªãch thu·∫≠t sau khi th·ª≠ t·∫•t c·∫£ c√°c Keys.");

                // Final success update
                document.getElementById('reading-status').textContent = `‚úÖ D·ªãch ho√†n t·∫•t. ƒê√£ s·ª≠ d·ª•ng Key: ...${successfulKey.slice(-4)}`;
                
                const chapterTitle = novel.chapters[appState.selectedChapterIndex].title_vi;
                updateReadingModeContent(chapterTitle, formatTranslatedText(finalTranslation));
                
                // Save translation to novel data
                if (novel && appState.selectedChapterIndex !== null) {
                    novel.translations[`chapter_${appState.selectedChapterIndex}`] = {
                        translatedText: finalTranslation,
                        translatedAt: new Date().toISOString()
                    };
                    localStorage.setItem(NOVEL_DATA_KEY, JSON.stringify(novelManagerData));
                }

            } catch (error) {
                // Exit reading mode on critical failure
                exitReadingMode();
                document.getElementById('vietnamese-output').innerHTML = `<p class="text-red-500 font-bold">${error.message}</p>`;
            } finally {
                document.getElementById('ai-translate-btn').disabled = false;
                document.getElementById('han-viet-translate-btn').disabled = false;
            }
        }

        async function callAITranslationAPI(text, apiKey) {
            const apiUrl = API_URL + apiKey;
            const payload = {
                contents: [{ parts: [{ text: text }] }],
                systemInstruction: { parts: [{ text: generalSettings.prompt }] },
                // B·ªè config ·ªü ƒë√¢y, n√≥ ch·ªâ d√πng cho JSON
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (!response.ok || !result.candidates || result.candidates.length === 0) {
                const errorMessage = result.error?.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ API.';
                throw new Error(`L·ªói API: Key ...${apiKey.slice(-4)}: ${errorMessage}`);
            }

            const translatedText = result.candidates[0]?.content?.parts[0]?.text;
            if (!translatedText) {
                throw new Error(`L·ªói API: Key ...${apiKey.slice(-4)}: Kh√¥ng nh·∫≠n ƒë∆∞·ª£c vƒÉn b·∫£n d·ªãch.`);
            }

            return translatedText;
        }


        // --- CHAPTER ANALYSIS AI ---

        async function startChapterAnalysis() {
            if (apiKeys.length === 0) {
                displayError('Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt Gemini API Key ƒë·ªÉ ph√¢n t√≠ch ch∆∞∆°ng.');
                return;
            }
            if (!appState.selectedNovelId) return;

            const novel = novelManagerData[appState.selectedNovelId];
            if (novel.chapters.length > 0 && !confirm("Truy·ªán ƒë√£ c√≥ c·∫•u tr√∫c ch∆∞∆°ng, b·∫°n c√≥ mu·ªën ph√¢n t√≠ch l·∫°i (s·∫Ω t·ªën API credit)?")) return;

            // Chu·∫©n b·ªã d·ªØ li·ªáu (200,000 k√Ω t·ª± ƒë·∫ßu)
            const analysisContent = novel.rawContent.substring(0, MAX_AI_ANALYSIS_LENGTH);
            const statusMessage = `ƒêang g·ª≠i ${analysisContent.length.toLocaleString('vi-VN')} k√Ω t·ª± ƒë·∫øn AI ƒë·ªÉ T·ª∞ ƒê·ªòNG ph√¢n t√≠ch c·∫•u tr√∫c ch∆∞∆°ng...`;
            
            document.getElementById('vietnamese-output').innerHTML = `<p class="text-primary font-semibold">${statusMessage}</p>`;
            document.getElementById('extract-chapters-btn').disabled = true;

            const chapterSchema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        "startMarker": { "type": "STRING", "description": "Chu·ªói k√Ω t·ª± b·∫Øt ƒë·∫ßu ch√≠nh x√°c c·ªßa ch∆∞∆°ng n√†y trong vƒÉn b·∫£n g·ªëc (VD: 'Ch∆∞∆°ng 1' hay 'Á¨¨1Á´†')." },
                        "title_cn": { "type": "STRING", "description": "Ti√™u ƒë·ªÅ H√°n t·ª± g·ªëc c·ªßa ch∆∞∆°ng (VD: 'Ch∆∞∆°ng 101 ƒê·ªãnh m·ªánh ki·∫øp n·∫°n')." }
                    },
                    "propertyOrdering": ["startMarker", "title_cn"]
                }
            };

            const systemPrompt = "B·∫°n l√† m·ªôt nh√† ph√¢n t√≠ch c·∫•u tr√∫c truy·ªán chuy√™n nghi·ªáp. Nhi·ªám v·ª• c·ªßa b·∫°n l√† ph√¢n t√≠ch ƒëo·∫°n vƒÉn b·∫£n th√¥, T·ª∞ X√ÅC ƒêINH c·∫•u tr√∫c ch∆∞∆°ng v√† tr√≠ch xu·∫•t t·∫•t c·∫£ c√°c ch∆∞∆°ng b·∫°n t√¨m th·∫•y. Tr·∫£ l·ªùi CH·ªà d∆∞·ªõi ƒë·ªãnh d·∫°ng JSON sau, kh√¥ng th√™m l·ªùi gi·∫£i th√≠ch hay markdown. ƒê·∫£m b·∫£o Ti√™u ƒë·ªÅ Trung Qu·ªëc (title_cn) ch·ª©a s·ªë ch∆∞∆°ng v√† d·∫•u hai ch·∫•m (n·∫øu c√≥).";
            
            const prompt = `Ph√¢n t√≠ch vƒÉn b·∫£n th√¥ sau v√† tr√≠ch xu·∫•t t·∫•t c·∫£ c√°c ch∆∞∆°ng b·∫°n t√¨m th·∫•y. VƒÉn b·∫£n: ${analysisContent}`;

            try {
                // B∆∞·ªõc 1: Ph√¢n t√≠ch c·∫•u tr√∫c ch∆∞∆°ng (JSON)
                const chaptersJson = await callAIAnalysisAPI_JSON(prompt, systemPrompt, chapterSchema);
                
                // B∆∞·ªõc 2: D·ªãch ti√™u ƒë·ªÅ
                document.getElementById('vietnamese-output').innerHTML = `<p class="text-primary font-semibold">‚úÖ Ph√¢n t√≠ch c·∫•u tr√∫c th√†nh c√¥ng. ƒêang d·ªãch ti√™u ƒë·ªÅ...</p>`;
                const translatedTitles = await translateChapterTitles(chaptersJson.map(c => c.title_cn));
                
                const finalChapters = chaptersJson.map((chapter, index) => ({
                    ...chapter,
                    title_vi: translatedTitles[index] || chapter.title_cn
                }));

                // Update novel data
                novel.chapters = finalChapters;
                localStorage.setItem(NOVEL_DATA_KEY, JSON.stringify(novelManagerData));

                document.getElementById('vietnamese-output').innerHTML = `<p class="text-secondary font-bold">‚úÖ Ph√¢n t√≠ch v√† d·ªãch ti√™u ƒë·ªÅ th√†nh c√¥ng! T√¨m th·∫•y ${finalChapters.length} ch∆∞∆°ng.</p>`;
                
                updateUIState();
                selectChapter(0); // Auto load first chapter
            } catch (error) {
                document.getElementById('vietnamese-output').innerHTML = `<p class="text-red-500 font-bold">L·ªñI PH√ÇN T√çCH AI (T·ª± ƒë·ªông):</p><p class="mt-2 text-sm">${error.message}</p><p class="mt-2 text-sm">V·∫•n ƒë·ªÅ c√≥ th·ªÉ do c·∫•u tr√∫c ch∆∞∆°ng kh√¥ng r√µ r√†ng ho·∫∑c t·∫•t c·∫£ API Keys ƒë·ªÅu l·ªói.</p>`;
            } finally {
                document.getElementById('extract-chapters-btn').disabled = false;
            }
        }
        
        // H√†m g·ªçi API chuy√™n bi·ªát cho JSON (c√≥ xoay v√≤ng Key v√† ƒë·ªô tr·ªÖ cao)
        async function callAIAnalysisAPI_JSON(prompt, systemPrompt, responseSchema) {
            if (apiKeys.length === 0) throw new Error('Kh√¥ng c√≥ API Key n√†o ƒë∆∞·ª£c cung c·∫•p.');
            
            let lastError = "Kh√¥ng th·ªÉ k·∫øt n·ªëi ho·∫∑c ph√¢n t√≠ch JSON.";
            const keyCount = apiKeys.length;

            for (let attempt = 0; attempt < keyCount; attempt++) {
                 const key = apiKeys[attempt % keyCount];

                try {
                    const apiUrl = API_URL + key;
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: responseSchema
                        }
                    };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    
                    if (!response.ok || !result.candidates || result.candidates.length === 0) {
                        const message = result.error?.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh.';
                        lastError = `L·ªói Key ...${key.slice(-4)}: ${message}`;
                        await new Promise(resolve => setTimeout(resolve, JSON_API_DELAY_MS)); // ƒê·ªô tr·ªÖ cao cho l·ªói nghi√™m tr·ªçng
                        continue;
                    }

                    const jsonText = result.candidates[0].content.parts[0].text;
                    let cleanedJsonText = jsonText.replace(/```json\s*|```/g, '').trim();

                    const parsedJson = JSON.parse(cleanedJsonText);
                    return parsedJson;
                } catch (error) {
                    lastError = `L·ªói c√∫ ph√°p/k·∫øt n·ªëi Key ...: ${error.message}`;
                    await new Promise(resolve => setTimeout(resolve, JSON_API_DELAY_MS));
                }
            }

            throw new Error(`To√†n b·ªô Key ƒë·ªÅu th·∫•t b·∫°i. L·ªói cu·ªëi c√πng: ${lastError}`);
        }

        async function translateChapterTitles(titles) {
            const prompt = `D·ªãch danh s√°ch c√°c ti√™u ƒë·ªÅ ch∆∞∆°ng sau sang ti·∫øng Vi·ªát. R·∫•t quan tr·ªçng: Gi·ªØ nguy√™n c·∫•u tr√∫c ƒë√°nh s·ªë ch∆∞∆°ng (v√≠ d·ª•: 'Ch∆∞∆°ng 101', 'Á¨¨101Á´†') v√† ch·ªâ d·ªãch ph·∫ßn ti√™u ƒë·ªÅ sau s·ªë ch∆∞∆°ng. ƒê·∫£m b·∫£o ti√™u ƒë·ªÅ d·ªãch ra c√≥ d·∫•u hai ch·∫•m (:) ngƒÉn c√°ch gi·ªØa s·ªë ch∆∞∆°ng v√† t√™n ch∆∞∆°ng. Kh√¥ng vi·∫øt hoa to√†n b·ªô ti√™u ƒë·ªÅ. Tr·∫£ l·ªùi d∆∞·ªõi d·∫°ng m·ªôt m·∫£ng JSON c√°c chu·ªói ƒë√£ d·ªãch. V√≠ d·ª•: ["Ch∆∞∆°ng 101: Ti√™u ƒë·ªÅ ƒë√£ d·ªãch", "Ch∆∞∆°ng 102: Ti√™u ƒë·ªÅ ƒë√£ d·ªãch"]. Ti√™u ƒë·ªÅ g·ªëc: ${JSON.stringify(titles)}`;

            const titleSchema = {
                type: "ARRAY",
                items: { type: "STRING" }
            };

            const systemPrompt = "B·∫°n l√† chuy√™n gia d·ªãch ti√™u ƒë·ªÅ truy·ªán. Ch·ªâ tr·∫£ l·ªùi b·∫±ng m·ªôt m·∫£ng JSON c√°c chu·ªói ƒë√£ d·ªãch, kh√¥ng c√≥ b·∫•t k·ª≥ vƒÉn b·∫£n n√†o kh√°c.";

            try {
                 const translatedArray = await callAIAnalysisAPI_JSON(prompt, systemPrompt, titleSchema);
                 if (Array.isArray(translatedArray) && translatedArray.length === titles.length) {
                    return translatedArray;
                 } else {
                     throw new Error('K·∫øt qu·∫£ d·ªãch ti√™u ƒë·ªÅ kh√¥ng ph·∫£i l√† m·∫£ng ho·∫∑c thi·∫øu d·ªØ li·ªáu.');
                 }
            } catch (error) {
                console.error("L·ªói d·ªãch ti√™u ƒë·ªÅ AI:", error);
                return titles; // Fallback to original titles
            }
        }


        // --- READING MODE & STYLES ---

        function updateReadingModeContent(title, content) {
            const novel = novelManagerData[appState.selectedNovelId];
            if (!novel || appState.selectedChapterIndex === null) return;
            
            document.getElementById('reading-chapter-title').textContent = title;
            document.getElementById('reading-content').innerHTML = content;
            
            // Update nav button status
            const isFirst = appState.selectedChapterIndex === 0;
            const isLast = appState.selectedChapterIndex === novel.chapters.length - 1;
            document.getElementById('prev-chapter-btn-read').disabled = isFirst;
            document.getElementById('next-chapter-btn-read').disabled = isLast;
        }
        
        // Function to enter reading mode, optionally loading the last translated chapter
        function enterReadingMode(loadLastTranslated) {
            const novel = novelManagerData[appState.selectedNovelId];
            if (!novel) return;

            if (loadLastTranslated) {
                const chapterKey = `chapter_${appState.selectedChapterIndex}`;
                const translation = novel.translations[chapterKey];
                
                if (translation) {
                    const chapterTitle = novel.chapters[appState.selectedChapterIndex].title_vi;
                    updateReadingModeContent(chapterTitle, formatTranslatedText(translation.translatedText));
                }
            }
            
            appState.isReadingMode = true;
            saveAppState();
            document.getElementById('reading-status').textContent = '';
            updateUIState();
        }

        function exitReadingMode() {
            appState.isReadingMode = false;
            saveAppState();
            document.getElementById('reading-status').textContent = '';
            updateUIState();
        }
        
        // --- STYLE SETTINGS ---
        
        function saveReadingStyle() {
            const style = appState.readingStyle;
            style.fontSize = document.getElementById('setting-font-size').value + 'px';
            style.lineHeight = document.getElementById('setting-line-height').value;
            style.bgColor = document.getElementById('setting-bg-color').value;
            style.textColor = document.getElementById('setting-text-color').value;

            localStorage.setItem(READING_STYLE_KEY, JSON.stringify(style));
            applyReadingStyle();
        }

        function applyReadingStyle() {
            const style = appState.readingStyle;
            const container = document.getElementById('reading-mode-container');
            const content = document.getElementById('reading-content');

            if (container && content) {
                container.style.setProperty('--bg-color', style.bgColor);
                container.style.setProperty('--text-color', style.textColor);
                content.style.setProperty('--line-height', style.lineHeight);
                content.style.setProperty('--font-size', style.fontSize);
            }
            
            // Also update input values for modal consistency
            if (document.getElementById('setting-font-size')) {
                document.getElementById('setting-font-size').value = parseInt(style.fontSize); 
                document.getElementById('setting-line-height').value = style.lineHeight;
                document.getElementById('setting-bg-color').value = style.bgColor;
                document.getElementById('setting-text-color').value = style.textColor;
            }
        }

        // --- DOWNLOADS ---

        function downloadChapter() {
            const novel = novelManagerData[appState.selectedNovelId];
            if (!novel || appState.selectedChapterIndex === null) return alert("Vui l√≤ng ch·ªçn ch∆∞∆°ng ƒë√£ d·ªãch.");
            
            const chapterKey = `chapter_${appState.selectedChapterIndex}`;
            const translation = novel.translations[chapterKey];
            
            if (!translation || !translation.translatedText) return alert("Ch∆∞∆°ng n√†y ch∆∞a c√≥ b·∫£n d·ªãch ho√†n ch·ªânh.");

            const chapterTitle = novel.chapters[appState.selectedChapterIndex].title_vi || "Ch∆∞∆°ng_d·ªãch";
            const cleanTitle = chapterTitle.replace(/[:\/\\*?"<>|]/g, '').trim();

            const content = `${chapterTitle}\n\n${translation.translatedText}`;
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${cleanTitle}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function downloadBook() {
            const novel = novelManagerData[appState.selectedNovelId];
            if (!novel) return alert("Vui l√≤ng ch·ªçn truy·ªán ƒë·ªÉ t·∫£i xu·ªëng.");

            const bookTitle = novel.metadata.title;
            const cleanTitle = bookTitle.replace(/[:\/\\*?"<>|]/g, '').trim();
            
            let fullContent = `T√™n Truy·ªán: ${bookTitle}\nT√°c gi·∫£: ${novel.metadata.author || 'Kh√¥ng r√µ'}\nGi·ªõi thi·ªáu: ${novel.metadata.description || 'Kh√¥ng c√≥'}\n\n====================\n\n`;

            novel.chapters.forEach((chapter, index) => {
                const chapterKey = `chapter_${index}`;
                const translation = novel.translations[chapterKey];

                if (translation && translation.translatedText) {
                    fullContent += `\n\n${chapter.title_vi}\n\n${translation.translatedText}\n\n`;
                } else {
                    fullContent += `\n\n[CH∆Ø∆†NG ${index + 1}: ${chapter.title_cn} - CH∆ØA D·ªäCH HO√ÄN CH·ªàNH]\n\n`;
                }
            });
            
            const blob = new Blob([fullContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${cleanTitle}_FULL_DICH.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }


        // --- MODAL & ERROR HANDLING ---

        function openModal(id) {
            // FIX: Ensure modals open correctly
            document.getElementById(id).style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function displayError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 8000);
        }

        // --- INITIALIZATION ---
        
        window.onload = loadFromLocalStorage;

    </script>
</body>
</html>
