<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng c·ª• D·ªãch H√°n Vi·ªát C√° nh√¢n h√≥a (Standalone Cloud)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#10b981',
                        'background-light': '#f9fafb',
                        'card-bg': '#ffffff',
                        'text-dark': '#1f2937',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
            color: #1f2937;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .han-viet-highlight { background-color: #d1fae5; font-weight: 600; padding: 1px 2px; border-radius: 2px; }
        .full-page-container { display: flex; flex-direction: column; min-height: 100vh; }
        .main-content-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
        @media (min-width: 1024px) { .main-content-grid { grid-template-columns: 1fr 1fr; } }
        .input-output-area { flex-grow: 1; display: flex; flex-direction: column; gap: 1.5rem; }
        #vietnamese-output-wrapper { flex-grow: 1; display: flex; flex-direction: column; }
        #vietnamese-output { flex-grow: 1; height: 100%; overflow-y: auto; }
        #reading-mode-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: var(--bg-color, #f9fafb); color: var(--text-color, #1f2937); z-index: 50; display: none; flex-direction: column; }
        #reading-content-wrapper { flex-grow: 1; overflow-y: auto; padding: 2rem 5%; }
        #reading-content { max-width: 800px; margin: 0 auto; line-height: var(--line-height, 1.8); font-size: var(--font-size, 16px); }
        .sticky-header { flex-shrink: 0; padding: 1rem 1rem; border-bottom: 1px solid #e5e7eb; background-color: white; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); z-index: 60; }
        .sticky-footer { flex-shrink: 0; width: 100%; background-color: #ffffff; border-top: 1px solid #e5e7eb; z-index: 60; padding: 0.5rem 1rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 100; align-items: center; justify-content: center; }
        .modal-content { background-color: #ffffff; border-radius: 0.5rem; box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1); max-height: 90vh; overflow-y: auto; }
        .custom-file-upload { display: inline-block; cursor: pointer; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; text-align: center; border: 1px solid #d1d5db; background-color: #f3f4f6; color: #4b5563; }
        .custom-file-upload:hover { background-color: #e5e7eb; }
        .custom-file-upload input[type="file"] { display: none; }
        .formatted-text p { margin-bottom: 1em; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #4f46e5; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 2rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="full-page-container">
    <!-- Loading overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/80 z-[200] flex flex-col items-center justify-center">
        <div class="loader"></div>
        <p class="text-lg font-semibold text-primary">ƒêang t·∫£i v√† ƒë·ªìng b·ªô d·ªØ li·ªáu t·ª´ ƒë√°m m√¢y...</p>
    </div>

    <!-- Firebase Config Modal -->
    <div id="firebase-config-modal" class="modal z-[210]">
        <div class="modal-content p-6 w-full max-w-2xl">
            <h2 class="text-xl font-bold mb-4 text-text-dark">Thi·∫øt l·∫≠p K·∫øt n·ªëi ƒê√°m m√¢y (L·∫ßn ƒë·∫ßu)</h2>
            <p class="text-sm text-gray-600 mb-4">ƒê·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng l∆∞u tr·ªØ ƒë√°m m√¢y ·ªü b·∫•t k·ª≥ ƒë√¢u, b·∫°n c·∫ßn t·∫°o m·ªôt d·ª± √°n Firebase mi·ªÖn ph√≠ c·ªßa ri√™ng m√¨nh. Vui l√≤ng l√†m theo h∆∞·ªõng d·∫´n v√† d√°n ƒë·ªëi t∆∞·ª£ng c·∫•u h√¨nh v√†o ƒë√¢y.</p>
            <textarea id="firebase-config-input" rows="10" placeholder='d√°n ƒë·ªëi t∆∞·ª£ng firebaseConfig c·ªßa b·∫°n v√†o ƒë√¢y, v√≠ d·ª•: { apiKey: "...", authDomain: "...", ... }' class="w-full p-2 border border-gray-300 rounded-md font-mono text-xs"></textarea>
            <div class="flex justify-end mt-4">
                <button onclick="saveFirebaseConfig()" class="bg-primary text-white p-2 rounded-md font-semibold hover:bg-indigo-600">L∆∞u v√† K·∫øt n·ªëi</button>
            </div>
             <p class="text-xs text-gray-500 mt-4">D·ªØ li·ªáu n√†y s·∫Ω ƒë∆∞·ª£c l∆∞u trong tr√¨nh duy·ªát c·ªßa b·∫°n. B·∫°n s·∫Ω ch·ªâ c·∫ßn l√†m ƒëi·ªÅu n√†y m·ªôt l·∫ßn tr√™n m·ªói thi·∫øt b·ªã/tr√¨nh duy·ªát.</p>
        </div>
    </div>


    <!-- MODALS -->
    <div id="novel-metadata-modal" class="modal"><div class="modal-content p-6 w-full max-w-lg"><h2 class="text-xl font-bold mb-4 text-text-dark">Th√™m Th√¥ng tin Truy·ªán M·ªõi</h2><input type="text" id="novel-title-input" placeholder="T√™n Truy·ªán" class="w-full p-2 mb-3 border border-gray-300 rounded-md"><input type="text" id="novel-author-input" placeholder="T√™n T√°c Gi·∫£" class="w-full p-2 mb-3 border border-gray-300 rounded-md"><textarea id="novel-description-input" placeholder="Gi·ªõi thi·ªáu/M√¥ t·∫£ ng·∫Øn" rows="3" class="w-full p-2 mb-4 border border-gray-300 rounded-md"></textarea><div class="flex justify-end space-x-3"><button onclick="saveNovelMetadata()" class="bg-primary text-white p-2 rounded-md font-semibold hover:bg-indigo-600">L∆∞u & T·∫£i truy·ªán</button></div></div></div>
    <div id="chapter-list-modal" class="modal"><div class="modal-content p-6 w-full max-w-4xl"><h2 class="text-xl font-bold mb-4 text-text-dark">M·ª•c l·ª•c Truy·ªán: <span id="modal-novel-title"></span></h2><button onclick="editAllTitles()" id="edit-all-titles-btn" class="mb-4 p-2 bg-indigo-100 text-primary rounded-md font-semibold hover:bg-indigo-200 w-full"><span class="mr-1">‚úçÔ∏è</span> Ch·ªânh s·ª≠a/D·ªãch ti√™u ƒë·ªÅ th·ªß c√¥ng</button><div id="chapter-list-container" class="space-y-2 max-h-[70vh] overflow-y-auto p-2 border rounded-md"></div><div class="flex justify-end mt-4"><button onclick="closeModal('chapter-list-modal')" class="bg-gray-300 text-text-dark p-2 rounded-md font-semibold hover:bg-gray-400">ƒê√≥ng</button></div></div></div>
    <div id="viet-viet-modal" class="modal"><div class="modal-content p-6 w-full max-w-2xl"><h2 class="text-xl font-bold mb-4 text-text-dark">üîß Tinh ch·ªânh Thu·∫≠t ng·ªØ (Vi·ªát -> Vi·ªát)</h2><div class="space-y-4"><input type="text" id="vv-original-input" placeholder="T·ª´ Vi·ªát C≈© (C·∫ßn thay th·∫ø)" class="w-full p-2 border border-gray-300 rounded-md"><input type="text" id="vv-replacement-input" placeholder="T·ª´ Vi·ªát M·ªõi (Thay th·∫ø)" class="w-full p-2 border border-gray-300 rounded-md"><button onclick="addVietVietRuleFromModal();" class="bg-secondary text-white p-2 rounded-md font-semibold w-full hover:bg-emerald-600">Th√™m & √Åp d·ª•ng ngay</button></div><h3 class="font-semibold mt-6 mb-2">Danh s√°ch Thu·∫≠t ng·ªØ ƒë√£ l∆∞u Vƒ©nh vi·ªÖn:</h3><div id="vv-list-container" class="max-h-60 overflow-y-auto border p-3 rounded-md"></div><div class="flex justify-end mt-4"><button onclick="closeModal('viet-viet-modal')" class="bg-gray-300 text-text-dark p-2 rounded-md font-semibold hover:bg-gray-400">ƒê√≥ng</button></div></div></div>
    <div id="style-settings-modal" class="modal"><div class="modal-content p-6 w-full max-w-lg"><h2 class="text-xl font-bold mb-4 text-text-dark">‚öôÔ∏è T√πy ch·ªânh Giao di·ªán ƒê·ªçc</h2><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700">C·ª° ch·ªØ (px):</label><input type="number" id="setting-font-size" onchange="saveReadingStyle()" min="12" max="30" class="w-full p-2 border rounded-md" value="16"></div><div><label class="block text-sm font-medium text-gray-700">Chi·ªÅu cao d√≤ng:</label><input type="number" id="setting-line-height" onchange="saveReadingStyle()" min="1.0" max="2.5" step="0.1" class="w-full p-2 border rounded-md" value="1.8"></div><div><label class="block text-sm font-medium text-gray-700">M√†u n·ªÅn (Hex/Name):</label><input type="text" id="setting-bg-color" onchange="saveReadingStyle()" class="w-full p-2 border rounded-md" value="#f9fafb"></div><div><label class="block text-sm font-medium text-gray-700">M√†u ch·ªØ (Hex/Name):</label><input type="text" id="setting-text-color" onchange="saveReadingStyle()" class="w-full p-2 border rounded-md" value="#1f2937"></div></div><div class="flex justify-end mt-6"><button onclick="closeModal('style-settings-modal')" class="bg-gray-300 text-text-dark p-2 rounded-md font-semibold hover:bg-gray-400">ƒê√≥ng</button></div></div></div>

    <!-- Reading Mode Container (Full Screen) -->
    <div id="reading-mode-container">
        <header class="sticky-header"><div class="max-w-4xl mx-auto flex justify-between items-center"><button onclick="exitReadingMode()" class="px-4 py-2 bg-gray-200 rounded-md text-sm font-semibold hover:bg-gray-300">&larr; Tr·ªü l·∫°i Bi√™n t·∫≠p</button><h1 id="reading-chapter-title" class="text-xl font-bold text-center text-text-dark truncate max-w-sm sm:max-w-lg"></h1><div class="flex space-x-2"><button onclick="navigateChapter(-1)" class="p-2 bg-gray-100 rounded-full hover:bg-gray-200 disabled:opacity-50" id="prev-chapter-btn-read" title="Ch∆∞∆°ng tr∆∞·ªõc">&lt;</button><button onclick="navigateChapter(1)" class="p-2 bg-gray-100 rounded-full hover:bg-gray-200 disabled:opacity-50" id="next-chapter-btn-read" title="Ch∆∞∆°ng ti·∫øp theo">&gt;</button></div></div></header>
        <div id="reading-content-wrapper" class="flex-grow"><div id="reading-content" class="text-base formatted-text"></div></div>
        <footer id="reading-footer" class="sticky-footer"><div class="flex items-center space-x-4"><button onclick="openModal('chapter-list-modal'); renderChapterList('chapter-list-container');" class="p-2 text-sm font-semibold rounded-md bg-secondary text-white hover:bg-emerald-600"><span class="mr-2">üìö</span> M·ª•c l·ª•c</button><button onclick="openModal('style-settings-modal')" class="p-2 text-sm font-semibold rounded-md bg-gray-100 hover:bg-gray-200"><span class="mr-2">üé®</span> T√πy ch·ªânh ƒê·ªçc</button><button onclick="openModal('viet-viet-modal'); renderVietVietRules('vv-list-container', true);" class="p-2 text-sm font-semibold rounded-md bg-gray-100 hover:bg-gray-200"><span class="mr-2">üîß</span> Thu·∫≠t ng·ªØ</button><button onclick="downloadChapter()" class="p-2 text-sm font-semibold rounded-md bg-gray-100 hover:bg-gray-200"><span class="mr-2">‚¨áÔ∏è</span> T·∫£i Ch∆∞∆°ng</button><button onclick="downloadBook()" class="p-2 text-sm font-semibold rounded-md bg-gray-100 hover:bg-gray-200"><span class="mr-2">‚¨áÔ∏è</span> T·∫£i To√†n b·ªô</button></div><div id="reading-status" class="text-sm font-medium text-indigo-600"></div><button onclick="startAITranslation()" class="px-4 py-2 text-sm font-semibold rounded-md bg-primary text-white hover:bg-indigo-600"><span class="mr-2">üîÑ</span> D·ªãch l·∫°i Ch∆∞∆°ng</button></footer>
    </div>
    
    <!-- Main Editing Container -->
    <main class="container mx-auto p-4 flex-grow" id="edit-mode-container">
        <h1 class="text-3xl font-bold mb-2 text-center text-text-dark">C√¥ng c·ª• D·ªãch H√°n Vi·ªát C√° nh√¢n h√≥a (Cloud Storage)</h1>
        
        <div id="storage-notice" class="bg-emerald-100 border-l-4 border-emerald-500 text-emerald-700 p-4 mb-6 rounded-md" role="alert">
            <p class="font-bold">L∆ØU TR·ªÆ ƒê√ÅM M√ÇY C√Å NH√ÇN ƒê√É K√çCH HO·∫†T:</p>
            <p class="text-sm">D·ªØ li·ªáu c·ªßa b·∫°n ƒë∆∞·ª£c l∆∞u tr·ªØ an to√†n tr√™n ƒë√°m m√¢y c√° nh√¢n v√† t·ª± ƒë·ªông ƒë·ªìng b·ªô h√≥a gi·ªØa c√°c thi·∫øt b·ªã.</p>
            <p id="user-id-display" class="text-xs mt-2 font-mono bg-emerald-200 p-1 rounded inline-block"></p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-200"><h2 class="text-xl font-bold mb-4 text-primary">üìë T·∫£i l√™n S√°ch & Ph√¢n t√≠ch Ch∆∞∆°ng</h2><p class="text-gray-600 mb-4">T·∫£i l√™n t·ªáp (.txt) ch·ª©a to√†n b·ªô n·ªôi dung truy·ªán ti·∫øng Trung.</p><div class="flex space-x-2"><label class="custom-file-upload flex-1"><input type="file" id="book-upload" accept=".txt">Ch·ªçn T·ªáp S√°ch...</label><button id="extract-chapters-btn" onclick="startChapterAnalysis()" class="flex-1 p-2 bg-primary text-white rounded-md font-semibold hover:bg-indigo-600 disabled:opacity-50" disabled><span class="mr-1">‚ú®</span> AI Ph√¢n t√≠ch & D·ªãch Ti√™u ƒë·ªÅ</button></div><div id="current-novel-info" class="mt-4 p-3 bg-gray-50 border rounded-md hidden"><div class="flex justify-between items-center"><p class="text-sm font-medium text-text-dark">ƒêang l√†m vi·ªác: <span id="current-novel-title" class="font-semibold text-primary">Ch∆∞a t·∫£i</span></p><button onclick="deleteNovel()" class="text-red-500 hover:text-red-700 text-xs font-semibold" id="delete-novel-btn">X√≥a Truy·ªán</button></div><p class="text-xs text-gray-500 mt-1">T·ªïng Ch∆∞∆°ng: <span id="total-chapters">0</span> | ƒê√£ d·ªãch: <span id="translated-chapters">0</span></p></div><div class="mt-4 border-t pt-4"><button onclick="openModal('chapter-list-modal'); renderNovelManagerModal();" class="w-full p-2 bg-gray-200 text-text-dark rounded-md font-semibold hover:bg-gray-300">üìö M·ª•c l·ª•c Truy·ªán ƒë√£ L∆∞u</button></div><div id="chapter-nav-display" class="mt-4 p-3 bg-gray-50 border rounded-md hidden"><p class="text-sm font-medium text-text-dark">ƒêang xem: <span id="current-chapter-title" class="font-semibold text-primary"></span></p><button onclick="openModal('chapter-list-modal'); renderChapterList('chapter-list-container');" class="mt-2 text-sm text-primary font-semibold hover:underline">Xem M·ª•c l·ª•c chi ti·∫øt</button><button onclick="enterReadingMode(true)" id="back-to-reading-btn" class="hidden mt-2 ml-4 text-sm bg-indigo-100 text-primary font-semibold p-1 rounded hover:bg-indigo-200">Ti·∫øp t·ª•c ƒê·ªçc</button></div></div>
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-200"><h2 class="text-xl font-bold mb-4 text-primary">‚öôÔ∏è C√†i ƒë·∫∑t N√¢ng cao (API & Prompt)</h2><div class="space-y-4"><div><h3 class="font-semibold text-gray-700 mb-1">Qu·∫£n l√Ω API Keys</h3><div class="flex space-x-2 mb-2"><input type="text" id="api-key-input" placeholder="Nh·∫≠p Gemini API Key" class="flex-grow p-2 border border-gray-300 rounded-md"><button onclick="addApiKey()" class="bg-secondary text-white p-2 rounded-md font-semibold hover:bg-emerald-600">Th√™m Kh√≥a</button></div><div id="api-key-list" class="text-xs space-y-1 max-h-24 overflow-y-auto p-1 border rounded-md bg-gray-50"></div><p class="text-xs text-gray-500 mt-1">C√°c kh√≥a s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông l∆∞u v√† xoay v√≤ng khi c√≥ l·ªói.</p></div><div><h3 class="font-semibold text-gray-700 mb-1">Custom Prompt</h3><textarea id="system-prompt-input" onchange="saveGeneralSettings()" rows="3" placeholder="Y√™u c·∫ßu ƒë·∫∑c bi·ªát cho AI (v√≠ d·ª•: 'D·ªãch theo phong c√°ch ki·∫øm hi·ªáp c·ªï trang...')" class="w-full p-2 border border-gray-300 rounded-md"></textarea><p class="text-xs text-gray-500">T·ª± ƒë·ªông l∆∞u. ƒêi·ªÅu ch·ªânh phong c√°ch v√† gi·ªçng ƒëi·ªáu b·∫£n d·ªãch cu·ªëi c√πng.</p></div></div></div>
        </div>
        <div class="main-content-grid">
            <div class="space-y-6"><div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-200"><h2 class="text-xl font-bold mb-4 text-primary">1. H√°n -> Vi·ªát (Tinh ch·ªânh T·∫°m th·ªùi)</h2><div class="space-y-3"><input type="text" id="han-original-input" placeholder="H√°n t·ª± g·ªëc (V√≠ d·ª•: 'ÈÅì')" class="w-full p-2 border border-gray-300 rounded-md"><input type="text" id="han-replacement-input" placeholder="Nghƒ©a Vi·ªát m·ªõi (V√≠ d·ª•: 'ƒê·∫°o')" class="w-full p-2 border border-gray-300 rounded-md"><button onclick="addHanVietTempRule()" class="bg-secondary text-white p-2 rounded-md font-semibold w-full hover:bg-emerald-600">Th√™m v√†o Danh s√°ch T·∫°m</button></div><div id="han-viet-temp-list" class="mt-4 space-y-2 max-h-32 overflow-y-auto p-1 border rounded-md"></div><p class="text-xs text-gray-500 mt-2">C√°c tinh ch·ªânh n√†y ch·ªâ ƒë∆∞·ª£c √°p d·ª•ng khi b·∫°n nh·∫•n "√Åp d·ª•ng & D·ªãch l·∫°i".</p></div><div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-200"><h2 class="text-xl font-bold mb-4 text-primary">2. Vi·ªát -> Vi·ªát (H·∫≠u k·ª≥) - L∆∞u Vƒ©nh Vi·ªÖn</h2><div class="space-y-3"><input type="text" id="vv-original-input-edit" placeholder="T·ª´ Vi·ªát C≈© (C·∫ßn thay th·∫ø)" class="w-full p-2 border border-gray-300 rounded-md"><input type="text" id="vv-replacement-input-edit" placeholder="T·ª´ Vi·ªát M·ªõi (Thay th·∫ø)" class="w-full p-2 border border-gray-300 rounded-md"><button onclick="addVietVietRule()" class="bg-secondary text-white p-2 rounded-md font-semibold w-full hover:bg-emerald-600">Th√™m & L∆∞u Vƒ©nh vi·ªÖn</button></div><h3 class="font-semibold mt-4 mb-2 text-gray-700">Danh s√°ch Thu·∫≠t ng·ªØ ƒë√£ l∆∞u:</h3><div id="vv-list-container-edit" class="max-h-32 overflow-y-auto border p-3 rounded-md"></div><p class="text-xs text-gray-500 mt-2">C√°c quy t·∫Øc n√†y ƒë∆∞·ª£c l∆∞u vƒ©nh vi·ªÖn v√† √°p d·ª•ng cho m·ªçi ch∆∞∆°ng.</p></div><div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-200"><h2 class="text-xl font-bold mb-4 text-primary">üìñ T·ª´ ƒëi·ªÉn H√°n Vi·ªát c·ªßa b·∫°n (Vƒ©nh Vi·ªÖn)</h2><div class="flex space-x-2"><input type="file" id="dict-upload" accept=".txt,.csv" class="flex-grow block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-200 file:text-gray-700 hover:file:bg-gray-300"><button onclick="downloadDictionary()" class="p-2 bg-gray-200 rounded-md font-semibold text-gray-700 hover:bg-gray-300 text-sm whitespace-nowrap">T·∫£i xu·ªëng</button></div><div id="dictionary-list" class="mt-4 space-y-1 max-h-40 overflow-y-auto p-2 border rounded-md bg-gray-50"></div><p class="text-xs text-gray-500 mt-2">C√°c c·∫∑p t·ª´ n√†y ƒë∆∞·ª£c l∆∞u vƒ©nh vi·ªÖn v√† d√πng l√†m n·ªÅn t·∫£ng d·ªãch H√°n Vi·ªát.</p></div></div>
            <div class="flex flex-col space-y-4"><div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-200 h-full flex flex-col"><h2 class="text-xl font-bold mb-4 text-primary">C√¥ng c·ª• D·ªãch & N·ªôi dung Ch∆∞∆°ng</h2><textarea id="chinese-input" rows="8" placeholder="D√°n vƒÉn b·∫£n ti·∫øng Trung (n·ªôi dung ch∆∞∆°ng) v√†o ƒë√¢y ho·∫∑c ch·ªçn m·ªôt ch∆∞∆°ng t·ª´ M·ª•c l·ª•c..." class="w-full p-3 border border-gray-300 rounded-md text-base flex-grow font-mono"></textarea><div class="mt-4 flex flex-col space-y-3"><button onclick="startHanVietTranslation()" class="w-full p-3 bg-indigo-200 text-primary rounded-md font-semibold hover:bg-indigo-300 disabled:opacity-50" id="han-viet-translate-btn">√Åp d·ª•ng & D·ªãch H√°n Vi·ªát (Batch Apply)</button><button onclick="startAITranslation()" class="w-full p-3 bg-primary text-white rounded-md font-semibold hover:bg-indigo-600 disabled:opacity-50" id="ai-translate-btn"><span class="mr-1">‚ú®</span> AI D·ªãch Ho√†n Ch·ªânh & Tr√¥i Ch·∫£y</button></div><div id="translation-progress" class="mt-3 text-sm text-center text-indigo-600 hidden">ƒêang chia ƒëo·∫°n v√† d·ªãch song song...</div><div id="error-message" class="mt-3 text-sm text-red-600 text-center hidden p-2 bg-red-100 rounded-md"></div></div></div>
        </div>
        <div id="vietnamese-output-wrapper" class="mt-6"><h2 class="text-xl font-bold mb-3 text-text-dark">K·∫øt qu·∫£ D·ªãch thu·∫≠t:</h2><div id="vietnamese-output" class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-200 overflow-y-auto text-base"><p class="text-gray-500">K·∫øt qu·∫£ d·ªãch s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y. Vui l√≤ng t·∫£i s√°ch, ch·ªçn ch∆∞∆°ng ho·∫∑c d√°n vƒÉn b·∫£n ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p></div></div>
    </main>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, deleteDoc, enableNetwork } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES & CONSTANTS ---
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
        const MAX_AI_ANALYSIS_LENGTH = 200000;
        const MAX_BOOK_CONTENT_LENGTH = 20000000;
        const MAX_API_RETRIES = 5; 
        const API_CALL_DELAY_MS = 500; 
        const JSON_API_DELAY_MS = 750;

        // --- FIREBASE VARIABLES ---
        let db, auth, userId, appDataRef;
        let unsubscribe; // To detach the Firestore listener
        let saveTimeout; // For debouncing save operations

        // --- LOCAL STATE ---
        let isDataLoaded = false;
        let localState = {
            hanVietDictionary: {},
            vietVietRules: [],
            apiKeys: [],
            generalSettings: { prompt: "D·ªãch vƒÉn b·∫£n ti·∫øng Trung sau ƒë√¢y sang ti·∫øng Vi·ªát. H√£y gi·ªØ nguy√™n nghƒ©a v√† t·∫°o ra m·ªôt b·∫£n d·ªãch tr√¥i ch·∫£y, t·ª± nhi√™n. Tr·∫£ l·ªùi b·∫±ng vƒÉn b·∫£n thu·∫ßn t√∫y ti·∫øng Vi·ªát, kh√¥ng th√™m l·ªùi gi·∫£i th√≠ch hay b·∫•t k·ª≥ n·ªôi dung n√†o kh√°c." },
            novelManagerData: {},
            appState: {
                selectedNovelId: null,
                selectedChapterIndex: null,
                currentChapterContent: "",
                currentHanVietOutput: "",
                isReadingMode: false,
                readingStyle: { fontSize: '16px', lineHeight: 1.8, bgColor: '#f9fafb', textColor: '#1f2937' }
            }
        };
        let hanVietTempRules = {}; 

        // --- FIREBASE INITIALIZATION & AUTH ---
        async function initializeAppAndAuth() {
            const userFirebaseConfig = localStorage.getItem('userFirebaseConfig');
            
            if (!userFirebaseConfig) {
                // If no config, show the modal and stop
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('firebase-config-modal').style.display = 'flex';
                return;
            }

            try {
                const firebaseConfig = JSON.parse(userFirebaseConfig);
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await signInAnonymously(auth);

                userId = auth.currentUser?.uid;
                if (!userId) {
                    throw new Error("Kh√¥ng th·ªÉ x√°c th·ª±c ng∆∞·ªùi d√πng ·∫©n danh.");
                }
                
                document.getElementById('user-id-display').textContent = `User ID (L∆∞u tr·ªØ tr√™n tr√¨nh duy·ªát n√†y): ${userId}`;
                
                // Define the NEW document reference for this user's data
                appDataRef = doc(db, 'hanviet-users', userId, 'data', 'userData');

                // Start listening for cloud data
                loadFromFirestore();

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                localStorage.removeItem('userFirebaseConfig'); // Clear bad config
                document.getElementById('loading-overlay').style.display = 'none';
                const modal = document.getElementById('firebase-config-modal');
                modal.style.display = 'flex';
                modal.querySelector('h2').textContent = "L·ªói K·∫øt n·ªëi - Vui l√≤ng ki·ªÉm tra l·∫°i C·∫•u h√¨nh";
            }
        }
        
        // --- DATA MANAGEMENT (FIRESTORE) ---

        function loadFromFirestore() {
            if (unsubscribe) unsubscribe(); // Detach any old listener

            unsubscribe = onSnapshot(appDataRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    // Update local state from Firestore data
                    localState = { ...localState, ...data };
                    
                    // Sanity check for nested objects
                    localState.generalSettings = localState.generalSettings || {};
                    localState.appState = localState.appState || {};
                    localState.appState.readingStyle = localState.appState.readingStyle || { fontSize: '16px', lineHeight: 1.8, bgColor: '#f9fafb', textColor: '#1f2937' };

                } else {
                    console.log("No data found for this user. Creating initial document.");
                    // For a new user, save the default localState to create the document
                    saveToFirestore();
                }

                if (!isDataLoaded) {
                     isDataLoaded = true;
                     document.getElementById('loading-overlay').style.display = 'none';
                     initializeAppUI(); // First time load
                }
                
                // Always refresh UI with the latest data
                refreshUIFromState(); 
            }, (error) => {
                console.error("Firestore Snapshot Error: ", error);
                document.getElementById('loading-overlay').innerHTML = `<p class="text-red-500 font-bold p-4 text-center">M·∫•t k·∫øt n·ªëi v·ªõi m√°y ch·ªß. ƒêang c·ªë g·∫Øng k·∫øt n·ªëi l·∫°i...</p>`;
            });
        }
        
        function saveToFirestore() {
            // Debounce the save function to avoid rapid writes
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                if (!appDataRef) return;
                try {
                    // Make a deep copy to remove any undefined values that Firestore rejects
                    const dataToSave = JSON.parse(JSON.stringify(localState));
                    await setDoc(appDataRef, dataToSave, { merge: true });
                } catch (error) {
                    console.error("Error saving data to Firestore: ", error);
                }
            }, 1000); // Wait 1 second after the last change to save
        }
        
        function initializeAppUI() {
            // Bind Event Listeners that only need to be set once
            document.getElementById('book-upload').addEventListener('change', handleBookUpload);
            document.getElementById('dict-upload').addEventListener('change', handleDictionaryUpload);
            document.getElementById('api-key-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') addApiKey();
            });
        }

        function refreshUIFromState() {
            // This function is called every time data changes in Firestore
            renderDictionary();
            renderVietVietRules('vv-list-container-edit', false);
            renderApiKeys();
            loadGeneralSettingsUI();
            
            applyReadingStyle();

            // Render Novel Manager Info
            updateNovelInfoDisplay();
            if (localState.appState.selectedNovelId && localState.novelManagerData[localState.appState.selectedNovelId]) {
                 loadSelectedNovel(); // This will also call updateUIState
            } else {
                 updateUIState();
            }
        }
        
        function loadGeneralSettingsUI() {
            document.getElementById('system-prompt-input').value = localState.generalSettings.prompt;
        }

        // --- REFACTORED FUNCTIONS TO USE LOCAL STATE & FIRESTORE ---

        function saveGeneralSettings() {
            localState.generalSettings.prompt = document.getElementById('system-prompt-input').value;
            saveToFirestore();
        }

        function updateUIState() {
            const isNovelLoaded = localState.appState.selectedNovelId && localState.novelManagerData[localState.appState.selectedNovelId];
            
            updateNovelInfoDisplay();

            document.getElementById('extract-chapters-btn').disabled = !document.getElementById('chinese-input').value.trim();
            document.getElementById('han-viet-translate-btn').disabled = !isNovelLoaded && !document.getElementById('chinese-input').value.trim();
            document.getElementById('ai-translate-btn').disabled = !isNovelLoaded && !document.getElementById('chinese-input').value.trim();

            const chapterNavDisplay = document.getElementById('chapter-nav-display');
            const backToReadingBtn = document.getElementById('back-to-reading-btn');

            if (isNovelLoaded && localState.novelManagerData[localState.appState.selectedNovelId].chapters.length > 0) {
                chapterNavDisplay.classList.remove('hidden');
                
                const chapterKey = `chapter_${localState.appState.selectedChapterIndex}`;
                const translationExists = localState.novelManagerData[localState.appState.selectedNovelId].translations[chapterKey];
                
                if (translationExists && !localState.appState.isReadingMode) {
                    backToReadingBtn.classList.remove('hidden');
                } else {
                    backToReadingBtn.classList.add('hidden');
                }

            } else {
                chapterNavDisplay.classList.add('hidden');
                backToReadingBtn.classList.add('hidden');
            }

            if (localState.appState.isReadingMode) {
                document.getElementById('edit-mode-container').style.display = 'none';
                document.getElementById('reading-mode-container').style.display = 'flex'; 
                applyReadingStyle();
            } else {
                document.getElementById('edit-mode-container').style.display = 'block';
                document.getElementById('reading-mode-container').style.display = 'none';
            }
        }

        function addApiKey() {
            const keyInput = document.getElementById('api-key-input');
            const newKey = keyInput.value.trim();
            if (newKey && !localState.apiKeys.includes(newKey)) {
                localState.apiKeys.push(newKey);
                saveToFirestore();
                keyInput.value = '';
                renderApiKeys(); // immediate UI update
            }
        }

        function removeApiKey(key) {
            localState.apiKeys = localState.apiKeys.filter(k => k !== key);
            saveToFirestore();
            renderApiKeys(); // immediate UI update
        }

        function renderApiKeys() {
            const listContainer = document.getElementById('api-key-list');
            listContainer.innerHTML = localState.apiKeys.map(key => `
                <div class="flex justify-between items-center bg-white p-1 rounded-md">
                    <span class="truncate">...${key.slice(-4)}</span>
                    <button onclick="removeApiKey('${key}')" class="text-red-500 hover:text-red-700 text-xs ml-2">X√≥a</button>
                </div>
            `).join('');
            if (localState.apiKeys.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-400 p-2 text-center">Ch∆∞a c√≥ Kh√≥a API n√†o ƒë∆∞·ª£c l∆∞u.</p>';
            }
        }

        function updateNovelInfoDisplay() {
            const infoDiv = document.getElementById('current-novel-info');
            const novel = localState.appState.selectedNovelId ? localState.novelManagerData[localState.appState.selectedNovelId] : null;

            if (novel) {
                infoDiv.classList.remove('hidden');
                document.getElementById('current-novel-title').textContent = novel.metadata.title;
                document.getElementById('total-chapters').textContent = novel.chapters.length;
                
                const translatedCount = Object.keys(novel.translations).length;
                document.getElementById('translated-chapters').textContent = translatedCount;
            } else {
                infoDiv.classList.add('hidden');
            }
        }

        function renderNovelManagerModal() {
            const container = document.getElementById('chapter-list-container');
            container.innerHTML = ' ';
            document.getElementById('modal-novel-title').textContent = 'Danh s√°ch Truy·ªán ƒë√£ L∆∞u';

            const novelIds = Object.keys(localState.novelManagerData);

            if (novelIds.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">B·∫°n ch∆∞a t·∫£i l√™n truy·ªán n√†o.</p>';
                return;
            }

            const listHtml = novelIds.map(id => {
                const novel = localState.novelManagerData[id];
                const isSelected = id === localState.appState.selectedNovelId;
                const translatedCount = Object.keys(novel.translations).length;
                
                return `
                    <div class="p-3 border rounded-md ${isSelected ? 'bg-indigo-100 border-indigo-600' : 'bg-white'} flex justify-between items-center hover:bg-indigo-50 cursor-pointer" onclick="loadNovelFromModal('${id}')">
                        <div>
                            <p class="font-semibold text-text-dark">${novel.metadata.title}</p>
                            <p class="text-xs text-gray-500">T√°c gi·∫£: ${novel.metadata.author || 'V√¥ danh'} | Ch∆∞∆°ng: ${novel.chapters.length} | ƒê√£ d·ªãch: ${translatedCount}</p>
                        </div>
                        <div class="flex space-x-2 items-center">
                            ${isSelected ? '<span class="text-xs font-bold text-indigo-600">ƒêang ho·∫°t ƒë·ªông</span>' : ''}
                            <button onclick="event.stopPropagation(); deleteNovel('${id}')" class="text-red-500 hover:text-red-700 text-xs font-semibold p-1 rounded-full bg-red-100">X√≥a</button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = listHtml;
            document.getElementById('edit-all-titles-btn').classList.add('hidden');
        }

        function loadNovelFromModal(novelId) {
            localState.appState.selectedNovelId = novelId;
            localState.appState.selectedChapterIndex = null;
            saveToFirestore();
            loadSelectedNovel();
            closeModal('chapter-list-modal');
        }

        function loadSelectedNovel() {
            const novelId = localState.appState.selectedNovelId;
            const novel = localState.novelManagerData[novelId];

            if (novel) {
                document.getElementById('current-novel-title').textContent = novel.metadata.title;
                
                if (novel.chapters.length > 0) {
                    if (localState.appState.selectedChapterIndex === null || localState.appState.selectedChapterIndex >= novel.chapters.length) {
                        selectChapter(0);
                    } else if (localState.appState.selectedChapterIndex !== null) {
                        selectChapter(localState.appState.selectedChapterIndex);
                    }
                } else {
                    document.getElementById('chinese-input').value = novel.rawContent; 
                    document.getElementById('vietnamese-output').innerHTML = '<p class="text-gray-500">ƒê√£ t·∫£i n·ªôi dung truy·ªán. Vui l√≤ng nh·∫•n "AI Ph√¢n t√≠ch & D·ªãch Ti√™u ƒë·ªÅ" ƒë·ªÉ x√°c ƒë·ªãnh c√°c ch∆∞∆°ng.</p>';
                    localState.appState.currentChapterContent = novel.rawContent;
                }
            } else {
                localState.appState.selectedNovelId = null;
                localState.appState.selectedChapterIndex = null;
                localState.appState.currentHanVietOutput = "";
                document.getElementById('chinese-input').value = '';
                document.getElementById('vietnamese-output').innerHTML = '<p class="text-gray-500">Vui l√≤ng ch·ªçn ho·∫∑c t·∫£i l√™n m·ªôt truy·ªán.</p>';
                localState.appState.currentChapterContent = "";
            }
            saveToFirestore();
            updateUIState();
        }
        
        async function deleteNovel(novelIdToDelete = localState.appState.selectedNovelId) {
            const novel = localState.novelManagerData[novelIdToDelete];
            if (!novel || !confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a truy·ªán "${novel.metadata.title}" v√† to√†n b·ªô b·∫£n d·ªãch ƒë√£ l∆∞u tr√™n ƒë√°m m√¢y?`)) {
                return;
            }

            delete localState.novelManagerData[novelIdToDelete];
            
            if (novelIdToDelete === localState.appState.selectedNovelId) {
                 localState.appState.selectedNovelId = null;
                 localState.appState.selectedChapterIndex = null;
                 localState.appState.currentHanVietOutput = "";
                 loadSelectedNovel();
            }
            await saveToFirestore(); // Wait for delete to complete
            
            updateUIState();
            
            if(document.getElementById('chapter-list-modal').style.display !== 'none') {
                renderNovelManagerModal();
            }
        }
        
        function saveNovelMetadata() {
            const title = document.getElementById('novel-title-input').value.trim();
            const author = document.getElementById('novel-author-input').value.trim();
            const description = document.getElementById('novel-description-input').value.trim();
            const rawContent = document.getElementById('novel-metadata-modal').dataset.rawContent;

            if (!title || !rawContent) {
                alert("Vui l√≤ng nh·∫≠p T√™n Truy·ªán.");
                return;
            }

            const novelId = crypto.randomUUID();
            localState.novelManagerData[novelId] = {
                metadata: { title, author, description, uploadedAt: new Date().toISOString() },
                rawContent: rawContent,
                chapters: [],
                translations: {}
            };
            
            closeModal('novel-metadata-modal');
            localState.appState.selectedNovelId = novelId;
            localState.appState.selectedChapterIndex = null;
            localState.appState.currentHanVietOutput = "";
            saveToFirestore(); // Save new novel
            updateUIState();
            
            startChapterAnalysis();
        }

        function getChapterContent(novel, index) {
            const chapters = novel.chapters;
            if (index < 0 || index >= chapters.length) return "";
            const startMarker = chapters[index].startMarker;
            const startIndex = novel.rawContent.indexOf(startMarker);
            if (startIndex === -1) return "";
            let endIndex = novel.rawContent.length;
            if (index < chapters.length - 1) {
                const nextStartMarker = chapters[index + 1].startMarker;
                const nextStartIndex = novel.rawContent.indexOf(nextStartMarker, startIndex + startMarker.length); 
                if (nextStartIndex !== -1) {
                    endIndex = nextStartIndex;
                }
            }
            return novel.rawContent.substring(startIndex, endIndex).trim();
        }

        function selectChapter(index) {
            const novel = localState.novelManagerData[localState.appState.selectedNovelId];
            if (!novel || index < 0 || index >= novel.chapters.length) return;

            localState.appState.selectedChapterIndex = index;
            localState.appState.currentHanVietOutput = ""; 

            const chapterTitle = novel.chapters[index].title_vi || novel.chapters[index].title_cn;
            document.getElementById('current-chapter-title').textContent = chapterTitle;
            
            const chapterKey = `chapter_${index}`;
            localState.appState.currentChapterContent = getChapterContent(novel, index);

            if (novel.translations[chapterKey]) {
                document.getElementById('chinese-input').value = localState.appState.currentChapterContent;
                document.getElementById('vietnamese-output').innerHTML = formatTranslatedText(novel.translations[chapterKey].translatedText);
            } else {
                document.getElementById('chinese-input').value = localState.appState.currentChapterContent;
                document.getElementById('vietnamese-output').innerHTML = `<p class="text-gray-500">ƒê√£ t·∫£i Ch∆∞∆°ng ${index + 1}. Vui l√≤ng nh·∫•n "√Åp d·ª•ng & D·ªãch H√°n Vi·ªát" ho·∫∑c "AI D·ªãch Ho√†n Ch·ªânh".</p>`;
            }
            
            saveToFirestore(); // Save selected chapter state
            updateUIState();
            hanVietTempRules = {};
            renderHanVietTempRules();
        }

        function renderChapterList(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            const novel = localState.novelManagerData[localState.appState.selectedNovelId];
            if (!novel) {
                 container.innerHTML = '<p class="text-center text-gray-500">Vui l√≤ng t·∫£i l√™n m·ªôt truy·ªán ƒë·ªÉ xem M·ª•c l·ª•c.</p>';
                 return;
            }

            document.getElementById('modal-novel-title').textContent = novel.metadata.title;
            document.getElementById('edit-all-titles-btn').classList.remove('hidden');

            novel.chapters.forEach((chapter, index) => {
                const isTranslated = !!novel.translations[`chapter_${index}`];
                const isSelected = index === localState.appState.selectedChapterIndex;
                const chapterTitle = chapter.title_vi || chapter.title_cn;

                const statusIcon = isTranslated ? '‚úÖ' : '‚è≥';
                const statusColor = isTranslated ? 'text-emerald-600' : 'text-gray-500';

                const div = document.createElement('div');
                div.className = `chapter-item flex justify-between items-center p-3 rounded-lg cursor-pointer hover:bg-indigo-50 ${isSelected ? 'bg-indigo-100 border-l-4 border-indigo-600' : 'bg-white'}`;
                div.setAttribute('data-index', index);
                
                div.innerHTML = `
                    <div class="flex flex-col flex-grow">
                        <span class="font-semibold text-text-dark">STT ${index + 1}. ${chapterTitle}</span>
                        <span class="text-xs text-gray-500 italic">(${chapter.title_cn})</span>
                    </div>
                    <span class="${statusColor} text-sm font-medium">${statusIcon}</span>
                `;
                div.onclick = () => {
                    selectChapter(index);
                    closeModal('chapter-list-modal');
                };
                container.appendChild(div);
            });
        }
        
        function saveAllTitles() {
            const novel = localState.novelManagerData[localState.appState.selectedNovelId];
            if (!novel) return;

            novel.chapters.forEach((chapter, index) => {
                const input = document.getElementById(`title-vi-${index}`);
                if (input) {
                    chapter.title_vi = input.value.trim();
                }
            });

            saveToFirestore();
            alert("ƒê√£ l∆∞u c√°c ti√™u ƒë·ªÅ ch∆∞∆°ng m·ªõi l√™n ƒë√°m m√¢y!");

            const originalButton = document.getElementById('edit-all-titles-btn');
            originalButton.textContent = '‚úçÔ∏è Ch·ªânh s·ª≠a/D·ªãch ti√™u ƒë·ªÅ th·ªß c√¥ng';
            originalButton.onclick = editAllTitles;
            
            renderChapterList('chapter-list-container');
            loadSelectedNovel();
        }

        function navigateChapter(direction) {
            const novel = localState.novelManagerData[localState.appState.selectedNovelId];
            if (!novel) return;
            
            const newIndex = localState.appState.selectedChapterIndex + direction;
            if (newIndex >= 0 && newIndex < novel.chapters.length) {
                selectChapter(newIndex);
                if (localState.appState.isReadingMode) {
                    document.getElementById('reading-status').textContent = `ƒêang t·∫£i v√† d·ªãch Ch∆∞∆°ng ${newIndex + 1}...`;
                    startAITranslation(); 
                }
            }
        }

        function renderDictionary() {
            const listContainer = document.getElementById('dictionary-list');
            listContainer.innerHTML = Object.entries(localState.hanVietDictionary).map(([han, viet]) => `
                <div class="flex justify-between items-center text-sm">
                    <span class="font-mono text-text-dark">${han}</span>
                    <span class="text-secondary truncate ml-2">${viet}</span>
                </div>
            `).join('');
            if (Object.keys(localState.hanVietDictionary).length === 0) {
                listContainer.innerHTML = '<p class="text-gray-400 p-2 text-center">T·ª´ ƒëi·ªÉn tr·ªëng.</p>';
            }
        }

        function handleDictionaryUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                const lines = content.split('\n').filter(line => line.trim() !== '');
                
                let count = 0;
                lines.forEach(line => {
                    const parts = line.split(/, |: /).map(p => p.trim());
                    if (parts.length >= 2) {
                        const han = parts[0];
                        const viet = parts[1];
                        if (han && viet) {
                            localState.hanVietDictionary[han] = viet;
                            count++;
                        }
                    }
                });
                
                saveToFirestore();
                alert(`ƒê√£ th√™m ${count} c·∫∑p t·ª´ m·ªõi v√†o t·ª´ ƒëi·ªÉn Vƒ©nh vi·ªÖn.`);
            };
            reader.readAsText(file, 'UTF-8');
        }

        function addVietVietRule() {
            const originalInput = document.getElementById('vv-original-input-edit');
            const replacementInput = document.getElementById('vv-replacement-input-edit');
            const original = originalInput.value.trim();
            const replacement = replacementInput.value.trim();

            if (original && replacement) {
                if (!localState.vietVietRules.some(rule => rule.original === original)) {
                    localState.vietVietRules.push({ original, replacement });
                    saveToFirestore();
                    originalInput.value = '';
                    replacementInput.value = '';
                } else {
                    alert('Quy t·∫Øc thay th·∫ø n√†y ƒë√£ t·ªìn t·∫°i.');
                }
            }
        }
        
        function addVietVietRuleFromModal() {
            const originalInput = document.getElementById('vv-original-input');
            const replacementInput = document.getElementById('vv-replacement-input');
            const original = originalInput.value.trim();
            const replacement = replacementInput.value.trim();

            if (original && replacement) {
                if (!localState.vietVietRules.some(rule => rule.original === original)) {
                    localState.vietVietRules.push({ original, replacement });
                    saveToFirestore();
                    originalInput.value = '';
                    replacementInput.value = '';
                } else {
                    alert('Quy t·∫Øc thay th·∫ø n√†y ƒë√£ t·ªìn t·∫°i.');
                }
            }
            closeModal('viet-viet-modal'); 
            startHanVietTranslation(true);
        }

        function removeVietVietRule(index) {
            localState.vietVietRules.splice(index, 1);
            saveToFirestore();
            startHanVietTranslation(false); 
        }

        function renderVietVietRules(containerId, isModal) {
            const container = document.getElementById(containerId);
            const list = localState.vietVietRules.map((rule, index) => `
                <div class="flex justify-between items-center text-sm bg-gray-50 p-1 rounded-md">
                    <span class="text-text-dark truncate">${rule.original} &rarr; <span class="text-red-500 font-semibold">${rule.replacement}</span></span>
                    <button onclick="removeVietVietRule(${index})" class="text-red-500 hover:text-red-700 text-xs ml-2 font-semibold">X√≥a</button>
                </div>
            `).join('');
            container.innerHTML = list;
             if (localState.vietVietRules.length === 0) {
                 container.innerHTML = '<p class="text-gray-400 p-2 text-center">Danh s√°ch tr·ªëng.</p>';
            }

            if (isModal) {
                const modalContainer = document.getElementById('vv-list-container');
                modalContainer.innerHTML = list;
            }
        }
        
        async function startAITranslation() {
            if (localState.apiKeys.length === 0) {
                displayError('Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt Gemini API Key trong m·ª•c C√†i ƒë·∫∑t N√¢ng cao.');
                return;
            }

            const novel = localState.appState.selectedNovelId ? localState.novelManagerData[localState.appState.selectedNovelId] : null;

            if (!localState.appState.currentHanVietOutput) {
                 await startHanVietTranslation(false);
            }
            
            const hanVietContent = localState.appState.currentHanVietOutput;
            if (!hanVietContent) {
                 displayError('L·ªói: Kh√¥ng th·ªÉ x·ª≠ l√Ω n·ªôi dung H√°n Vi·ªát ƒë√£ tinh ch·ªânh. Vui l√≤ng ki·ªÉm tra l·∫°i n·ªôi dung ƒë·∫ßu v√†o.');
                return;
            }
            
            document.getElementById('ai-translate-btn').disabled = true;
            document.getElementById('han-viet-translate-btn').disabled = true;

            localState.appState.isReadingMode = true;
            updateReadingModeContent('ƒêang chu·∫©n b·ªã d·ªãch...', 'ƒêang x·ª≠ l√Ω...');
            updateUIState(); // This will not save to FS, which is fine for a transient state
            
            let finalTranslation = '';
            let successfulKey = null;
            const keyCount = localState.apiKeys.length;
            
            try {
                document.getElementById('reading-status').textContent = `üöÄ ƒêang d·ªãch to√†n b·ªô Ch∆∞∆°ng...`;

                for (let attempt = 0; attempt < MAX_API_RETRIES; attempt++) {
                    const keyIndex = attempt % keyCount;
                    const apiKeyToUse = localState.apiKeys[keyIndex];
                    
                    try {
                        const translatedText = await callAITranslationAPI(hanVietContent, apiKeyToUse);
                        finalTranslation = translatedText;
                        successfulKey = apiKeyToUse;
                        break;
                    } catch (error) {
                        await new Promise(resolve => setTimeout(resolve, API_CALL_DELAY_MS));
                        if (attempt === MAX_API_RETRIES - 1) {
                            throw new Error(`L·ªñI D·ªäCH THU·∫¨T: To√†n b·ªô ${MAX_API_RETRIES} l·∫ßn th·ª≠ ƒë·ªÅu th·∫•t b·∫°i. L·ªói cu·ªëi c√πng: ${error.message}`);
                        }
                    }
                }
                
                if (!finalTranslation) throw new Error("Th·∫•t b·∫°i d·ªãch thu·∫≠t sau khi th·ª≠ t·∫•t c·∫£ c√°c Keys.");

                document.getElementById('reading-status').textContent = `‚úÖ D·ªãch ho√†n t·∫•t. ƒê√£ s·ª≠ d·ª•ng Key: ...${successfulKey.slice(-4)}`;
                
                const chapterTitle = novel.chapters[localState.appState.selectedChapterIndex].title_vi;
                updateReadingModeContent(chapterTitle, formatTranslatedText(finalTranslation));
                
                if (novel && localState.appState.selectedChapterIndex !== null) {
                    novel.translations[`chapter_${localState.appState.selectedChapterIndex}`] = {
                        translatedText: finalTranslation,
                        translatedAt: new Date().toISOString()
                    };
                    saveToFirestore();
                }

            } catch (error) {
                exitReadingMode();
                document.getElementById('vietnamese-output').innerHTML = `<p class="text-red-500 font-bold">${error.message}</p>`;
            } finally {
                document.getElementById('ai-translate-btn').disabled = false;
                document.getElementById('han-viet-translate-btn').disabled = false;
            }
        }
        
        async function startChapterAnalysis() {
            if (localState.apiKeys.length === 0) {
                displayError('Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt Gemini API Key ƒë·ªÉ ph√¢n t√≠ch ch∆∞∆°ng.');
                return;
            }
            if (!localState.appState.selectedNovelId) return;

            const novel = localState.novelManagerData[localState.appState.selectedNovelId];
            if (novel.chapters.length > 0 && !confirm("Truy·ªán ƒë√£ c√≥ c·∫•u tr√∫c ch∆∞∆°ng, b·∫°n c√≥ mu·ªën ph√¢n t√≠ch l·∫°i (s·∫Ω t·ªën API credit)?")) return;

            const analysisContent = novel.rawContent.substring(0, MAX_AI_ANALYSIS_LENGTH);
            const statusMessage = `ƒêang g·ª≠i ${analysisContent.length.toLocaleString('vi-VN')} k√Ω t·ª± ƒë·∫øn AI ƒë·ªÉ T·ª∞ ƒê·ªòNG ph√¢n t√≠ch c·∫•u tr√∫c ch∆∞∆°ng...`;
            
            document.getElementById('vietnamese-output').innerHTML = `<p class="text-primary font-semibold">${statusMessage}</p>`;
            document.getElementById('extract-chapters-btn').disabled = true;

            const chapterSchema = { type: "ARRAY", items: { type: "OBJECT", properties: { "startMarker": { "type": "STRING" }, "title_cn": { "type": "STRING" } }, "propertyOrdering": ["startMarker", "title_cn"] } };
            const systemPrompt = "B·∫°n l√† m·ªôt nh√† ph√¢n t√≠ch c·∫•u tr√∫c truy·ªán chuy√™n nghi·ªáp. Nhi·ªám v·ª• c·ªßa b·∫°n l√† ph√¢n t√≠ch ƒëo·∫°n vƒÉn b·∫£n th√¥, T·ª∞ X√ÅC ƒêINH c·∫•u tr√∫c ch∆∞∆°ng v√† tr√≠ch xu·∫•t t·∫•t c·∫£ c√°c ch∆∞∆°ng b·∫°n t√¨m th·∫•y. Tr·∫£ l·ªùi CH·ªà d∆∞·ªõi ƒë·ªãnh d·∫°ng JSON sau, kh√¥ng th√™m l·ªùi gi·∫£i th√≠ch hay markdown. ƒê·∫£m b·∫£o Ti√™u ƒë·ªÅ Trung Qu·ªëc (title_cn) ch·ª©a s·ªë ch∆∞∆°ng v√† d·∫•u hai ch·∫•m (n·∫øu c√≥).";
            const prompt = `Ph√¢n t√≠ch vƒÉn b·∫£n th√¥ sau v√† tr√≠ch xu·∫•t t·∫•t c·∫£ c√°c ch∆∞∆°ng b·∫°n t√¨m th·∫•y. VƒÉn b·∫£n: ${analysisContent}`;

            try {
                const chaptersJson = await callAIAnalysisAPI_JSON(prompt, systemPrompt, chapterSchema);
                document.getElementById('vietnamese-output').innerHTML = `<p class="text-primary font-semibold">‚úÖ Ph√¢n t√≠ch c·∫•u tr√∫c th√†nh c√¥ng. ƒêang d·ªãch ti√™u ƒë·ªÅ...</p>`;
                const translatedTitles = await translateChapterTitles(chaptersJson.map(c => c.title_cn));
                
                const finalChapters = chaptersJson.map((chapter, index) => ({
                    ...chapter,
                    title_vi: translatedTitles[index] || chapter.title_cn
                }));

                novel.chapters = finalChapters;
                saveToFirestore();

                document.getElementById('vietnamese-output').innerHTML = `<p class="text-secondary font-bold">‚úÖ Ph√¢n t√≠ch v√† d·ªãch ti√™u ƒë·ªÅ th√†nh c√¥ng! T√¨m th·∫•y ${finalChapters.length} ch∆∞∆°ng.</p>`;
                
                updateUIState();
                selectChapter(0);
            } catch (error) {
                document.getElementById('vietnamese-output').innerHTML = `<p class="text-red-500 font-bold">L·ªñI PH√ÇN T√çCH AI (T·ª± ƒë·ªông):</p><p class="mt-2 text-sm">${error.message}</p><p class="mt-2 text-sm">V·∫•n ƒë·ªÅ c√≥ th·ªÉ do c·∫•u tr√∫c ch∆∞∆°ng kh√¥ng r√µ r√†ng ho·∫∑c t·∫•t c·∫£ API Keys ƒë·ªÅu l·ªói.</p>`;
            } finally {
                document.getElementById('extract-chapters-btn').disabled = false;
            }
        }
        
        function enterReadingMode(loadLastTranslated) {
            const novel = localState.novelManagerData[localState.appState.selectedNovelId];
            if (!novel) return;

            if (loadLastTranslated) {
                const chapterKey = `chapter_${localState.appState.selectedChapterIndex}`;
                const translation = novel.translations[chapterKey];
                
                if (translation) {
                    const chapterTitle = novel.chapters[localState.appState.selectedChapterIndex].title_vi;
                    updateReadingModeContent(chapterTitle, formatTranslatedText(translation.translatedText));
                }
            }
            
            localState.appState.isReadingMode = true;
            updateUIState();
            document.getElementById('reading-status').textContent = '';
        }

        function exitReadingMode() {
            localState.appState.isReadingMode = false;
            updateUIState();
            document.getElementById('reading-status').textContent = '';
        }
        
        function saveReadingStyle() {
            const style = localState.appState.readingStyle;
            style.fontSize = document.getElementById('setting-font-size').value + 'px';
            style.lineHeight = document.getElementById('setting-line-height').value;
            style.bgColor = document.getElementById('setting-bg-color').value;
            style.textColor = document.getElementById('setting-text-color').value;

            saveToFirestore();
            applyReadingStyle();
        }

        function applyReadingStyle() {
            const style = localState.appState.readingStyle;
            const container = document.getElementById('reading-mode-container');
            const content = document.getElementById('reading-content');

            if (container && content) {
                container.style.setProperty('--bg-color', style.bgColor);
                container.style.setProperty('--text-color', style.textColor);
                content.style.setProperty('--line-height', style.lineHeight);
                content.style.setProperty('--font-size', style.fontSize);
            }
            
            if (document.getElementById('setting-font-size')) {
                document.getElementById('setting-font-size').value = parseInt(style.fontSize); 
                document.getElementById('setting-line-height').value = style.lineHeight;
                document.getElementById('setting-bg-color').value = style.bgColor;
                document.getElementById('setting-text-color').value = style.textColor;
            }
        }
        
        function saveFirebaseConfig() {
            const configInput = document.getElementById('firebase-config-input').value.trim();
            if (!configInput) {
                alert("Vui l√≤ng d√°n v√†o ƒë·ªëi t∆∞·ª£ng c·∫•u h√¨nh Firebase.");
                return;
            }
            try {
                // Basic validation to see if it's a JS object
                const config = (new Function('return ' + configInput))();
                if (typeof config !== 'object' || !config.apiKey) {
                    throw new Error("C·∫•u h√¨nh kh√¥ng h·ª£p l·ªá.");
                }
                localStorage.setItem('userFirebaseConfig', JSON.stringify(config));
                document.getElementById('firebase-config-modal').style.display = 'none';
                initializeAppAndAuth(); // Retry initialization
            } catch (error) {
                alert("L·ªói khi ph√¢n t√≠ch c·∫•u h√¨nh. Vui l√≤ng ƒë·∫£m b·∫£o b·∫°n ƒë√£ d√°n ch√≠nh x√°c ƒë·ªëi t∆∞·ª£ng JavaScript.\n" + error.message);
            }
        }

        window.handleBookUpload = (event) => {
            const file = event.target.files[0];
            if (!file) { return; }
            if (file.size > MAX_BOOK_CONTENT_LENGTH) {
                alert(`L·ªói: K√≠ch th∆∞·ªõc t·ªáp qu√° l·ªõn (${(file.size / 1024 / 1024).toFixed(2)} MB). Gi·ªõi h·∫°n l√† ${(MAX_BOOK_CONTENT_LENGTH / 1024 / 1024).toFixed(2)} MB.`);
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                const rawContent = e.target.result;
                document.getElementById('chinese-input').value = rawContent;
                document.getElementById('novel-title-input').value = file.name.replace(/\.[^/.]+$/, "");
                openModal('novel-metadata-modal');
                document.getElementById('novel-metadata-modal').dataset.rawContent = rawContent;
                document.getElementById('extract-chapters-btn').disabled = false;
            };
            reader.readAsText(file, 'UTF-8');
        };
        window.startChapterAnalysis = startChapterAnalysis;
        window.deleteNovel = deleteNovel;
        window.renderNovelManagerModal = renderNovelManagerModal;
        window.loadNovelFromModal = loadNovelFromModal;
        window.saveNovelMetadata = saveNovelMetadata;
        window.addApiKey = addApiKey;
        window.removeApiKey = removeApiKey;
        window.saveGeneralSettings = saveGeneralSettings;
        window.addHanVietTempRule = () => {
            const han = document.getElementById('han-original-input').value.trim();
            const viet = document.getElementById('han-replacement-input').value.trim();
            if (han && viet) {
                hanVietTempRules[han] = viet;
                document.getElementById('han-original-input').value = '';
                document.getElementById('han-replacement-input').value = '';
                renderHanVietTempRules();
            }
        };
        window.renderHanVietTempRules = () => {
            const listContainer = document.getElementById('han-viet-temp-list');
            listContainer.innerHTML = Object.entries(hanVietTempRules).map(([han, viet]) => `<div class="flex justify-between items-center text-sm bg-indigo-50 p-1 rounded-md"><span class="font-mono text-text-dark">${han} -> ${viet}</span><button onclick="removeHanVietTempRule('${han}')" class="text-red-500 hover:text-red-700 text-xs ml-2">X√≥a</button></div>`).join('');
            if (Object.keys(hanVietTempRules).length === 0) { listContainer.innerHTML = '<p class="text-gray-400 p-2 text-center">Danh s√°ch tr·ªëng.</p>'; }
        };
        window.removeHanVietTempRule = (han) => {
            delete hanVietTempRules[han];
            renderHanVietTempRules();
        };
        window.addVietVietRule = addVietVietRule;
        window.downloadDictionary = () => {
            const content = Object.entries(localState.hanVietDictionary).map(([han, viet]) => `${han}, ${viet}`).join('\n');
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'han_viet_dictionary.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };
        window.startHanVietTranslation = async (shouldStartAI = false) => {
            const rawContent = document.getElementById('chinese-input').value;
            if (!rawContent.trim()) {
                document.getElementById('vietnamese-output').innerHTML = '<p class="text-red-500 font-semibold">Vui l√≤ng nh·∫≠p ho·∫∑c ch·ªçn n·ªôi dung ch∆∞∆°ng tr∆∞·ªõc.</p>';
                return;
            }
            const combinedDict = { ...localState.hanVietDictionary, ...hanVietTempRules };
            document.getElementById('vietnamese-output').innerHTML = '<p class="text-primary font-semibold">ƒêang √°p d·ª•ng t·ª´ ƒëi·ªÉn H√°n Vi·ªát...</p>';
            const hanVietOutput = applyHanVietRules(rawContent, combinedDict);
            document.getElementById('vietnamese-output').innerHTML = hanVietOutput;
            localState.appState.currentHanVietOutput = hanVietOutput.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim(); 
            document.getElementById('ai-translate-btn').disabled = false;
            if (shouldStartAI) {
                startAITranslation();
            }
        };
        window.applyHanVietRules = (text, dict) => {
            let processedText = text;
            const regex = new RegExp(`(${Object.keys(dict).join('|')})`, 'g');
            processedText = processedText.replace(regex, (match) => `<span class="han-viet-highlight">${dict[match]}</span>`);
            localState.vietVietRules.forEach(rule => {
                const vvRegex = new RegExp(rule.original, 'g');
                processedText = processedText.replace(vvRegex, `<span class="han-viet-highlight bg-yellow-200">${rule.replacement}</span>`);
            });
            return processedText;
        };
        window.startAITranslation = startAITranslation;
        window.callAITranslationAPI = async (text, apiKey) => {
            const response = await fetch(API_URL + apiKey, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: text }] }],
                    systemInstruction: { parts: [{ text: localState.generalSettings.prompt }] },
                })
            });
            const result = await response.json();
            if (!response.ok || !result.candidates) { throw new Error(result.error?.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ API.'); }
            return result.candidates[0]?.content?.parts[0]?.text;
        };
        window.callAIAnalysisAPI_JSON = async (prompt, systemPrompt, responseSchema) => {
            let lastError = "Kh√¥ng th·ªÉ k·∫øt n·ªëi.";
            for (let attempt = 0; attempt < localState.apiKeys.length; attempt++) {
                const key = localState.apiKeys[attempt];
                try {
                    const response = await fetch(API_URL + key, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            generationConfig: { responseMimeType: "application/json", responseSchema: responseSchema }
                        })
                    });
                    const result = await response.json();
                    if (!response.ok || !result.candidates) { lastError = result.error?.message; continue; }
                    return JSON.parse(result.candidates[0].content.parts[0].text.replace(/```json\s*|```/g, '').trim());
                } catch (error) { lastError = error.message; await new Promise(r => setTimeout(r, JSON_API_DELAY_MS)); }
            }
            throw new Error(`To√†n b·ªô Key ƒë·ªÅu th·∫•t b·∫°i. L·ªói cu·ªëi c√πng: ${lastError}`);
        };
        window.translateChapterTitles = async (titles) => {
            const prompt = `D·ªãch danh s√°ch ti√™u ƒë·ªÅ ch∆∞∆°ng sang ti·∫øng Vi·ªát. Gi·ªØ nguy√™n s·ªë ch∆∞∆°ng, ch·ªâ d·ªãch t√™n. Tr·∫£ l·ªùi d∆∞·ªõi d·∫°ng m·∫£ng JSON. V√≠ d·ª•: ["Ch∆∞∆°ng 101: Ti√™u ƒë·ªÅ ƒë√£ d·ªãch"]. Ti√™u ƒë·ªÅ g·ªëc: ${JSON.stringify(titles)}`;
            const schema = { type: "ARRAY", items: { type: "STRING" } };
            const systemPrompt = "B·∫°n l√† chuy√™n gia d·ªãch ti√™u ƒë·ªÅ. Ch·ªâ tr·∫£ l·ªùi b·∫±ng m·∫£ng JSON.";
            try {
                 const translated = await callAIAnalysisAPI_JSON(prompt, systemPrompt, schema);
                 return (Array.isArray(translated) && translated.length === titles.length) ? translated : titles;
            } catch (error) { return titles; }
        };
        window.updateReadingModeContent = (title, content) => {
            const novel = localState.novelManagerData[localState.appState.selectedNovelId];
            if (!novel || localState.appState.selectedChapterIndex === null) return;
            document.getElementById('reading-chapter-title').textContent = title;
            document.getElementById('reading-content').innerHTML = content;
            document.getElementById('prev-chapter-btn-read').disabled = localState.appState.selectedChapterIndex === 0;
            document.getElementById('next-chapter-btn-read').disabled = localState.appState.selectedChapterIndex === novel.chapters.length - 1;
        };
        window.enterReadingMode = enterReadingMode;
        window.exitReadingMode = exitReadingMode;
        window.saveReadingStyle = saveReadingStyle;
        window.downloadChapter = () => {
            const novel = localState.novelManagerData[localState.appState.selectedNovelId];
            if (!novel || localState.appState.selectedChapterIndex === null) return alert("Vui l√≤ng ch·ªçn ch∆∞∆°ng.");
            const chapterKey = `chapter_${localState.appState.selectedChapterIndex}`;
            const translation = novel.translations[chapterKey];
            if (!translation) return alert("Ch∆∞∆°ng n√†y ch∆∞a d·ªãch.");
            const title = novel.chapters[localState.appState.selectedChapterIndex].title_vi || "Ch∆∞∆°ng_d·ªãch";
            const cleanTitle = title.replace(/[:\/\\*?"<>|]/g, '').trim();
            const content = `${title}\n\n${translation.translatedText}`;
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${cleanTitle}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        };
        window.downloadBook = () => {
            const novel = localState.novelManagerData[localState.appState.selectedNovelId];
            if (!novel) return alert("Vui l√≤ng ch·ªçn truy·ªán.");
            const bookTitle = novel.metadata.title;
            const cleanTitle = bookTitle.replace(/[:\/\\*?"<>|]/g, '').trim();
            let fullContent = `T√™n Truy·ªán: ${bookTitle}\nT√°c gi·∫£: ${novel.metadata.author || 'Kh√¥ng r√µ'}\n\n`;
            novel.chapters.forEach((chapter, index) => {
                const translation = novel.translations[`chapter_${index}`];
                fullContent += `\n\n${chapter.title_vi}\n\n${translation ? translation.translatedText : '[CH∆ØA D·ªäCH]'}\n\n`;
            });
            const blob = new Blob([fullContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `${cleanTitle}_FULL.txt`; a.click(); URL.revokeObjectURL(url);
        };
        window.openModal = (id) => { document.getElementById(id).style.display = 'flex'; };
        window.closeModal = (id) => { document.getElementById(id).style.display = 'none'; };
        window.displayError = (message) => {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 8000);
        };
        window.renderChapterList = renderChapterList;
        window.editAllTitles = () => {
            const novel = localState.novelManagerData[localState.appState.selectedNovelId];
            if (!novel) return;
            const container = document.getElementById('chapter-list-container');
            container.innerHTML = novel.chapters.map((chapter, index) => `
                <div class="p-3 border-b"><label class="block text-sm font-medium">STT ${index + 1}:</label>
                <input type="text" id="title-vi-${index}" value="${chapter.title_vi || chapter.title_cn}" class="w-full p-2 border rounded-md">
                <p class="text-xs text-gray-500 italic">G·ªëc: ${chapter.startMarker}</p></div>`).join('');
            const button = document.getElementById('edit-all-titles-btn');
            button.textContent = 'üíæ L∆∞u Ti√™u ƒë·ªÅ';
            button.onclick = saveAllTitles;
        };
        window.saveAllTitles = saveAllTitles;
        window.addVietVietRuleFromModal = addVietVietRuleFromModal;
        window.removeVietVietRule = removeVietVietRule;
        window.renderVietVietRules = renderVietVietRules;
        window.navigateChapter = navigateChapter;
        window.formatTranslatedText = (text) => {
            return '<p>' + text.trim().replace(/\n{2,}/g, '</p><p>').replace(/\n/g, '<br>') + '</p>';
        };
        window.handleDictionaryUpload = handleDictionaryUpload;
        window.saveFirebaseConfig = saveFirebaseConfig;

        // --- INITIALIZATION ---
        window.onload = initializeAppAndAuth;

    </script>
</body>
</html>
